############################################
# STI — Rendimiento, SEO y Seguridad
############################################

# --- Reescrituras básicas ---
<IfModule mod_rewrite.c>
  RewriteEngine On

  # 1) Forzar HTTPS y sin www
  RewriteCond %{HTTPS} !=on [OR]
  RewriteCond %{HTTP_HOST} ^www\.stia\.com\.ar$ [NC]
  RewriteRule ^(.*)$ https://stia.com.ar/$1 [R=301,L]

  # 2) Canonical: /index.php -> /
  RewriteCond %{THE_REQUEST} \s/+index\.php[\s?] [NC]
  RewriteRule ^index\.php$ https://stia.com.ar/ [R=301,L]

  # 3) Eliminar barra final excepto carpetas reales y raíz
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} .+/$
  RewriteRule ^(.+)/$ /$1 [R=301,L]
</IfModule>

# --- Compresión (Brotli > Gzip) ---
# Requiere mod_brotli / mod_deflate habilitados en el server
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css application/javascript application/json application/xml image/svg+xml
</IfModule>
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json application/xml image/svg+xml
</IfModule>

# --- Cache de recursos estáticos ---
<IfModule mod_expires.c>
  ExpiresActive On
  # CSS & JS
  ExpiresByType text/css "access plus 30 days"
  ExpiresByType application/javascript "access plus 30 days"
  # Imágenes
  ExpiresByType image/avif "access plus 60 days"
  ExpiresByType image/webp "access plus 60 days"
  ExpiresByType image/jpeg "access plus 60 days"
  ExpiresByType image/png  "access plus 60 days"
  ExpiresByType image/gif  "access plus 60 days"
  ExpiresByType image/svg+xml "access plus 60 days"
  # Fuentes
  ExpiresByType font/woff2 "access plus 120 days"
  ExpiresByType font/woff  "access plus 120 days"
</IfModule>

# Cache-Control explícito (respeta versionado ?v=1)
<IfModule mod_headers.c>
  <FilesMatch "\.(css|js)$">
    Header set Cache-Control "public, max-age=2592000, must-revalidate"
  </FilesMatch>
  <FilesMatch "\.(avif|webp|jpe?g|png|gif|svg|ico)$">
    Header set Cache-Control "public, max-age=5184000, immutable"
  </FilesMatch>
  <FilesMatch "\.(woff2?|ttf|otf)$">
    Header set Cache-Control "public, max-age=10368000, immutable"
  </FilesMatch>
</IfModule>

# --- CORS para fuentes (evita bloqueos cuando se cargan desde CSS) ---
<IfModule mod_headers.c>
  <FilesMatch "\.(woff2?|ttf|otf)$">
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>
</IfModule>

# --- Seguridad básica y SEO técnico ---
<IfModule mod_headers.c>
  # HSTS (solo si ya sirves todo por HTTPS estable)
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  Header set X-Content-Type-Options "nosniff"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ETags a off para evitar revalidaciones extra entre servers
FileETag None

# --- Tipos MIME correctos (fuentes e imágenes modernas) ---
AddType image/avif   avif
AddType image/webp   webp
AddType font/woff2   woff2
AddType font/woff    woff

# --- (Opcional) Servir precomprimidos si existen .br / .gz ---
# Sube archivos .br/.gz junto al original (ej: style.css.br)
<IfModule mod_mime.c>
  AddEncoding br .br
  AddEncoding gzip .gz
  AddType text/css              .css.br .css.gz
  AddType application/javascript .js.br  .js.gz
</IfModule>
<IfModule mod_rewrite.c>
  RewriteEngine On
  # Priorizar .br
  RewriteCond %{HTTP:Accept-encoding} br
  RewriteCond %{REQUEST_FILENAME}\.br -f
  RewriteRule ^(.+)\.(css|js)$ $1.$2.br [L]
  # Fallback .gz
  RewriteCond %{HTTP:Accept-encoding} gzip
  RewriteCond %{REQUEST_FILENAME}\.gz -f
  RewriteRule ^(.+)\.(css|js)$ $1.$2.gz [L]
</IfModule>

# --- Sitemap "hint" (por si crawlers no leen robots) ---
Header set Link "</sitemap.xml>; rel=\"sitemap\"" env=REDIRECT_STATUS

############################################
# STI — Auto-servicio de imágenes WebP / AVIF
############################################

<IfModule mod_rewrite.c>
  RewriteEngine On

  # --- WebP preferido si el navegador lo soporta ---
  RewriteCond %{HTTP_ACCEPT} image/webp
  RewriteCond %{REQUEST_FILENAME} (.+)\.(jpe?g|png)$
  RewriteCond %1.webp -f
  RewriteRule ^ %1.webp [T=image/webp,E=accept:1,L]

  # --- AVIF aún más eficiente (prioridad máxima) ---
  RewriteCond %{HTTP_ACCEPT} image/avif
  RewriteCond %{REQUEST_FILENAME} (.+)\.(jpe?g|png|webp)$
  RewriteCond %1.avif -f
  RewriteRule ^ %1.avif [T=image/avif,E=accept:1,L]
</IfModule>

# Asegura cabecera correcta
<IfModule mod_headers.c>
  Header append Vary Accept env=accept
</IfModule>
