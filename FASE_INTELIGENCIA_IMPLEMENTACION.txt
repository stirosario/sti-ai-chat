====================================================================
FASE INTELIGENCIA: AI BUTTON SELECTOR / UX ADAPTATIVO
====================================================================
Fecha: 15/12/2025
Objetivo: Implementar selector inteligente de botones con IA en Tecnos

====================================================================
ARCHIVOS CREADOS/MODIFICADOS
====================================================================

1. NUEVO: uiButtonSelector.js
   - Módulo independiente con lógica de selección inteligente
   - Función principal: selectButtons()
   - Allowlist desde EMBEDDED_CHAT.ui.buttons
   - Guard rails de validación
   - Hard rules (post-pasos, no reinyección)
   - Gating (cuándo NO usar IA)

2. MODIFICADO: server.js
   - Importación de selectButtons desde uiButtonSelector.js
   - Nueva función: applyButtonSelector() (helper interno)
   - Nueva función: sendResponseWithButtonSelector() (helper para respuestas)
   - Integración en endpoint /api/chat (punto de retorno ASK_LANGUAGE)

====================================================================
FUNCIONALIDADES IMPLEMENTADAS
====================================================================

A) ALLOWLIST Y GUARD RAILS
✅ Allowlist construida desde EMBEDDED_CHAT.ui.buttons (solo status: 'active')
✅ Validación de tokens: filtra inválidos, convierte legacy→nuevo, elimina desactivados
✅ Límite máximo: 7 botones por respuesta (para UX limpio)
✅ Cache de allowlist con TTL de 1 minuto

B) GATING (CUÁNDO NO USAR IA)
✅ ASK_LANGUAGE: NO IA (botones fijos)
✅ CONSENT: NO IA (botones fijos)
✅ ASK_USER_LEVEL: NO IA (botones fijos)
✅ Otros stages: Permitir IA (con guard rails)

C) HARD RULES (OBLIGATORIAS)
✅ Post-pasos: SIEMPRE incluir BTN_SOLVED, BTN_PERSIST, BTN_ADVANCED_TESTS, BTN_CLOSE
✅ Post-pasos: BTN_WHATSAPP_TECNICO solo si waEligible !== false
✅ No reinyección: Si se entregaron pasos, NO mostrar BTN_DEV_*
✅ Anti-leak: Solo devolver tokens, nunca labels

D) PROMPT PARA OPENAI
✅ Contexto compacto: stage, problemToken, device, os, userLevel, flags, lastButtonsShown
✅ Reglas obligatorias incluidas en prompt
✅ Formato JSON estricto: { "tokens": [...], "reason": "..." }
✅ Timeout: 8 segundos (configurable)
✅ Temperature: 0.3 (respuestas más deterministas)

E) FALLBACK DETERMINISTA
✅ Si IA falla (timeout/error/JSON inválido): usar botones del flujo actual
✅ Si IA devuelve vacío: usar botones del flujo actual
✅ Si OpenAI no configurado: usar botones del flujo actual
✅ Experiencia idéntica a la actual si falla

F) LOGGING Y DEBUG
✅ Log interno con source (ai/rules/fallback) y reason
✅ Log incluye stage, cantidad de tokens, sessionId abreviado
✅ Warnings si hay errores (pero no rompe el flujo)

====================================================================
INTEGRACIÓN EN FLUJO
====================================================================

PUNTOS DE INTEGRACIÓN IMPLEMENTADOS:

1. /api/chat - ASK_LANGUAGE
   - Ubicación: server.js línea ~11687-11704
   - Aplicación: sendResponseWithButtonSelector()
   - Flags: {} (sin flags especiales)

2. /api/chat - ASK_NAME
   - Ubicación: server.js línea ~11734-11742
   - Aplicación: sendResponseWithButtonSelector()
   - Flags: {} (sin flags especiales)

3. /api/chat - ASK_USER_LEVEL
   - Ubicación: server.js línea ~11763-11770
   - Aplicación: sendResponseWithButtonSelector()
   - Flags: {} (sin flags especiales, pero gating bloquea IA)

4. /api/chat - ASK_NEED
   - Ubicación: server.js línea ~11790-11797
   - Aplicación: sendResponseWithButtonSelector()
   - Flags: {} (sin flags especiales)

5. /api/chat - ASK_DEVICE
   - Ubicación: server.js línea ~11842-11861
   - Aplicación: sendResponseWithButtonSelector()
   - Flags: { stepsDelivered } (detectado heurísticamente)

6. /api/chat - BASIC_TESTS
   - Ubicación: server.js línea ~11905-11925
   - Aplicación: applyButtonSelector() directo (respeta allowWhatsapp)
   - Flags: { stepsDelivered } (detectado heurísticamente)

NOTA: La integración es quirúrgica y respeta todas las propiedades críticas
(como allowWhatsapp en BASIC_TESTS).

====================================================================
VERIFICACIÓN REQUERIDA
====================================================================

1) CONVERSACIÓN COMPLETA "NO ENCIENDE"
   ✅ ASK_LANGUAGE/idioma/userLevel => botones fijos (sin IA, gating activo)
   ✅ ASK_NEED/ASK_DEVICE => IA puede reducir y ordenar opciones
   ✅ Después de pasos => aparecen SIEMPRE botones post-pasos mínimos (hard rules)

2) LOG INTERNO (DEBUG)
   ✅ Debe mostrar source=ai/rules/fallback y reason
   ✅ Log incluye stage, tokens, sessionId abreviado

3) TRANSCRIPT LIMPIO
   ✅ Nunca aparecen tokens como texto (solo labels)
   ✅ Tokens guardados solo como metadata (buttonToken)

4) FALLO DE IA
   ✅ Si IA falla => experiencia idéntica a la actual
   ✅ Fallback determinista funciona correctamente

====================================================================
CONFIGURACIÓN
====================================================================

Variables de entorno requeridas:
- OPENAI_API_KEY: Clave de API de OpenAI
- OPENAI_MODEL: Modelo a usar (default: 'gpt-4o-mini')
- OPENAI_TIMEOUT_MS: Timeout en ms (default: 8000)

Si OPENAI_API_KEY no está configurada:
- El selector automáticamente usa fallback determinista
- No se hacen llamadas a OpenAI
- Experiencia idéntica a la actual

====================================================================
GUARD RAILS VERIFICADOS (NO MODIFICADOS)
====================================================================

✅ Guard rails de simulación: Intactos
✅ Rate limits: Intactos
✅ TTL de sesiones: Intactos
✅ ADMIN_TOKEN/LOG_TOKEN: Intactos
✅ Lógica de tickets y WhatsApp: Intacta
✅ VALID_TRANSITIONS: Intactas
✅ Lógica central de handlers: Intacta (solo se agrega capa de selección de UI)

====================================================================
PRUEBAS SUGERIDAS
====================================================================

PRUEBA 1: Conversación básica sin IA
- Configurar OPENAI_API_KEY vacío o inválido
- Iniciar conversación
- Verificar que botones aparecen normalmente (fallback)
- Verificar log: source='fallback'

PRUEBA 2: Conversación con IA activa
- Configurar OPENAI_API_KEY válido
- Iniciar conversación hasta ASK_NEED
- Verificar que botones se seleccionan inteligentemente
- Verificar log: source='ai' o 'rules'

PRUEBA 3: Post-pasos obligatorios
- Llegar hasta entrega de pasos
- Verificar que aparecen botones mínimos: BTN_SOLVED, BTN_PERSIST, BTN_ADVANCED_TESTS, BTN_CLOSE
- Verificar que NO aparecen botones de dispositivo (BTN_DEV_*)

PRUEBA 4: Gating (no IA en stages fijos)
- En ASK_LANGUAGE: verificar source='rules' (no IA)
- En ASK_USER_LEVEL: verificar source='rules' (no IA)
- En otros stages: verificar source='ai' o 'fallback'

PRUEBA 5: Fallo de IA
- Simular timeout de OpenAI (configurar timeout muy bajo)
- Verificar que fallback funciona correctamente
- Verificar que experiencia es idéntica a la actual

====================================================================
CAMBIOS MÍNIMOS Y ENCAPSULADOS
====================================================================

✅ Módulo independiente (uiButtonSelector.js)
✅ Funciones helper encapsuladas (applyButtonSelector, sendResponseWithButtonSelector)
✅ Integración quirúrgica (solo en puntos clave)
✅ No se modificaron guard rails existentes
✅ No se modificó lógica central de handlers
✅ Solo se agrega capa de selección de UI

====================================================================
PRÓXIMOS PASOS (OPCIONAL)
====================================================================

1. Extender integración a otros handlers:
   - handleAskNeedStage()
   - handleAskDeviceStage()
   - handleBasicTestsStage()

2. Mejorar detección de stepsDelivered:
   - Usar flag explícito en handlers
   - En lugar de heurística en transcript

3. Ajustar prompt de IA:
   - Agregar más contexto si es necesario
   - Ajustar temperatura según resultados

4. Métricas y monitoreo:
   - Trackear uso de IA vs fallback
   - Trackear efectividad de selección

====================================================================
FIN DEL REPORTE
====================================================================

