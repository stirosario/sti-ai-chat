================================================================================
REPETICIONES UX Y LEAKS - ECOSISTEMA CHAT TECNOS
Fecha: 2025-01-XX
================================================================================

ANÃLISIS DE REPETICIONES DE FRASES/PATRONES
================================================================================

FRASES DE CIERRE
-------------------------------------------------------------------------------

Frase 1: "Gracias por usar Tecnos"
UbicaciÃ³n: server.js mÃºltiples lugares
Frecuencia estimada: 2-3 veces por conversaciÃ³n (si usuario cierra y reabre)
Variantes:
- "Â¡Gracias por usar Tecnos! Si necesitÃ¡s ayuda de nuevo, acÃ¡ voy a estar. ğŸ¤–"
- "Thanks for using Tecnos! If you need help again, I'll be here. ğŸ¤–"
- "Â¡Gracias! Me alegra haber sido Ãºtil ğŸ™Œ"
- "Thanks! I'm glad I could help ğŸ™Œ"

Riesgo de repeticiÃ³n: MEDIO
- Si usuario cierra y reabre chat, verÃ¡ la misma frase
- Si usuario resuelve problema y vuelve a tener problema, verÃ¡ frase similar
- No hay tracking de frases ya mostradas al usuario

RecomendaciÃ³n:
- Agregar tracking de frases mostradas en session.progress.phrasesShown
- Variar mensajes cuando sea posible (templates con 2-3 variantes)
- Definir umbral: no repetir misma frase en <5 turnos

Frase 2: "Me alegra un montÃ³n que lo hayas solucionado"
UbicaciÃ³n: server.js lÃ­nea ~7659+
Frecuencia estimada: 1 vez por conversaciÃ³n (si usuario resuelve)
Variantes:
- "Me alegra un montÃ³n que lo hayas solucionado. Tu equipo deberÃ­a andar joya ahora. ğŸ’»âœ¨"
- "I'm glad you solved it. Your equipment should work perfectly now. ğŸ’»âœ¨"
- "Â¡QuÃ© buena noticia, {nombre}! ğŸ™Œ"

Riesgo de repeticiÃ³n: BAJO
- Solo aparece cuando usuario resuelve problema
- Pero si usuario resuelve mÃºltiples problemas, verÃ¡ frase similar

RecomendaciÃ³n:
- Variar mensaje segÃºn nombre del usuario
- Agregar variantes (2-3 diferentes)
- Personalizar segÃºn nivel de usuario (bÃ¡sico/intermedio/avanzado)

Frase 3: "Antes de cerrar, contame:"
UbicaciÃ³n: server.js lÃ­nea ~7661+
Frecuencia estimada: 1 vez por conversaciÃ³n (si usuario resuelve)
Variantes:
- "Antes de cerrar, contame:"
- "Before closing, tell me:"
- "Antes de cerrar, elegÃ­ una opciÃ³n de feedback acÃ¡ arriba ğŸ‘‡" (CASO 6B)

Riesgo de repeticiÃ³n: BAJO
- Solo aparece cuando se muestra feedback
- CASO 6B re-muestra con variante diferente

RecomendaciÃ³n:
- Variante de CASO 6B es buena (diferente mensaje)
- Considerar mÃ¡s variantes si se repite

FRASES DE ESCALACIÃ“N
-------------------------------------------------------------------------------

Frase 4: "Avisame y te conecto con un tÃ©cnico"
UbicaciÃ³n: server.js lÃ­nea ~7796+ (handleBasicTestsStage)
Frecuencia estimada: 1 vez por conversaciÃ³n (si problema persiste)
Variantes:
- "Avisame y te conecto con un tÃ©cnico real"
- "Let me know and I'll connect you with a real technician"

Riesgo de repeticiÃ³n: MEDIO
- Si usuario vuelve a tener problema similar, verÃ¡ frase similar
- No hay tracking de ofrecimientos de tÃ©cnico

RecomendaciÃ³n:
- Agregar tracking de ofrecimientos de tÃ©cnico
- Variar mensaje segÃºn contexto (primer ofrecimiento vs segundo)

FRASES DE BIENVENIDA
-------------------------------------------------------------------------------

Frase 5: "Perfecto, {nombre} ğŸ˜Š Â¿En quÃ© puedo ayudarte hoy?"
UbicaciÃ³n: server.js lÃ­nea ~3942+, ~4057+
Frecuencia estimada: 1 vez por conversaciÃ³n (despuÃ©s de ASK_USER_LEVEL)
Variantes:
- "Perfecto, {nombre} ğŸ˜Š Â¿En quÃ© puedo ayudarte hoy? O si preferÃ­s podÃ©s seleccionar ğŸ”˜ uno de los siguientes problemas ğŸš©:"
- "Perfect, {nombre} ğŸ˜Š What can I help you with today? Or if you prefer, you can select ğŸ”˜ one of the following common problems ğŸš©:"

Riesgo de repeticiÃ³n: BAJO
- Solo aparece una vez al inicio del flujo
- Personalizado con nombre del usuario

RecomendaciÃ³n:
- PersonalizaciÃ³n con nombre es buena
- Considerar variantes si usuario reinicia conversaciÃ³n

FRASES DE EXPLICACIÃ“N
-------------------------------------------------------------------------------

Frase 6: "Para ayudarte mejor y ser mÃ¡s eficiente âš¡"
UbicaciÃ³n: server.js lÃ­nea ~3973+
Frecuencia estimada: 1 vez por conversaciÃ³n (ASK_USER_LEVEL)
Variantes:
- "Para ayudarte mejor y ser mÃ¡s eficiente âš¡\ndecime quÃ© nivel de experiencia tenÃ©s con tecnologÃ­a ğŸ‘‡"
- "To help you better and be more efficient âš¡\ntell me your tech experience level ğŸ‘‡"

Riesgo de repeticiÃ³n: BAJO
- Solo aparece una vez (ASK_USER_LEVEL)
- Se salta si userLevel ya existe

RecomendaciÃ³n:
- LÃ³gica de skip es buena
- No requiere cambios

PATRONES DE REPETICIÃ“N DETECTADOS
-------------------------------------------------------------------------------

PatrÃ³n 1: Mensajes de celebraciÃ³n similares
- MÃºltiples lugares usan frases similares de celebraciÃ³n
- Ej: "Â¡QuÃ© buena noticia!", "Excellent!", "Me alegra"
- Riesgo: MEDIO - Usuario puede notar similitud si resuelve mÃºltiples problemas

PatrÃ³n 2: Mensajes de cierre similares
- MÃºltiples lugares usan "Gracias por usar Tecnos"
- Riesgo: MEDIO - Si usuario cierra y reabre, verÃ¡ misma frase

PatrÃ³n 3: Mensajes de escalaciÃ³n similares
- MÃºltiples lugares ofrecen conectar con tÃ©cnico
- Riesgo: BAJO - Solo aparece cuando problema persiste

Umbrales propuestos:
- No repetir misma frase en <5 turnos
- Variar mensajes cuando sea posible (2-3 variantes)
- Tracking de frases mostradas en session.progress.phrasesShown

TOKENS INTERNOS MOSTRADOS AL USUARIO (ANÃLISIS)
================================================================================

CASOS DONDE TOKENS PODRÃAN APARECER
-------------------------------------------------------------------------------

Caso 1: Usuario escribe token manualmente
Archivo: index.php, server.js
Riesgo: MEDIO
Escenario:
1. Usuario escribe "BTN_SOLVED" en lugar de presionar botÃ³n
2. Backend procesa token correctamente
3. Frontend podrÃ­a mostrar token en transcript si no se normaliza

Evidencia:
- normalizeButtons() mapea tokens a labels cuando vienen del backend
- Pero si usuario escribe token, podrÃ­a no mapearse en transcript
- sendButton() envÃ­a label al backend, pero transcript podrÃ­a mostrar value

CÃ³mo detectarlo:
- Escribir "BTN_SOLVED" manualmente
- Verificar transcript en admin.php
- Verificar que se muestre label, no token

RecomendaciÃ³n:
- Normalizar texto del usuario antes de agregar a transcript
- Mapear tokens escritos manualmente a labels
- Asegurar que frontend siempre muestre label, nunca value crudo

Caso 2: Token no mapeado en LABEL_MAP
Archivo: index.php lÃ­nea ~1722+
Riesgo: MEDIO
Escenario:
1. Backend envÃ­a botÃ³n con token nuevo (ej: BTN_NUEVO_TOKEN)
2. LABEL_MAP no incluye token
3. normalizeButtons() usa token como label
4. Usuario ve "BTN_NUEVO_TOKEN" en lugar de texto descriptivo

Evidencia:
- LABEL_MAP incluye tokens principales pero podrÃ­a no cubrir todos
- normalizeButtons() lÃ­nea ~1745: `const label = (LABEL_MAP[mapped] || mapped);`
- Si token no estÃ¡ en LABEL_MAP, se usa el token como label

CÃ³mo detectarlo:
- Comparar tokens usados en backend con LABEL_MAP en frontend
- Probar con token nuevo no mapeado
- Verificar que se muestre label, no token

RecomendaciÃ³n:
- Sincronizar LABEL_MAP con tokens del backend
- Agregar fallback mÃ¡s robusto (ej: generar label desde token)
- Documentar proceso para agregar nuevos tokens

Caso 3: Transcript muestra value en lugar de label
Archivo: server.js, index.php
Riesgo: BAJO
Escenario:
1. Usuario presiona botÃ³n
2. Backend recibe buttonToken
3. Transcript podrÃ­a mostrar value en lugar de label
4. Usuario ve token en historial

Evidencia:
- addBotMessageToTranscript() guarda mensajes del bot
- Transcript del usuario podrÃ­a mostrar value si no se normaliza
- Admin.php muestra transcript, podrÃ­a mostrar tokens

CÃ³mo detectarlo:
- Completar conversaciÃ³n con botones
- Verificar transcript en admin.php
- Verificar que se muestren labels, no tokens

RecomendaciÃ³n:
- Normalizar buttonToken a label antes de agregar a transcript
- Asegurar que transcript siempre muestre texto descriptivo

EJEMPLOS EXACTOS DE POSIBLES LEAKS
================================================================================

Ejemplo 1: Usuario escribe "BTN_SOLVED"
-------------------------------------------------------------------------------
Input del usuario: "BTN_SOLVED"
Backend procesa: buttonToken = 'BTN_SOLVED' (lÃ­nea ~10794)
Frontend muestra: Â¿Muestra "BTN_SOLVED" o "Ya lo solucionÃ©"?
Riesgo: Si frontend no normaliza, usuario ve token
RecomendaciÃ³n: Normalizar antes de mostrar

Ejemplo 2: Token nuevo no mapeado
-------------------------------------------------------------------------------
Backend envÃ­a: { text: 'Nuevo botÃ³n', value: 'BTN_NUEVO_TOKEN' }
LABEL_MAP: No incluye 'BTN_NUEVO_TOKEN'
normalizeButtons() retorna: { label: 'BTN_NUEVO_TOKEN', value: 'BTN_NUEVO_TOKEN' }
Frontend muestra: "BTN_NUEVO_TOKEN"
Riesgo: Usuario ve token en lugar de texto descriptivo
RecomendaciÃ³n: Agregar a LABEL_MAP o fallback robusto

Ejemplo 3: Transcript en admin.php
-------------------------------------------------------------------------------
Transcript guardado: { who: 'user', text: 'BTN_SOLVED' }
Admin.php muestra: "BTN_SOLVED"
Riesgo: Admin ve token en lugar de texto descriptivo
RecomendaciÃ³n: Normalizar antes de guardar en transcript

ANÃLISIS DE LABEL_MAP (FRONTEND)
================================================================================

Archivo: index.php lÃ­nea ~1722+

Tokens mapeados actualmente:
- BTN_ADVANCED_TESTS: 'ğŸ”¬ Pruebas Avanzadas'
- BTN_MORE_TESTS: 'ğŸ”¬ Pruebas Avanzadas'
- BTN_CONNECT_TECH: 'ğŸ‘¨â€ğŸ­ Conectar con TÃ©cnico'
- BTN_CLOSE: 'ğŸ”š Cerrar Chat'
- BTN_SOLVED: 'Lo pude solucionar âœ”ï¸'
- BTN_PERSIST: 'El problema persiste âŒ'
- BTN_NO_ENCIENDE: 'ğŸ”Œ El equipo no enciende'
- BTN_NO_INTERNET: 'ğŸ“¡ Problemas de conexiÃ³n a Internet'
- BTN_LENTITUD: 'ğŸ¢ Lentitud del sistema operativo o del equipo'
- BTN_BLOQUEO: 'â„ï¸ Bloqueo o cuelgue de programas'
- BTN_PERIFERICOS: 'ğŸ–¨ï¸ Problemas con perifÃ©ricos externos'
- BTN_VIRUS: 'ğŸ›¡ï¸ Infecciones de malware o virus'

Tokens NO mapeados (potenciales leaks):
- BTN_USER_LEVEL_BASIC: No estÃ¡ en LABEL_MAP
- BTN_USER_LEVEL_INTERMEDIATE: No estÃ¡ en LABEL_MAP
- BTN_USER_LEVEL_ADVANCED: No estÃ¡ en LABEL_MAP
- BTN_FEEDBACK_USEFUL: No estÃ¡ en LABEL_MAP
- BTN_FEEDBACK_NOT_USEFUL: No estÃ¡ en LABEL_MAP
- BTN_HELP_STEP_*: No estÃ¡n en LABEL_MAP (pero se manejan especial)
- BTN_OS_*: No estÃ¡n en LABEL_MAP
- BTN_DEV_*: No estÃ¡n en LABEL_MAP

Riesgo: MEDIO
- Si backend envÃ­a estos tokens, frontend podrÃ­a mostrar tokens crudos
- normalizeButtons() tiene fallback pero usa token como label

RecomendaciÃ³n:
- Agregar todos los tokens posibles a LABEL_MAP
- Sincronizar con tokens del backend (server.js lÃ­nea ~2956+)
- Agregar fallback mÃ¡s robusto (generar label desde token)

ANÃLISIS DE NORMALIZACIÃ“N DE TEXTO LIBRE
================================================================================

Archivo: server.js mÃºltiples lugares

Mapeo de texto libre a tokens:
- "bÃ¡sico" / "basic" â†’ BTN_USER_LEVEL_BASIC (lÃ­nea ~4035)
- "intermedio" / "intermediate" â†’ BTN_USER_LEVEL_INTERMEDIATE (lÃ­nea ~4037)
- "avanzado" / "advanced" â†’ BTN_USER_LEVEL_ADVANCED (lÃ­nea ~4039)
- "sÃ­" / "si" / "lo pude solucionar" â†’ BTN_SOLVED (lÃ­nea ~7605)
- "no" / "el problema persiste" â†’ BTN_PERSIST (lÃ­nea ~7796)

Riesgo: BAJO
- Mapeo funciona correctamente
- Regex case-insensitive
- Soporta variantes comunes

RecomendaciÃ³n:
- Considerar mÃ¡s variantes si se detectan casos no cubiertos
- Documentar mapeos para referencia

ANÃLISIS DE TRANSCRIPT Y LOGS
================================================================================

Archivo: server.js lÃ­nea ~2147+ (addBotMessageToTranscript)

Transcript guarda:
- who: 'user' | 'bot'
- text: Texto del mensaje
- ts: Timestamp
- stage: Stage actual
- buttons: Array de botones (si aplica)

Riesgo de leaks:
- Si text contiene token crudo, se guarda en transcript
- Admin.php muestra transcript, podrÃ­a mostrar tokens
- Logs podrÃ­an contener tokens si se loguean

RecomendaciÃ³n:
- Normalizar text antes de guardar en transcript
- Asegurar que buttons siempre tengan text, no solo value
- Normalizar en admin.php antes de mostrar

RESUMEN DE RIESGOS
================================================================================

RIESGO ALTO:
- Ninguno detectado en modo solo lectura

RIESGO MEDIO:
1. Tokens no mapeados en LABEL_MAP podrÃ­an mostrarse crudos
2. Usuario escribe token manualmente, podrÃ­a no normalizarse
3. RepeticiÃ³n de frases de cierre puede causar fatiga UX

RIESGO BAJO:
1. Transcript podrÃ­a mostrar value en lugar de label
2. Logs podrÃ­an contener tokens (no visible al usuario final)

RECOMENDACIONES FINALES
================================================================================

1. Sincronizar LABEL_MAP con todos los tokens del backend
   - Agregar BTN_USER_LEVEL_*, BTN_FEEDBACK_*, BTN_OS_*, BTN_DEV_*
   - Documentar proceso para agregar nuevos tokens

2. Normalizar texto del usuario antes de agregar a transcript
   - Mapear tokens escritos manualmente a labels
   - Asegurar que transcript siempre muestre texto descriptivo

3. Agregar tracking de frases mostradas
   - session.progress.phrasesShown = []
   - No repetir misma frase en <5 turnos
   - Variar mensajes cuando sea posible

4. Agregar fallback robusto en normalizeButtons()
   - Si token no estÃ¡ en LABEL_MAP, generar label desde token
   - Ej: "BTN_USER_LEVEL_BASIC" â†’ "BÃ¡sico" (extraer parte descriptiva)

5. Normalizar en admin.php antes de mostrar transcript
   - Asegurar que admin siempre vea labels, no tokens
   - Aplicar mismo LABEL_MAP que frontend

================================================================================
FIN DEL ANÃLISIS
================================================================================

