================================================================================
ROADMAP DE CORRECCIONES EN 3 FASES - server.js (STI / Tecnos)
Fecha: 2025-01-XX
Versi√≥n objetivo: 2.1.0 (post-correcciones)
Basado en: AUDITORIA_SERVER_JS.txt

‚ö†Ô∏è NOTA IMPORTANTE: ESTE DOCUMENTO FUE REEMPLAZADO
================================================================================

Este documento (ROADMAP_CORRECCIONES_3_FASES.txt) fue la base original del
roadmap y ha sido EXPANDIDO y REEMPLAZADO por:

üìÑ ROADMAP_V2_FASES_1_A_5.txt

El nuevo documento incluye:
- FASE 1, 2, 3 (cerradas) - basadas en este documento original
- FASE 4 (cerrada) - inteligencia conversacional y control de diagn√≥stico
- FASE 5 (planificada) - optimizaciones avanzadas y monitoreo

Este documento se mantiene como referencia hist√≥rica pero NO debe usarse
como roadmap activo. Usar siempre ROADMAP_V2_FASES_1_A_5.txt para trabajo futuro.

Fecha de reemplazo: 2025-12-14
================================================================================

0) RESUMEN EJECUTIVO
================================================================================

Estado general: RIESGO MEDIO-ALTO
- El sistema funciona correctamente pero tiene vulnerabilidades de seguridad y riesgos de escalabilidad.
- Guard rails de simulaci√≥n est√°n implementados correctamente.
- Flujo conversacional es robusto pero falta validaci√≥n de transiciones.
- Persistencia funciona pero sin TTL puede causar problemas a largo plazo.

Top 5 riesgos reales (por gravedad):
1. [ALTO] Race condition en saveSession(): M√∫ltiples requests concurrentes pueden sobrescribir sesiones, perdiendo datos del usuario.
2. [ALTO] /api/simulations/run sin autenticaci√≥n: Permite DoS masivo y consumo de recursos ilimitado.
3. [MEDIO-ALTO] CORS permite requests sin origin: En producci√≥n puede permitir acceso no autorizado si no hay rate limiting adicional.
4. [MEDIO] ADMIN_TOKEN opcional: Endpoints sensibles (/api/historial, /api/transcript-json) son p√∫blicos si no est√° configurado.
5. [MEDIO] No hay rate limit espec√≠fico para /api/chat: Endpoint cr√≠tico puede ser saturado f√°cilmente.

Qu√© NO tocar todav√≠a (evitar romper producci√≥n):
- NO refactorizar handlers grandes (handleBasicTestsStage, handleAskDeviceStage) en estas fases.
- NO migrar a microservicios o dividir server.js en m√≥dulos.
- NO cambiar formato de sesiones/transcripts existentes.
- NO modificar l√≥gica de guard rails de simulaci√≥n (est√°n correctos).
- NO alterar formato obligatorio de pasos (formatStepWithMandatoryFormat funciona bien).

================================================================================
1) INVENTARIO DE COMPONENTES RELEVANTES
================================================================================

Endpoints sensibles:
- POST /api/chat: Endpoint principal, procesa mensajes, genera respuestas OpenAI, sin rate limit espec√≠fico.
- POST /api/simulations/run: Ejecuta simulaciones, sin autenticaci√≥n, sin rate limit, puede causar DoS.
- GET /api/historial/:sessionId: Lee conversaciones, ADMIN_TOKEN opcional.
- GET /api/transcript-json/:sessionId: Lee transcripts, ADMIN_TOKEN opcional.
- POST /api/upload-image: Sube im√°genes, tiene rate limit pero no por IP para m√∫ltiples sesiones.

Puntos de persistencia / side-effects:
- saveSession(): Guarda sesiones en TRANSCRIPTS_DIR, sin locks (race condition).
- createTicketAndRespond(): Crea tickets en TICKETS_DIR, tiene locks (correcto).
- pushBasicTestTelemetry(): Actualiza PROBLEM_METRICS y STEP_INEFFECTIVE en memoria (solo si no es simulaci√≥n).
- OpenAI API: Genera respuestas, sin timeout (puede colgarse).
- Logs: server.log y telemetry.log sin rotaci√≥n (crecen indefinidamente).

Motor de mandamientos / guard rails:
- Guard rails de simulaci√≥n: saveSession (l√≠nea 972), createTicketAndRespond (l√≠nea 6950), pushBasicTestTelemetry (l√≠nea 859).
- Guard rails de flujo: Anti-reimpresi√≥n de pasos (l√≠neas 4720-4747, 5776-5850), anti-escalamiento prematuro (l√≠neas 3100-3244).
- VALID_TRANSITIONS: Definido (l√≠neas 1293-1320) pero NO se valida en handlers.

Sistema de Simulaciones:
- admin.php: UI para ejecutar simulaciones (en otro workspace, no auditado en detalle).
- simulation-engine.js: Motor de simulaciones, llama a /api/chat real.
- Guard rails en server.js: Bloquean Redis/tickets/WhatsApp/m√©tricas cuando session.simulation === true.
- Endpoints: /api/simulations/run, /api/simulations/logs, /api/simulations/log/:id (sin autenticaci√≥n).

================================================================================
2) FASES DEL ROADMAP
================================================================================

FASE 1: SEGURIDAD CR√çTICA Y GUARD RAILS (P0 - Bloqueantes)
================================================================================

Objetivo: Eliminar vulnerabilidades de seguridad cr√≠ticas y asegurar que los guard rails funcionen correctamente.

Alcance: 
- Incluye: Autenticaci√≥n de endpoints sensibles, rate limiting espec√≠fico, validaci√≥n de transiciones, race conditions.
- Excluye: Refactor de handlers, cambios de formato, mejoras est√©ticas.

Tareas FASE 1:

F1-T01: Agregar autenticaci√≥n obligatoria a /api/simulations/run
  Qu√© corrige: Endpoint /api/simulations/run (l√≠nea 9470)
  Riesgo: Alto (DoS masivo posible)
  Impacto: Alto (protege recursos del servidor)
  Complejidad: Baja (agregar validaci√≥n de ADMIN_TOKEN)
  Dependencias: Ninguna
  Criterio DONE: 
    - Endpoint retorna 403 si no hay ADMIN_TOKEN o token inv√°lido.
    - Logs muestran "[SECURITY] Request a /api/simulations/run sin autenticaci√≥n bloqueado".
    - Simulaci√≥n exitosa con token v√°lido.
  Prioridad: P0

F1-T02: Agregar rate limit espec√≠fico para /api/chat
  Qu√© corrige: Endpoint POST /api/chat (l√≠nea 8898)
  Riesgo: Medio (saturaci√≥n del servidor)
  Impacto: Alto (protege endpoint cr√≠tico)
  Complejidad: Media (crear nuevo rate limiter, aplicarlo espec√≠ficamente)
  Dependencias: Ninguna
  Criterio DONE:
    - Rate limit de 50 requests/5min por IP para /api/chat.
    - Rate limit global sigue funcionando para otros endpoints.
    - Logs muestran cuando se activa el rate limit.
    - 100 simulaciones no activan el rate limit (deben usar diferentes IPs o token admin).
  Prioridad: P0

F1-T03: Hacer ADMIN_TOKEN obligatorio en producci√≥n para endpoints admin
  Qu√© corrige: /api/historial/:sessionId (l√≠nea 8502), /api/transcript-json/:sessionId (l√≠nea 8615)
  Riesgo: Medio (exposici√≥n de datos sensibles)
  Impacto: Medio (protege privacidad)
  Complejidad: Baja (validar IS_PRODUCTION y requerir token)
  Dependencias: Ninguna
  Criterio DONE:
    - En producci√≥n, endpoints retornan 403 si ADMIN_TOKEN no est√° configurado o es inv√°lido.
    - En desarrollo, sigue siendo opcional (o genera warning).
    - Logs muestran intentos de acceso sin token.
  Prioridad: P0

F1-T04: Implementar locks para saveSession() para prevenir race conditions
  Qu√© corrige: Funci√≥n saveSession() (l√≠neas 958-1006)
  Riesgo: Alto (p√©rdida de datos)
  Impacto: Alto (consistencia de sesiones)
  Complejidad: Media (implementar Map de locks similar a ticketCreationLocks)
  Dependencias: Ninguna
  Criterio DONE:
    - M√∫ltiples requests concurrentes a la misma sesi√≥n no sobrescriben datos.
    - Lock se libera despu√©s de guardar o en caso de error.
    - Logs muestran cuando se activa un lock.
    - Test: 10 requests simult√°neos a misma sesi√≥n, todos los mensajes se guardan.
  Prioridad: P0

F1-T05: Validar transiciones de stage usando VALID_TRANSITIONS
  Qu√© corrige: Funci√≥n changeStage() (l√≠neas 1382-1390) y todos los handlers que la usan
  Riesgo: Medio (flujo puede romperse)
  Impacto: Alto (consistencia del flujo)
  Complejidad: Media (modificar changeStage para validar, agregar logging)
  Dependencias: Ninguna
  Criterio DONE:
    - changeStage() valida transici√≥n antes de cambiar stage.
    - Transici√≥n inv√°lida genera error y log de advertencia.
    - Simulaciones detectan transiciones inv√°lidas como error cr√≠tico.
    - Test: Intentar cambio ASK_LANGUAGE ‚Üí ENDED directamente, debe fallar.
  Prioridad: P0

F1-T06: Agregar rate limit para /api/simulations/run
  Qu√© corrige: Endpoint /api/simulations/run (l√≠nea 9470)
  Riesgo: Alto (DoS y consumo de recursos)
  Impacto: Alto (protege servidor)
  Complejidad: Baja (crear rate limiter espec√≠fico)
  Dependencias: F1-T01 (autenticaci√≥n)
  Criterio DONE:
    - Rate limit de 10 simulaciones/hora por IP (o 5 si autenticado con ADMIN_TOKEN).
    - Logs muestran cuando se activa.
    - Request con count > 100 es rechazado (validaci√≥n adicional).
  Prioridad: P0

F1-T07: Validar l√≠mites de count y maxSteps en /api/simulations/run
  Qu√© corrige: Endpoint /api/simulations/run, validaci√≥n de inputs (l√≠neas 9472-9483)
  Riesgo: Medio (consumo excesivo de recursos)
  Impacto: Medio (previene abusos)
  Complejidad: Baja (agregar validaciones num√©ricas)
  Dependencias: Ninguna
  Criterio DONE:
    - count m√°ximo: 100 por request.
    - maxSteps m√°ximo: 200 por simulaci√≥n.
    - Valores fuera de rango retornan 400 con mensaje claro.
    - Logs muestran intentos con valores inv√°lidos.
  Prioridad: P0

F1-T08: Agregar timeout para llamadas a OpenAI
  Qu√© corrige: Cliente OpenAI, llamadas en handlers (buscar llamadas a openai.chat.completions.create)
  Riesgo: Medio (requests pueden colgarse)
  Impacto: Medio (previene timeouts largos)
  Complejidad: Media (configurar timeout en cliente OpenAI, manejar errores)
  Dependencias: Ninguna
  Criterio DONE:
    - Timeout de 30 segundos para llamadas a OpenAI.
    - Si timeout, se retorna respuesta gen√©rica sin error al usuario.
    - Logs muestran timeouts de OpenAI.
    - Test: Simular timeout, verificar respuesta gen√©rica.
  Prioridad: P0

F1-T09: Validar tama√±o m√°ximo de userText
  Qu√© corrige: Endpoint /api/chat, validaci√≥n de body (l√≠nea 8898)
  Riesgo: Bajo (abuso de recursos)
  Impacto: Bajo (previene text gigante)
  Complejidad: Baja (agregar validaci√≥n de longitud)
  Dependencias: Ninguna
  Criterio DONE:
    - userText m√°ximo: 5000 caracteres.
    - Texto m√°s largo retorna 400 con mensaje claro.
    - Logs muestran intentos con texto muy largo.
  Prioridad: P1

F1-T10: Mejorar validaci√≥n de CORS en producci√≥n (opcional pero recomendado)
  Qu√© corrige: Configuraci√≥n CORS (l√≠neas 323-325)
  Riesgo: Bajo (acceso no autorizado si no hay rate limiting)
  Impacto: Bajo (mejora seguridad)
  Complejidad: Baja (agregar validaci√≥n opcional)
  Dependencias: Ninguna
  Criterio DONE:
    - En producci√≥n, si ALLOWED_ORIGINS est√° configurado, rechazar requests sin origin (o loguear como advertencia).
    - Mantener comportamiento actual si no est√° configurado (compatibilidad).
    - Logs muestran requests sin origin en producci√≥n.
  Prioridad: P2

FASE 2: ROBUSTEZ DEL FLUJO Y PERSISTENCIA (P1 - Escalabilidad)
================================================================================

Objetivo: Mejorar robustez del flujo conversacional, manejo de persistencia y observabilidad.

Alcance:
- Incluye: TTL para sesiones, rotaci√≥n de logs, validaci√≥n de datos m√≠nimos, mejoras en logging.
- Excluye: Cambios en l√≥gica de handlers, refactor de funciones grandes.

Tareas FASE 2:

F2-T01: Implementar TTL para sesiones (borrado autom√°tico despu√©s de 48h)
  Qu√© corrige: saveSession() y funci√≥n de limpieza (nueva funci√≥n requerida)
  Riesgo: Bajo (acumulaci√≥n de archivos)
  Impacto: Medio (previene llenado de disco)
  Complejidad: Media (implementar funci√≥n de limpieza, cron job o ejecutar en startup)
  Dependencias: Ninguna
  Criterio DONE:
    - Funci√≥n que borra sesiones > 48h sin actividad (basado en √∫ltima modificaci√≥n del archivo).
    - Se ejecuta al menos una vez al d√≠a (cron o en startup).
    - Logs muestran cantidad de sesiones borradas.
    - Test: Crear sesi√≥n con timestamp antiguo, ejecutar limpieza, verificar borrado.
  Prioridad: P1

F2-T02: Implementar rotaci√≥n de logs (server.log y telemetry.log)
  Qu√© corrige: Inicializaci√≥n de logs (l√≠neas 137-138, 271-276)
  Riesgo: Bajo (crecimiento indefinido)
  Impacto: Bajo (previene llenado de disco)
  Complejidad: Media (usar pino-rotate o implementar rotaci√≥n manual)
  Dependencias: Ninguna
  Criterio DONE:
    - Logs rotan cuando alcanzan 100MB o diariamente (mantener √∫ltimos 7 d√≠as).
    - Logs antiguos se comprimen o eliminan.
    - Logs muestran cuando ocurre rotaci√≥n.
    - Test: Generar log grande, verificar rotaci√≥n.
  Prioridad: P1

F2-T03: Agregar logging cuando se activan guard rails de simulaci√≥n
  Qu√© corrige: Guard rails en saveSession (l√≠nea 972), createTicketAndRespond (l√≠nea 6950), pushBasicTestTelemetry (l√≠nea 859)
  Riesgo: Ninguno (solo mejoras)
  Impacto: Bajo (mejora observabilidad)
  Complejidad: Baja (ya existe logging, verificar que sea completo)
  Dependencias: Ninguna
  Criterio DONE:
    - Cada guard rail loguea con nivel WARN y formato consistente [SIMULATION_GUARD].
    - Logs incluyen sessionId y acci√≥n bloqueada.
    - Test: Ejecutar simulaci√≥n, verificar logs de guard rails.
  Prioridad: P1

F2-T04: Validar que faltanDatosMinimos() se usa antes de mostrar pasos
  Qu√© corrige: handleAskDeviceStage (l√≠nea 4622), handleBasicTestsStage (l√≠nea 5707)
  Riesgo: Bajo (puede mostrar pasos gen√©ricos)
  Impacto: Medio (mejora calidad de diagn√≥stico)
  Complejidad: Media (verificar implementaci√≥n de faltanDatosMinimos, integrar en handlers)
  Dependencias: Verificar si faltanDatosMinimos() existe
  Criterio DONE:
    - Antes de mostrar > 2 pasos, se valida contextMinima (OS, tipo de perif√©rico si aplica).
    - Si faltan datos, se hacen 1-3 preguntas cortas.
    - Simulaciones detectan "pasos gen√©ricos sin preguntas" como error cr√≠tico.
    - Test: Simular problema de perif√©rico sin OS, verificar que pregunta por OS.
  Prioridad: P1

F2-T05: Agregar l√≠mite de sesiones por IP en rate limit global
  Qu√© corrige: Rate limiter global (l√≠neas 428-437)
  Riesgo: Bajo (spam de sesiones)
  Impacto: Bajo (previene abuso)
  Complejidad: Media (trackear sesiones por IP, limitar creaci√≥n)
  Dependencias: Ninguna
  Criterio DONE:
    - M√°ximo 20 sesiones nuevas/15min por IP.
    - L√≠mite se aplica solo a /api/greeting y primera llamada a /api/chat.
    - Logs muestran cuando se activa el l√≠mite.
    - Test: Crear 25 sesiones desde misma IP, verificar bloqueo.
  Prioridad: P1

F2-T06: Mejorar logging de rate limits (todos los rate limiters)
  Qu√© corrige: Rate limiters global, uploads, chat (si se agrega en F1)
  Riesgo: Ninguno (solo mejoras)
  Impacto: Bajo (mejora observabilidad)
  Complejidad: Baja (agregar logging consistente)
  Dependencias: F1-T02 (rate limit para /api/chat)
  Criterio DONE:
    - Todos los rate limits loguean cuando se activan (IP, endpoint, l√≠mite alcanzado).
    - Logs incluyen timestamp y cantidad de requests restantes.
    - Test: Activar rate limit, verificar logs.
  Prioridad: P2

F2-T07: Validar que getRenderedStep() funciona correctamente para ayuda de pasos
  Qu√© corrige: handleBasicTestsStage, botones BTN_HELP_STEP_X (buscar uso de getRenderedStep)
  Riesgo: Bajo (ayuda puede no coincidir con paso)
  Impacto: Bajo (consistencia UX)
  Complejidad: Baja (verificar implementaci√≥n, agregar tests)
  Dependencias: Verificar si getRenderedStep() existe
  Criterio DONE:
    - BTN_HELP_STEP_X retorna ayuda del paso exacto mostrado (de stepsRendered[]).
    - Ayuda coincide 1:1 con el t√≠tulo y contenido del paso.
    - Simulaciones verifican coherencia ayuda vs paso.
    - Test: Consultar ayuda paso 3, verificar que explica paso 3 real.
  Prioridad: P1

F2-T08: Agregar m√©tricas de uso de endpoints (opcional, mejora)
  Qu√© corrige: Middleware de logging (l√≠neas 457-465)
  Riesgo: Ninguno
  Impacto: Bajo (mejora observabilidad)
  Complejidad: Media (contadores en memoria, exportar a telemetry.log)
  Dependencias: Ninguna
  Criterio DONE:
    - Contadores de requests por endpoint (en memoria, se reinician al restart).
    - Se exportan a telemetry.log cada N requests o peri√≥dicamente.
    - Test: Hacer requests, verificar contadores.
  Prioridad: P2

FASE 3: MEJORAS Y REFINAMIENTOS (P2 - Calidad)
================================================================================

Objetivo: Mejoras est√©ticas, optimizaciones y refinamientos que no afectan funcionalidad cr√≠tica.

Alcance:
- Incluye: Optimizaciones de c√≥digo, mejoras en mensajes de error, documentaci√≥n adicional.
- Excluye: Refactor masivo, cambios de arquitectura.

Tareas FASE 3:

F3-T01: Centralizar validaci√≥n de userText en funci√≥n helper
  Qu√© corrige: Todos los handlers que validan userText (handleAskLanguageStage, handleAskNameStage, etc.)
  Riesgo: Bajo (consolidaci√≥n de c√≥digo)
  Impacto: Bajo (mantenibilidad)
  Complejidad: Media (crear funci√≥n helper, reemplazar en todos los handlers)
  Dependencias: Ninguna
  Criterio DONE:
    - Funci√≥n validateUserText(userText, buttonToken) centralizada.
    - Todos los handlers usan la funci√≥n helper.
    - Validaciones son consistentes en todos los handlers.
    - Test: Verificar validaci√≥n funciona igual en todos los handlers.
  Prioridad: P2

F3-T02: Mejorar mensajes de error para usuarios (m√°s claros y √∫tiles)
  Qu√© corrige: Mensajes de error en handlers y endpoints
  Riesgo: Ninguno
  Impacto: Bajo (mejora UX)
  Complejidad: Baja (mejorar textos de mensajes)
  Dependencias: Ninguna
  Criterio DONE:
    - Mensajes de error son claros y accionables para el usuario.
    - Mensajes est√°n en el idioma correcto (seg√∫n locale).
    - Test: Generar errores, verificar mensajes.
  Prioridad: P2

F3-T03: Agregar documentaci√≥n JSDoc faltante en funciones p√∫blicas
  Qu√© corrige: Funciones sin documentaci√≥n completa (auditar manualmente)
  Riesgo: Ninguno
  Impacto: Bajo (mejora mantenibilidad)
  Complejidad: Baja (agregar comentarios)
  Dependencias: Ninguna
  Criterio DONE:
    - Todas las funciones p√∫blicas tienen JSDoc con @param, @returns, @throws si aplica.
    - Documentaci√≥n explica qu√© se puede modificar y qu√© no.
    - Test: Revisi√≥n manual de documentaci√≥n.
  Prioridad: P2

F3-T04: Optimizar consultas de archivos en generateUnifiedId()
  Qu√© corrige: Funci√≥n generateUnifiedId() (l√≠neas 751-809)
  Riesgo: Ninguno
  Impacto: Bajo (mejora performance)
  Complejidad: Media (usar cache o √≠ndice de IDs existentes)
  Dependencias: Ninguna
  Criterio DONE:
    - Verificaci√≥n de IDs existentes es m√°s r√°pida (cache o √≠ndice).
    - Performance mejora en generaci√≥n de muchos IDs.
    - Test: Generar 1000 IDs, medir tiempo.
  Prioridad: P2

F3-T05: Agregar health check m√°s completo (disco, memoria, conectividad)
  Qu√© corrige: Endpoint /api/health (l√≠neas 479-530)
  Riesgo: Ninguno
  Impacto: Bajo (mejora monitoreo)
  Complejidad: Media (verificar disco, memoria, OpenAI connectivity)
  Dependencias: Ninguna
  Criterio DONE:
    - Health check incluye: espacio en disco, uso de memoria, conectividad OpenAI (opcional).
    - Retorna estado "degraded" si alg√∫n recurso est√° bajo.
    - Test: Verificar health check con diferentes estados.
  Prioridad: P2

F3-T06: Mejorar formato de logs de simulaciones (m√°s legible)
  Qu√© corrige: simulation-engine.js, formato de logs guardados
  Riesgo: Ninguno
  Impacto: Bajo (mejora an√°lisis)
  Complejidad: Baja (mejorar formato JSON, agregar summary legible)
  Dependencias: Ninguna
  Criterio DONE:
    - Logs de simulaciones incluyen summary legible al inicio.
    - Formato JSON est√° bien estructurado y f√°cil de leer.
    - Test: Ejecutar simulaci√≥n, verificar formato de log.
  Prioridad: P2

F3-T07: Agregar validaci√≥n de formato de nombres de archivo en uploads (mejora)
  Qu√© corrige: Multer storage, filename (l√≠neas 8017-8047)
  Riesgo: Ninguno (ya est√° bien)
  Impacto: Bajo (mejora seguridad adicional)
  Complejidad: Baja (validaciones adicionales)
  Dependencias: Ninguna
  Criterio DONE:
    - Validaci√≥n adicional de caracteres especiales en nombres.
    - Prevenci√≥n de nombres muy largos (> 255 caracteres).
    - Test: Intentar subir archivo con nombre inv√°lido, verificar rechazo.
  Prioridad: P2

F3-T08: Documentar proceso de despliegue y variables de entorno requeridas
  Qu√© corrige: Documentaci√≥n (crear README_DEPLOY.md o similar)
  Riesgo: Ninguno
  Impacto: Bajo (mejora mantenibilidad)
  Complejidad: Baja (escribir documentaci√≥n)
  Dependencias: Ninguna
  Criterio DONE:
    - Documento con lista de variables de entorno requeridas.
    - Proceso paso a paso de despliegue.
    - Troubleshooting com√∫n.
    - Test: Revisi√≥n manual de documentaci√≥n.
  Prioridad: P2

================================================================================
3) MATRIZ DE RIESGO
================================================================================

√Årea                  | Riesgo                                    | Prob | Impacto | Severidad | Mitigaci√≥n propuesta                          | Fase
--------------------- | ----------------------------------------- | ---- | ------- | --------- | --------------------------------------------- | ----
Security              | /api/simulations/run sin auth             | 5    | 5       | 25        | Autenticaci√≥n obligatoria + rate limit        | 1
Security              | Race condition en saveSession()           | 4    | 5       | 20        | Locks por sessionId                           | 1
Security              | ADMIN_TOKEN opcional en endpoints admin    | 3    | 4       | 12        | Obligatorio en producci√≥n                     | 1
Security              | CORS permite requests sin origin           | 3    | 3       | 9         | Validaci√≥n opcional en producci√≥n             | 1
Security              | No rate limit para /api/chat               | 4    | 4       | 16        | Rate limit espec√≠fico 50/5min                 | 1
Flow                  | No se valida VALID_TRANSITIONS             | 3    | 4       | 12        | Validar en changeStage()                      | 1
Flow                  | No valida datos m√≠nimos antes de pasos     | 2    | 3       | 6         | Usar faltanDatosMinimos()                     | 2
Simulations           | Simulaciones pueden causar DoS             | 4    | 4       | 16        | Rate limit + l√≠mites de count/maxSteps        | 1
Logging               | Logs crecen indefinidamente                | 2    | 3       | 6         | Rotaci√≥n de logs                              | 2
Persistence           | Sesiones sin TTL llenan disco              | 3    | 3       | 9         | Borrado autom√°tico > 48h                      | 2
Persistence           | No timeout para OpenAI                     | 2    | 3       | 6         | Timeout de 30s                                | 1
Admin                 | Endpoints admin expuestos                  | 3    | 3       | 9         | ADMIN_TOKEN obligatorio                       | 1

================================================================================
4) PLAN DE PRUEBAS POR FASE
================================================================================

FASE 1 - PRUEBAS M√çNIMAS:
- [ ] Ejecutar 100 simulaciones (50 es-AR, 50 en-US) sin autenticaci√≥n ‚Üí debe fallar con 403.
- [ ] Ejecutar 100 simulaciones (50 es-AR, 50 en-US) con ADMIN_TOKEN v√°lido ‚Üí debe funcionar.
- [ ] Enviar 60 requests a /api/chat en 5 minutos desde misma IP ‚Üí request 51+ debe retornar 429.
- [ ] Enviar 2 requests simult√°neos a misma sesi√≥n ‚Üí ambos mensajes deben guardarse (sin race condition).
- [ ] Intentar cambio de stage inv√°lido (ASK_LANGUAGE ‚Üí ENDED) ‚Üí debe fallar con log de advertencia.
- [ ] Ejecutar simulaci√≥n con count=200 ‚Üí debe fallar con 400 (l√≠mite es 100).
- [ ] Ejecutar simulaci√≥n con maxSteps=300 ‚Üí debe fallar con 400 (l√≠mite es 200).
- [ ] Simular timeout de OpenAI (mock) ‚Üí debe retornar respuesta gen√©rica sin error al usuario.
- [ ] Enviar userText de 6000 caracteres ‚Üí debe retornar 400.
- [ ] Verificar logs: [SIMULATION_GUARD] aparece en simulaciones, no en requests normales.

FASE 1 - PRUEBAS DE NO-REGRESI√ìN:
- [ ] WhatsApp prematuro: 50 simulaciones en ASK_NEED sin pasos confirmados ‚Üí 0 ofertas de WhatsApp.
- [ ] Repetici√≥n de pasos: Usuario confirma paso 1, luego pide ayuda paso 2 ‚Üí NO se reimprimen todos los pasos.
- [ ] P√©rdida de sesi√≥n: 10 requests consecutivos a misma sesi√≥n ‚Üí todos los datos se mantienen.
- [ ] Idioma: 50 simulaciones en es-AR ‚Üí todas las respuestas en espa√±ol argentino.

FASE 2 - PRUEBAS M√çNIMAS:
- [ ] Crear sesi√≥n con timestamp de hace 50 horas ‚Üí ejecutar limpieza ‚Üí sesi√≥n debe borrarse.
- [ ] Generar log de 101MB ‚Üí debe rotar autom√°ticamente.
- [ ] Ejecutar simulaci√≥n ‚Üí verificar logs [SIMULATION_GUARD] completos y consistentes.
- [ ] Simular problema de perif√©rico sin OS ‚Üí debe preguntar por OS antes de mostrar pasos.
- [ ] Crear 25 sesiones nuevas desde misma IP en 10 minutos ‚Üí sesi√≥n 21+ debe fallar.
- [ ] Activar rate limit ‚Üí verificar logs incluyen IP, endpoint, l√≠mite alcanzado.
- [ ] Consultar ayuda paso 3 ‚Üí debe explicar exactamente el paso 3 mostrado (no otro).

FASE 2 - PRUEBAS DE NO-REGRESI√ìN:
- [ ] Mismas pruebas de FASE 1 (WhatsApp prematuro, repetici√≥n, p√©rdida de sesi√≥n, idioma).

FASE 3 - PRUEBAS M√çNIMAS:
- [ ] Validar userText en todos los handlers ‚Üí comportamiento consistente.
- [ ] Generar errores en diferentes handlers ‚Üí mensajes claros y en idioma correcto.
- [ ] Revisar documentaci√≥n JSDoc ‚Üí todas las funciones p√∫blicas tienen documentaci√≥n.
- [ ] Generar 1000 IDs ‚Üí tiempo de generaci√≥n < 5 segundos.
- [ ] Verificar /api/health ‚Üí incluye disco, memoria, conectividad (opcional).
- [ ] Ejecutar simulaci√≥n ‚Üí formato de log es legible y bien estructurado.
- [ ] Intentar subir archivo con nombre inv√°lido ‚Üí rechazo correcto.

FASE 3 - PRUEBAS DE NO-REGRESI√ìN:
- [ ] Mismas pruebas de FASE 1 y FASE 2.

PRUEBAS DE SIMULACIONES (Todas las fases):
- Fase 1: 100 simulaciones (50 es-AR, 50 en-US) ‚Üí principalError y top3Errores detectados correctamente.
- Fase 2: 300 simulaciones (150 es-AR, 150 en-US) ‚Üí pasosConsultados y pasosConfirmados trackeados correctamente.
- Fase 3: 1000 simulaciones (500 es-AR, 500 en-US) ‚Üí 0 errores cr√≠ticos, formato de logs consistente.

================================================================================
5) AUDITOR√çA POST-IMPLEMENTACI√ìN (CHECKLIST)
================================================================================

FASE 1 - CHECKLIST:

Seguridad:
[ ] /api/simulations/run requiere ADMIN_TOKEN (403 si no hay token)
[ ] /api/chat tiene rate limit espec√≠fico (50/5min por IP)
[ ] ADMIN_TOKEN es obligatorio en producci√≥n para endpoints admin
[ ] saveSession() tiene locks para prevenir race conditions
[ ] VALID_TRANSITIONS se valida en changeStage()
[ ] /api/simulations/run tiene rate limit (10/hora por IP)
[ ] count y maxSteps tienen l√≠mites m√°ximos validados
[ ] OpenAI tiene timeout de 30s
[ ] userText tiene l√≠mite de 5000 caracteres

Flujo:
[ ] Transiciones de stage son validadas antes de cambiar
[ ] Logs muestran transiciones inv√°lidas como advertencia
[ ] Simulaciones detectan transiciones inv√°lidas como error cr√≠tico

Guard rails de simulaci√≥n:
[ ] saveSession bloquea en modo simulaci√≥n (prefijo SIM_)
[ ] createTicketAndRespond bloquea en modo simulaci√≥n
[ ] pushBasicTestTelemetry bloquea en modo simulaci√≥n
[ ] Logs [SIMULATION_GUARD] aparecen en simulaciones

Logs:
[ ] Rate limits se loguean cuando se activan
[ ] Transiciones inv√°lidas se loguean
[ ] Guard rails de simulaci√≥n se loguean

FASE 2 - CHECKLIST:

Persistence:
[ ] Sesiones > 48h se borran autom√°ticamente (funci√≥n de limpieza implementada)
[ ] Logs rotan cuando alcanzan 100MB o diariamente
[ ] Logs antiguos se eliminan o comprimen (√∫ltimos 7 d√≠as)

Flujo:
[ ] faltanDatosMinimos() se usa antes de mostrar > 2 pasos
[ ] Si faltan datos (OS, perif√©rico), se hacen 1-3 preguntas cortas
[ ] getRenderedStep() retorna ayuda del paso exacto mostrado

Logging:
[ ] Guard rails de simulaci√≥n loguean con formato [SIMULATION_GUARD]
[ ] Rate limits loguean IP, endpoint, l√≠mite alcanzado
[ ] M√©tricas de endpoints se exportan a telemetry.log (si se implementa)

FASE 3 - CHECKLIST:

C√≥digo:
[ ] validateUserText() est√° centralizado y se usa en todos los handlers
[ ] Mensajes de error son claros y en idioma correcto
[ ] Documentaci√≥n JSDoc completa en funciones p√∫blicas

Performance:
[ ] generateUnifiedId() optimizado (cache o √≠ndice)
[ ] Health check incluye disco, memoria, conectividad

Simulaciones:
[ ] Formato de logs es legible y bien estructurado
[ ] Logs incluyen summary al inicio

Documentaci√≥n:
[ ] README_DEPLOY.md existe con variables de entorno y proceso de despliegue

================================================================================
6) "NO HACER" (LISTA CORTA)
================================================================================

NO realizar en estas fases:

1. ‚ùå Refactor masivo de handlers grandes (handleBasicTestsStage, handleAskDeviceStage, handleAskNeedStage).
   Raz√≥n: Riesgo alto de introducir bugs, estas funciones funcionan correctamente aunque sean grandes.

2. ‚ùå Dividir server.js en microservicios o m√≥dulos separados.
   Raz√≥n: Cambio arquitect√≥nico mayor, requiere re-testing completo y puede romper integraciones.

3. ‚ùå Cambiar formato de sesiones/transcripts existentes.
   Raz√≥n: Puede romper compatibilidad con datos existentes y herramientas que los leen.

4. ‚ùå Modificar guard rails de simulaci√≥n (saveSession, createTicketAndRespond, pushBasicTestTelemetry).
   Raz√≥n: Est√°n implementados correctamente, cualquier cambio aumenta riesgo de contaminar producci√≥n.

5. ‚ùå Alterar formato obligatorio de pasos (formatStepWithMandatoryFormat).
   Raz√≥n: Funciona correctamente, cambios pueden romper renderizado en frontend.

6. ‚ùå Reescribir motor de simulaciones completo.
   Raz√≥n: Funciona correctamente, solo necesita mejoras en seguridad y validaciones.

7. ‚ùå Cambiar sistema de IDs (A0000-Z9999) a otro formato.
   Raz√≥n: Compatibilidad con datos existentes, solo optimizar generaci√≥n si es necesario.

8. ‚ùå Eliminar o modificar significativamente VALID_TRANSITIONS.
   Raz√≥n: Es la fuente de verdad para transiciones v√°lidas, solo falta validar que se use.

9. ‚ùå Modificar l√≥gica de detecci√≥n de dispositivos o problemas sin testing exhaustivo.
   Raz√≥n: Cambios pueden afectar flujo conversacional en producci√≥n.

10. ‚ùå Agregar nuevas funcionalidades no relacionadas con correcciones de seguridad/robustez.
    Raz√≥n: Estas fases se enfocan en correcciones, no en features nuevas.

================================================================================
FIN DEL ROADMAP
================================================================================

