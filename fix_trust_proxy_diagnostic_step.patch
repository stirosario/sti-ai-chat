diff --git a/server.js b/server.js
index 0000000..1111111 100644
--- a/server.js
+++ b/server.js
@@ -465,6 +465,11 @@ app.use(express.json({ limit: '10mb' }));
 app.use(express.urlencoded({ extended: true, limit: '10mb' }));
 
+// Trust proxy (necesario para Render y otros proxies reversos)
+// Permite override por .env: TRUST_PROXY=1 (default en producción) o TRUST_PROXY=0 (local)
+const trustProxy = process.env.TRUST_PROXY !== undefined ? parseInt(process.env.TRUST_PROXY) : 1;
+app.set('trust proxy', trustProxy);
+
 // Rate limiting
 const limiter = rateLimit({
   windowMs: 15 * 60 * 1000, // 15 minutos
@@ -294,7 +299,7 @@ const STAGE_CONTRACT = {
   DIAGNOSTIC_STEP: {
     type: 'AI_GOVERNED',
     allowButtons: true,
-    allowedTokens: ['BTN_SOLVED', 'BTN_PERSIST', 'BTN_HELP_CONTEXT', 'BTN_BACK', 'BTN_CONNECT_TECH'],
+    allowedTokens: ['BTN_SOLVED', 'BTN_PERSIST', 'BTN_HELP_CONTEXT', 'BTN_BACK', 'BTN_CONNECT_TECH', 'BTN_PWR_NO_SIGNS', 'BTN_PWR_FANS', 'BTN_PWR_BEEPS', 'BTN_PWR_ON_OFF', 'BTN_STEP_DONE', 'BTN_STEP_STILL', 'BTN_STEP_HELP'],
     defaultButtons: [],
     prompt: {
       'es-AR': 'Siguiente paso de diagnóstico',
@@ -377,7 +382,17 @@ const BUTTON_CATALOG = {
   'BTN_REASON_TOO_MANY_STEPS': { label: { 'es-AR': 'Demasiados pasos', 'en-US': 'Too many steps' } },
   'BTN_REASON_WANTED_TECH': { label: { 'es-AR': 'Prefería hablar con un técnico', 'en-US': 'Wanted to talk to a technician' } },
   'BTN_REASON_OTHER': { label: { 'es-AR': 'Otro motivo', 'en-US': 'Other reason' } },
+  // Botones para diagnóstico de encendido (wont_turn_on)
+  'BTN_PWR_NO_SIGNS': { label: { 'es-AR': 'No enciende nada (sin luces ni ventilador)', 'en-US': 'Nothing happens (no lights or fan)' } },
+  'BTN_PWR_FANS': { label: { 'es-AR': 'Prenden luces o gira el ventilador', 'en-US': 'Lights turn on or fan spins' } },
+  'BTN_PWR_BEEPS': { label: { 'es-AR': 'Escucho pitidos (beeps)', 'en-US': 'I hear beeps' } },
+  'BTN_PWR_ON_OFF': { label: { 'es-AR': 'Enciende y se apaga enseguida', 'en-US': 'Turns on and off immediately' } },
+  // Botones para pasos de diagnóstico
+  'BTN_STEP_DONE': { label: { 'es-AR': 'Listo, probé esto', 'en-US': 'Done, I tried this' } },
+  'BTN_STEP_STILL': { label: { 'es-AR': 'Sigue igual', 'en-US': 'Still the same' } },
+  'BTN_STEP_HELP': { label: { 'es-AR': 'No puedo hacerlo / necesito ayuda', 'en-US': "I can't do this / I need help" } }
 };
 
 function getStageContract(stage) {
@@ -863,7 +878,8 @@ async function handleAskProblemStage(session, userText, sessionId) {
       
       session.problem_validated = true;
-      session.problem_intent = analysis.intent || 'unknown';
+      session.intent = analysis.intent || 'unknown'; // Guardar como intent (usado por DIAGNOSTIC_STEP)
+      session.problem_intent = analysis.intent || 'unknown'; // Mantener por compatibilidad
       session.problem_needs_clarification = analysis.needs_clarification || false;
       
       console.log(`[ASK_PROBLEM] [${sessionId}] Análisis recibido:`, {
@@ -906,7 +922,8 @@ async function handleAskProblemStage(session, userText, sessionId) {
       // Fallback seguro: pedir dispositivo directamente
       session.problem_validated = true;
-      session.problem_intent = 'unknown';
+      session.intent = 'unknown'; // Guardar como intent
+      session.problem_intent = 'unknown'; // Mantener por compatibilidad
       session.openai_failed = true;
       const contract = getStageContract('ASK_DEVICE');
       console.log(`[ASK_PROBLEM] [${sessionId}] Usando fallback: avanzando a ASK_DEVICE`);
@@ -1058,300 +1075,120 @@ async function handleAskOsStage(ctx) {
   }
 }
 
-// Handler para diagnóstico paso a paso (sistema híbrido)
+// Handler para diagnóstico paso a paso (motor real de pasos)
 async function handleDiagnosticStepStage(session, userText, buttonToken, sessionId) {
   const locale = session.userLocale || 'es-AR';
   const isEn = locale.startsWith('en');
   const userLevel = session.userLevel || 'intermediate';
-  
-  console.log(`[DIAGNOSTIC_STEP] [${sessionId}] Iniciando, buttonToken: ${buttonToken || 'null'}, userText: ${userText ? userText.substring(0, 30) : 'null'}`);
-  
-  // Cargar historial como memoria
-  const history = loadConversationHistory(sessionId);
-  const executedSteps = getExecutedDiagnosticSteps(history);
-  console.log(`[DIAGNOSTIC_STEP] [${sessionId}] Pasos ejecutados: ${executedSteps.length}`);
-  
-  // Contar pasos básicos y avanzados
-  const basicSteps = executedSteps.filter(s => s.step_number <= 5).length;
-  const advancedSteps = executedSteps.filter(s => s.step_number > 5).length;
-  const maxBasicSteps = 5;
-  const maxAdvancedSteps = 5;
-  
-  // Verificar si hay 2 "Sigue igual" seguidos
-  const lastTwoResults = [];
-  for (let i = history.length - 1; i >= 0 && lastTwoResults.length < 2; i--) {
-    const turn = history[i];
-    if (turn.stage_after === 'DIAGNOSTIC_STEP' && turn.user_event) {
-      if (typeof turn.user_event === 'string' && turn.user_event.includes('BTN_PERSIST')) {
-        lastTwoResults.push('BTN_PERSIST');
-      } else if (typeof turn.user_event === 'object' && turn.user_event.token === 'BTN_PERSIST') {
-        lastTwoResults.push('BTN_PERSIST');
-      }
-    }
-  }
-  const twoPersistsInRow = lastTwoResults.length === 2 && lastTwoResults[0] === 'BTN_PERSIST' && lastTwoResults[1] === 'BTN_PERSIST';
-  
-  // Si se alcanzó el límite o hay 2 "Sigue igual", recomendar técnico
-  if (basicSteps >= maxBasicSteps && advancedSteps >= maxAdvancedSteps || twoPersistsInRow) {
-    const contract = getStageContract('FEEDBACK_REQUIRED');
-    return {
-      reply: isEn
-        ? "I've reached the limit of diagnostic steps. I recommend talking to a technician. Let me know if this session was helpful."
-        : 'Alcanzé el límite de pasos de diagnóstico. Te recomiendo hablar con un técnico. ¿Te sirvió esta ayuda?',
-      stage: 'FEEDBACK_REQUIRED',
-      buttons: contract.defaultButtons
-    };
-  }
-  
-  // Manejar botones de resultado
-  if (buttonToken === 'BTN_SOLVED') {
-    // Problema resuelto, pedir feedback
-    const contract = getStageContract('FEEDBACK_REQUIRED');
-    return {
-      reply: isEn
-        ? 'Great! I\'m glad it worked. Did this help you?'
-        : '¡Genial! Me alegra que haya funcionado. ¿Te sirvió esta ayuda?',
-      stage: 'FEEDBACK_REQUIRED',
-      buttons: contract.defaultButtons
-    };
-  }
-  
-  if (buttonToken === 'BTN_HELP_CONTEXT') {
-    // Ayuda contextual: NO avanza el flujo, solo explica el paso actual
-    const lastStep = executedSteps[executedSteps.length - 1];
-    if (lastStep && lastStep.action) {
-      // Generar ayuda contextual adaptada al nivel del usuario
-      if (openai) {
-        try {
-          const levelContext = userLevel === 'basic'
-            ? (isEn ? 'Explain in very simple terms, step by step.' : 'Explicá en términos muy simples, paso a paso.')
-            : userLevel === 'advanced'
-              ? (isEn ? 'Be technical and precise.' : 'Sé técnico y preciso.')
-              : (isEn ? 'Use common technical terms.' : 'Usá términos técnicos comunes.');
-          
-          const helpPrompt = isEn
-            ? `The user needs contextual help for this action: "${lastStep.action}". ${levelContext} Provide clear instructions without advancing the flow.`
-            : `El usuario necesita ayuda contextual para esta acción: "${lastStep.action}". ${levelContext} Proporcioná instrucciones claras sin avanzar el flujo.`;
-          
-          const completion = await openai.chat.completions.create({
-            model: OPENAI_MODEL,
-            messages: [
-              { role: 'system', content: 'You are Tecnos, an IT support assistant.' },
-              { role: 'user', content: helpPrompt }
-            ],
-            temperature: 0.5,
-            max_tokens: 300
-          });
-          
-          const helpText = completion.choices[0]?.message?.content || '';
-          // Volver al mismo paso con los mismos botones
-          const lastTurn = history[history.length - 1];
-          const helpReply = `${lastTurn?.bot_reply || ''}\n\n---\n\n${helpText}`;
-          return {
-            reply: helpReply,
-            stage: 'DIAGNOSTIC_STEP',
-            buttons: lastTurn?.buttons_shown || []
-          };
-        } catch (err) {
-          console.error('[DIAGNOSTIC_STEP] Error generating help:', err);
-        }
-      }
-    }
-    // Si no hay último paso o falla, continuar normalmente
-  }
-  
-  if (buttonToken === 'BTN_BACK') {
-    // Volver al paso anterior: usar el paso previo sin llamar a OpenAI
-    if (executedSteps.length >= 2) {
-      const previousStep = executedSteps[executedSteps.length - 2];
-      // Encontrar el turn correspondiente y reutilizar
-      const previousTurn = history.find(t => t.diagnostic_step && t.diagnostic_step.step_id === previousStep.step_id);
-      if (previousTurn) {
-        return {
-          reply: previousTurn.bot_reply,
-          stage: 'DIAGNOSTIC_STEP',
-          buttons: previousTurn.buttons_shown || []
-        };
-      }
-    }
-  }
-  
-  // Generar nuevo paso de diagnóstico solo si:
-  // - El usuario hizo clic en "BTN_PERSIST" (sigue igual)
-  // - Es el primer paso (no hay pasos ejecutados)
-  // Si no hay botón y ya hay pasos, mostrar el último paso nuevamente
-  if (!buttonToken && executedSteps.length > 0) {
-    // Si no hay botón y ya hay pasos, mostrar el último paso
-    const lastTurn = history[history.length - 1];
-    if (lastTurn && lastTurn.bot_reply && turn.stage_after === 'DIAGNOSTIC_STEP') {
-      return {
-        reply: lastTurn.bot_reply,
-        stage: 'DIAGNOSTIC_STEP',
-        buttons: lastTurn.buttons_shown || []
-      };
-    }
-  }
-  
-  // Si no hay pasos ejecutados (primer acceso a DIAGNOSTIC_STEP), generar el primer paso automáticamente
-  // incluso si no hay buttonToken (el usuario acaba de entrar a este stage)
-  if (executedSteps.length === 0) {
-    console.log(`[DIAGNOSTIC_STEP] [${sessionId}] Primer acceso, generando primer paso automáticamente`);
-    // Continuar con la generación del paso (el código más abajo lo hará)
-  } else if (executedSteps.length > 0 && buttonToken !== 'BTN_PERSIST') {
-    // Si ya hay pasos y no es "BTN_PERSIST", mostrar el último paso
-    const lastTurn = history[history.length - 1];
-    const lastReply = lastTurn?.bot_reply || '';
-    
-    // NUNCA retornar reply vacío
-    if (!lastReply || lastReply.trim() === '') {
-      console.warn(`[DIAGNOSTIC_STEP] [${sessionId}] ⚠️ Last turn reply vacío, usando fallback`);
-      return {
-        reply: isEn
-          ? 'Please continue with the previous step.'
-          : 'Por favor, continuá con el paso anterior.',
-        stage: 'DIAGNOSTIC_STEP',
-        buttons: lastTurn?.buttons_shown || []
-      };
-    }
-    
-    return {
-      reply: lastReply,
-      stage: 'DIAGNOSTIC_STEP',
-      buttons: lastTurn?.buttons_shown || []
-    };
-  }
-  
-  if (openai) {
-    try {
-      // Construir contexto del problema
-      const problemContext = session.problem_raw || '';
-      const deviceContext = session.device_type ? `Device: ${session.device_type}` : '';
-      const osContext = session.os ? `OS: ${session.os}` : '';
-      const stepsContext = executedSteps.length > 0
-        ? `Previous steps executed: ${executedSteps.map(s => s.action).join(', ')}`
-        : 'No previous steps';
-      
-      const levelContext = userLevel === 'basic'
-        ? (isEn ? 'Use very simple language, step by step.' : 'Usá lenguaje muy simple, paso a paso.')
-        : userLevel === 'advanced'
-          ? (isEn ? 'Be technical and precise.' : 'Sé técnico y preciso.')
-          : (isEn ? 'Use common technical terms.' : 'Usá términos técnicos comunes.');
-      
-      const stepNumber = basicSteps < maxBasicSteps ? basicSteps + 1 : advancedSteps + 1 + maxBasicSteps;
-      const isBasicStep = stepNumber <= maxBasicSteps;
-      
-      const diagnosticPrompt = isEn
-        ? `You are Tecnos, an IT support assistant. The user has this problem: "${problemContext}". ${deviceContext} ${osContext}. ${stepsContext}
-
-Generate the next diagnostic step (step ${stepNumber}, ${isBasicStep ? 'basic' : 'advanced'}). ${levelContext}
-
-Return a JSON object with:
-- action: string (one single action the user should perform, e.g. "Press Ctrl+Alt+Del" or "Check if the power LED is on")
-- explanation: string (brief explanation of why this step is needed, adapted to user level)
-
-Return ONLY valid JSON, no other text.`
-        : `Sos Tecnos, asistente de soporte técnico. El usuario tiene este problema: "${problemContext}". ${deviceContext} ${osContext}. ${stepsContext}
-
-Generá el siguiente paso de diagnóstico (paso ${stepNumber}, ${isBasicStep ? 'básico' : 'avanzado'}). ${levelContext}
-
-Devolvé un objeto JSON con:
-- action: string (una sola acción que el usuario debe realizar, ej. "Presioná Ctrl+Alt+Del" o "Verificá si el LED de encendido está prendido")
-- explanation: string (breve explicación de por qué este paso es necesario, adaptada al nivel del usuario)
-
-Devolvé SOLO JSON válido, sin otro texto.`;
-      
-      const openaiPromise = openai.chat.completions.create({
-        model: OPENAI_MODEL,
-        messages: [
-          { role: 'system', content: 'You are Tecnos, an IT support assistant. Return only valid JSON.' },
-          { role: 'user', content: diagnosticPrompt }
-        ],
-        temperature: 0.7,
-        max_tokens: 300
-      });
-      
-      console.log(`[DIAGNOSTIC_STEP] [${sessionId}] Llamando a OpenAI con timeout 12s para generar paso ${stepNumber}`);
-      const completion = await withTimeout(openaiPromise, 12000, 'OpenAI timeout');
-      
-      const stepText = completion.choices[0]?.message?.content || '{}';
-      let stepData;
-      try {
-        stepData = JSON.parse(stepText.trim());
-      } catch (parseErr) {
-        console.error(`[DIAGNOSTIC_STEP] [${sessionId}] Error parseando JSON de OpenAI:`, parseErr);
-        stepData = { action: '', explanation: '' }; // Fallback seguro
-      }
-      
-      const stepId = `step_${stepNumber}_${Date.now()}`;
-      const action = stepData.action || '';
-      const explanation = stepData.explanation || '';
-      
-      // Construir mensaje completo - NUNCA vacío
-      let reply = '';
-      if (action && explanation) {
-        reply = `${action}\n\n${explanation}`;
-      } else if (action) {
-        reply = action;
-      } else if (explanation) {
-        reply = explanation;
-      } else {
-        // Fallback si ambos están vacíos
-        console.warn(`[DIAGNOSTIC_STEP] [${sessionId}] ⚠️ Action y explanation vacíos, usando fallback`);
-        reply = isEn
-          ? 'Let me guide you through this step by step.'
-          : 'Déjame guiarte paso a paso.';
-      }
-      
-      // Botones del paso: resultado + ayuda + volver
-      const contract = getStageContract('DIAGNOSTIC_STEP');
-      const buttons = [
-        { token: 'BTN_SOLVED', label: BUTTON_CATALOG['BTN_SOLVED'].label[locale], order: 1 },
-        { token: 'BTN_PERSIST', label: BUTTON_CATALOG['BTN_PERSIST'].label[locale], order: 2 },
-        { token: 'BTN_HELP_CONTEXT', label: BUTTON_CATALOG['BTN_HELP_CONTEXT'].label[locale], order: 3 }
-      ];
-      
-      // Solo agregar "Volver" si hay pasos anteriores
-      if (executedSteps.length > 0) {
-        buttons.push({ token: 'BTN_BACK', label: BUTTON_CATALOG['BTN_BACK'].label[locale], order: 4 });
-      }
-      
-      return {
-        reply,
-        stage: 'DIAGNOSTIC_STEP',
-        buttons,
-        diagnostic_step: {
-          step_id: stepId,
-          step_number: stepNumber,
-          action,
-          explanation,
-          is_basic: isBasicStep
-        }
-      };
-      
-    } catch (err) {
-      const isTimeout = err.message && err.message.includes('timeout');
-      console.error(`[DIAGNOSTIC_STEP] [${sessionId}] Error OpenAI${isTimeout ? ' (TIMEOUT)' : ''}:`, err.message);
-      // Fallback seguro
-      return {
-        reply: isEn
-          ? 'I need more information. Could you describe the problem again?'
-          : 'Necesito más información. ¿Podrías describir el problema nuevamente?',
-        stage: 'DIAGNOSTIC_STEP',
-        buttons: []
-      };
-    }
-  }
-  
-  // Sin OpenAI: fallback
-  return {
-    reply: isEn
-      ? 'I need more information. Could you describe the problem again?'
-      : 'Necesito más información. ¿Podrías describir el problema nuevamente?',
-    stage: 'DIAGNOSTIC_STEP',
-    buttons: []
-  };
+  const intent = session.intent || 'unknown';
+  const deviceType = session.device_type || 'unknown';
+  
+  // Inicializar estado de diagnóstico si no existe
+  if (!session.diagnostic) {
+    session.diagnostic = {
+      step: 1,
+      path: `${intent}:${deviceType}`,
+      data: {}
+    };
+  }
+  
+  const currentStep = session.diagnostic.step;
+  const diagnosticPath = session.diagnostic.path;
+  
+  console.log(`[DIAGNOSTIC_STEP] [${sessionId}] step=${currentStep} path=${diagnosticPath} selected=${buttonToken || 'null'}`);
+  
+  // Manejar botones de resultado final
+  if (buttonToken === 'BTN_SOLVED') {
+    const contract = getStageContract('FEEDBACK_REQUIRED');
+    return {
+      reply: isEn
+        ? 'Great! I\'m glad it worked. Did this help you?'
+        : '¡Genial! Me alegra que haya funcionado. ¿Te sirvió esta ayuda?',
+      stage: 'FEEDBACK_REQUIRED',
+      buttons: contract.defaultButtons
+    };
+  }
+  
+  // Implementación de pasos para wont_turn_on + desktop + basic
+  if (intent === 'wont_turn_on' && deviceType === 'desktop' && userLevel === 'basic') {
+    // PASO 1: Pregunta inicial sobre síntomas de encendido
+    if (currentStep === 1 && !buttonToken) {
+      const buttons = [
+        { token: 'BTN_PWR_NO_SIGNS', label: BUTTON_CATALOG['BTN_PWR_NO_SIGNS'].label[locale], order: 1 },
+        { token: 'BTN_PWR_FANS', label: BUTTON_CATALOG['BTN_PWR_FANS'].label[locale], order: 2 },
+        { token: 'BTN_PWR_BEEPS', label: BUTTON_CATALOG['BTN_PWR_BEEPS'].label[locale], order: 3 },
+        { token: 'BTN_PWR_ON_OFF', label: BUTTON_CATALOG['BTN_PWR_ON_OFF'].label[locale], order: 4 }
+      ];
+      
+      return {
+        reply: isEn
+          ? 'When you press the power button, what happens?'
+          : 'Cuando apretás el botón de encendido, ¿qué pasa?',
+        stage: 'DIAGNOSTIC_STEP',
+        buttons
+      };
+    }
+    
+    // PASO 2: Ramificación según síntoma seleccionado
+    if (currentStep === 1 && buttonToken && buttonToken.startsWith('BTN_PWR_')) {
+      // Guardar selección
+      session.diagnostic.data.power_symptom = buttonToken;
+      session.diagnostic.step = 2;
+      
+      let reply = '';
+      let buttons = [];
+      
+      if (buttonToken === 'BTN_PWR_NO_SIGNS') {
+        // Sin señales: revisar alimentación/cable/fuente
+        reply = isEn
+          ? 'No signs of power usually means a problem with the power supply or cable. Let\'s check:\n\n1. Check if the power cable is properly connected to the PC and the wall outlet.\n2. Try a different power outlet.\n3. Check if the power supply switch (if it has one) is in the ON position.'
+          : 'Sin señales de encendido suele ser un problema con la alimentación o el cable. Revisemos:\n\n1. Verificá que el cable de alimentación esté bien conectado a la PC y al enchufe.\n2. Probá con otro enchufe.\n3. Verificá si la fuente tiene un interruptor y que esté en ON.';
+        
+        buttons = [
+          { token: 'BTN_STEP_DONE', label: BUTTON_CATALOG['BTN_STEP_DONE'].label[locale], order: 1 },
+          { token: 'BTN_STEP_STILL', label: BUTTON_CATALOG['BTN_STEP_STILL'].label[locale], order: 2 },
+          { token: 'BTN_STEP_HELP', label: BUTTON_CATALOG['BTN_STEP_HELP'].label[locale], order: 3 }
+        ];
+      } else if (buttonToken === 'BTN_PWR_FANS' || buttonToken === 'BTN_PWR_BEEPS') {
+        // Luces/ventilador o pitidos: revisar POST/RAM/monitor/cables
+        reply = isEn
+          ? 'Good, there\'s some power. Now let\'s check:\n\n1. Check if the monitor is on and connected.\n2. Check if the RAM memory modules are properly seated (if you feel comfortable opening the PC).\n3. Try disconnecting and reconnecting all cables.'
+          : 'Bien, hay algo de energía. Ahora revisemos:\n\n1. Verificá que el monitor esté prendido y conectado.\n2. Verificá que los módulos de memoria RAM estén bien colocados (si te sentís cómodo abriendo la PC).\n3. Probá desconectar y volver a conectar todos los cables.';
+        
+        buttons = [
+          { token: 'BTN_STEP_DONE', label: BUTTON_CATALOG['BTN_STEP_DONE'].label[locale], order: 1 },
+          { token: 'BTN_STEP_STILL', label: BUTTON_CATALOG['BTN_STEP_STILL'].label[locale], order: 2 },
+          { token: 'BTN_STEP_HELP', label: BUTTON_CATALOG['BTN_STEP_HELP'].label[locale], order: 3 }
+        ];
+      } else if (buttonToken === 'BTN_PWR_ON_OFF') {
+        // Enciende y se apaga: revisar temperatura/sobrecarga
+        reply = isEn
+          ? 'If it turns on and off immediately, it could be overheating or a power issue. Let\'s check:\n\n1. Make sure the PC is not overheating (check if fans are working).\n2. Try disconnecting non-essential devices (USB, external drives).\n3. Check if the power supply is adequate for your components.'
+          : 'Si enciende y se apaga enseguida, puede ser sobrecalentamiento o problema de alimentación. Revisemos:\n\n1. Asegurate de que la PC no se esté sobrecalentando (verificá que los ventiladores funcionen).\n2. Probá desconectar dispositivos no esenciales (USB, discos externos).\n3. Verificá que la fuente de alimentación sea adecuada para tus componentes.';
+        
+        buttons = [
+          { token: 'BTN_STEP_DONE', label: BUTTON_CATALOG['BTN_STEP_DONE'].label[locale], order: 1 },
+          { token: 'BTN_STEP_STILL', label: BUTTON_CATALOG['BTN_STEP_STILL'].label[locale], order: 2 },
+          { token: 'BTN_STEP_HELP', label: BUTTON_CATALOG['BTN_STEP_HELP'].label[locale], order: 3 }
+        ];
+      }
+      
+      return {
+        reply,
+        stage: 'DIAGNOSTIC_STEP',
+        buttons
+      };
+    }
+    
+    // PASO 3+: Manejar botones de resultado de paso
+    if (currentStep >= 2 && buttonToken && buttonToken.startsWith('BTN_STEP_')) {
+      if (buttonToken === 'BTN_STEP_DONE') {
+        // Usuario probó el paso, avanzar o resolver
+        session.diagnostic.step = currentStep + 1;
+        // Por ahora, si resuelve en paso 2, pedir feedback
+        const contract = getStageContract('FEEDBACK_REQUIRED');
+        return {
+          reply: isEn
+            ? 'Great! Did this solve the problem?'
+            : '¡Genial! ¿Esto resolvió el problema?',
+          stage: 'FEEDBACK_REQUIRED',
+          buttons: contract.defaultButtons
+        };
+      } else if (buttonToken === 'BTN_STEP_STILL') {
+        // Sigue igual, contar intentos y recomendar técnico si es necesario
+        const stillCount = (session.diagnostic.data.still_count || 0) + 1;
+        session.diagnostic.data.still_count = stillCount;
+        
+        if (stillCount >= 2) {
+          const contract = getStageContract('FEEDBACK_REQUIRED');
+          return {
+            reply: isEn
+              ? 'I understand the problem persists. I recommend talking to a technician for a more detailed diagnosis. Was this session helpful?'
+              : 'Entiendo que el problema persiste. Te recomiendo hablar con un técnico para un diagnóstico más detallado. ¿Te sirvió esta ayuda?',
+            stage: 'FEEDBACK_REQUIRED',
+            buttons: contract.defaultButtons
+          };
+        }
+        
+        // Continuar con otro paso
+        session.diagnostic.step = currentStep + 1;
+        return {
+          reply: isEn
+            ? 'Let\'s try another approach. Check the power supply connections inside the PC (if you feel comfortable). Make sure all internal cables are properly connected.'
+            : 'Probemos otro enfoque. Revisá las conexiones de la fuente dentro de la PC (si te sentís cómodo). Asegurate de que todos los cables internos estén bien conectados.',
+          stage: 'DIAGNOSTIC_STEP',
+          buttons: [
+            { token: 'BTN_STEP_DONE', label: BUTTON_CATALOG['BTN_STEP_DONE'].label[locale], order: 1 },
+            { token: 'BTN_STEP_STILL', label: BUTTON_CATALOG['BTN_STEP_STILL'].label[locale], order: 2 },
+            { token: 'BTN_STEP_HELP', label: BUTTON_CATALOG['BTN_STEP_HELP'].label[locale], order: 3 }
+          ]
+        };
+      } else if (buttonToken === 'BTN_STEP_HELP') {
+        // Usuario necesita ayuda, ofrecer técnico
+        const contract = getStageContract('FEEDBACK_REQUIRED');
+        return {
+          reply: isEn
+            ? 'I understand you need more help. I recommend talking to a technician. Was this session helpful?'
+            : 'Entiendo que necesitás más ayuda. Te recomiendo hablar con un técnico. ¿Te sirvió esta ayuda?',
+          stage: 'FEEDBACK_REQUIRED',
+          buttons: contract.defaultButtons
+        };
+      }
+    }
+  }
+  
+  // Fallback para otros intents/device_types/user_levels (por ahora)
+  return {
+    reply: isEn
+      ? 'I\'m working on expanding diagnostic support for this type of problem. For now, I recommend talking to a technician.'
+      : 'Estoy trabajando en expandir el soporte de diagnóstico para este tipo de problema. Por ahora, te recomiendo hablar con un técnico.',
+    stage: 'DIAGNOSTIC_STEP',
+    buttons: [
+      { token: 'BTN_CONNECT_TECH', label: BUTTON_CATALOG['BTN_CONNECT_TECH'].label[locale], order: 1 }
+    ]
+  };
 }
 
 // Handler para feedback obligatorio

