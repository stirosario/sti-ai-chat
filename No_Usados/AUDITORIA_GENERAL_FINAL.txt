================================================================================
AUDITOR√çA INTEGRAL - ECOSISTEMA CHAT TECNOS
Modo: SOLO LECTURA (CERO CAMBIOS)
Fecha: 2025-01-XX
================================================================================

RESUMEN EJECUTIVO
================================================================================

Estado General: FUNCIONAL CON √ÅREAS DE MEJORA
- Backend: Estructura s√≥lida, guard rails implementados, rate limits activos
- Frontend: Normalizaci√≥n de botones funcional, mapeo de tokens correcto
- Simulaciones: Sistema aislado con guard rails consistentes
- Flujos recientes: ASK_USER_LEVEL y feedback binario implementados correctamente

Top 10 Hallazgos Cr√≠ticos:
1. [ALTO] Validaci√≥n de faltanDatosMinimos() no se aplica consistentemente antes de mostrar pasos
2. [MEDIO] Posible exposici√≥n de tokens internos si usuario escribe token manualmente
3. [MEDIO] Repetici√≥n de frases de cierre puede causar fatiga UX
4. [BAJO] Algunos mensajes de error podr√≠an ser m√°s espec√≠ficos
5. [BAJO] Logs de simulaciones podr√≠an incluir m√°s contexto de errores
6. [NICE] LABEL_MAP en frontend podr√≠a estar incompleto para todos los tokens
7. [NICE] Documentaci√≥n JSDoc faltante en algunas funciones helper
8. [NICE] Timeout de OpenAI podr√≠a tener fallback m√°s robusto
9. [NICE] Validaci√≥n de tama√±o de entrada podr√≠a ser m√°s granular
10. [NICE] M√©tricas de telemetr√≠a podr√≠an incluir m√°s detalles

CHECKLIST POR SECCIONES
================================================================================

1. BACKEND PRINCIPAL (server.js)
-------------------------------------------------------------------------------
‚úÖ CUMPLE:
- Endpoints principales funcionando (/api/chat, /api/greeting, /api/simulations/run)
- Routing por stage implementado y coherente
- Manejo de sesiones con persistencia en archivos
- Guard rails de simulaci√≥n activos (SIMULATION_GUARD)
- Rate limits configurados (chat: 50/5min, simulations: 10/hora, sesiones: 20/15min)
- TTL de sesiones implementado (30 minutos inactividad)
- Logs estructurados con pino
- Validaciones de userText centralizadas (validateUserText)
- Timeouts de OpenAI configurados (30s)
- i18n soportado (es-AR / en-US)

‚ö†Ô∏è PARCIAL:
- faltanDatosMinimos() existe pero no se verifica consistentemente antes de mostrar pasos
- Algunos handlers podr√≠an tener mejor manejo de edge cases
- Validaci√≥n de transiciones de stage podr√≠a ser m√°s estricta

‚ùå NO CUMPLE:
- (Ninguno cr√≠tico detectado)

2. FRONTEND Y COMPATIBILIDAD (index.php)
-------------------------------------------------------------------------------
‚úÖ CUMPLE:
- normalizeButtons() mapea tokens a labels correctamente
- renderButtons() muestra solo texto descriptivo, no tokens
- sendButton() env√≠a correctamente buttonToken al backend
- LABEL_MAP incluye tokens principales
- Manejo de texto libre funcional
- Compatibilidad con formato de botones del backend

‚ö†Ô∏è PARCIAL:
- LABEL_MAP podr√≠a no cubrir todos los tokens posibles (ej: BTN_USER_LEVEL_*)
- Si usuario escribe token manualmente (ej: "BTN_SOLVED"), podr√≠a no mapearse correctamente
- Normalizaci√≥n de texto libre podr√≠a ser m√°s robusta para variantes

‚ùå NO CUMPLE:
- (Ninguno cr√≠tico detectado)

3. SIMULACIONES / ADMIN (admin.php, simulation-engine.js)
-------------------------------------------------------------------------------
‚úÖ CUMPLE:
- simulation-engine.js genera datos realistas
- Guard rails activos: no tickets reales, no WhatsApp, no m√©tricas productivas
- Logs de simulaciones con summary legible
- Endpoints de simulaciones con autenticaci√≥n (ADMIN_TOKEN)
- Rate limit en /api/simulations/run (10/hora)
- Aislamiento de sesiones de simulaci√≥n (prefijo SIM_)

‚ö†Ô∏è PARCIAL:
- Logs podr√≠an incluir m√°s contexto sobre errores detectados
- Vista de simulaciones en admin.php podr√≠a mostrar m√°s detalles

‚ùå NO CUMPLE:
- (Ninguno cr√≠tico detectado)

4. FLUJOS RECIENTES
-------------------------------------------------------------------------------
A) Captura de nombre ‚Üí ASK_USER_LEVEL ‚Üí ASK_NEED
‚úÖ CUMPLE:
- Paso ASK_USER_LEVEL aparece despu√©s de ASK_NAME
- Se salta correctamente si userLevel ya existe en sesi√≥n
- Routing respetado: ASK_NAME ‚Üí ASK_USER_LEVEL ‚Üí ASK_NEED
- Soporte ES/EN correcto
- Botones de nivel muestran texto descriptivo, no tokens

‚ö†Ô∏è PARCIAL:
- Si usuario escribe "b√°sico" en texto libre, se mapea correctamente
- Si usuario escribe "BTN_USER_LEVEL_BASIC" manualmente, podr√≠a no funcionar

B) Feedback binario (üëç / üëé)
‚úÖ CUMPLE:
- Aparece despu√©s de BTN_SOLVED
- Aparece antes del cierre cuando usuario presiona BTN_CLOSE
- No se duplica (flags feedbackRecorded y feedbackButtonsShown)
- Texto libre despu√©s de mostrar feedback re-muestra botones (CASO 6B)
- Guard rail de simulaci√≥n activo (no guarda feedback en modo simulaci√≥n)

‚ùå NO CUMPLE:
- (Ninguno detectado)

C) Guard rails y aislamiento
‚úÖ CUMPLE:
- session.simulation === true detectado correctamente
- No tickets reales en simulaciones (createTicketAndRespond verifica)
- No WhatsApp real (guard rails activos)
- No m√©tricas productivas (pushBasicTestTelemetry verifica)
- Logs con prefijo [SIMULATION_GUARD] consistentes
- Prefijo SIM_ en sessionId de simulaciones

‚ùå NO CUMPLE:
- (Ninguno detectado)

D) Rate limits, timeouts, seguridad
‚úÖ CUMPLE:
- Rate limit /api/chat: 50/5min por IP
- Rate limit /api/simulations/run: 10/hora por IP
- Rate limit creaci√≥n de sesiones: 20/15min por IP
- Rate limit uploads: 3/min por IP+Session
- Timeout OpenAI: 30s configurado
- Validaci√≥n userText: m√°ximo 5000 caracteres
- Autenticaci√≥n admin en endpoints sensibles (ADMIN_TOKEN)

‚ö†Ô∏è PARCIAL:
- Timeout de OpenAI tiene fallback gen√©rico, podr√≠a ser m√°s espec√≠fico
- Validaci√≥n de tama√±o podr√≠a ser m√°s granular por tipo de contenido

E) "No repetir palabras cruciales" / UX fatigue
‚ö†Ô∏è PARCIAL:
- Existe l√≥gica para evitar repetir bloques (registerFlowShown, checkBlockRepetition)
- Existe shouldExplainStep() para evitar repetir explicaciones
- Sin embargo, frases de cierre pueden repetirse si usuario vuelve a interactuar
- Mensajes de celebraci√≥n pueden ser similares en m√∫ltiples ocasiones

‚ùå NO CUMPLE:
- No hay umbrales definidos para "repetici√≥n excesiva"
- No hay tracking de frases ya mostradas al usuario

F) Botones: mostrar texto descriptivo, nunca c√≥digos
‚úÖ CUMPLE:
- normalizeButtons() mapea tokens a labels
- renderButtons() muestra solo btn.label o btn.text
- LABEL_MAP incluye tokens principales
- Backend env√≠a botones con text y value separados

‚ö†Ô∏è PARCIAL:
- Si usuario escribe token manualmente (ej: "BTN_SOLVED"), backend lo interpreta pero frontend podr√≠a no mostrarlo correctamente en transcript
- Transcript podr√≠a mostrar value en lugar de label en algunos casos

G) Detecci√≥n de dispositivo y OS antes de dar pruebas
‚ö†Ô∏è PARCIAL:
- faltanDatosMinimos() existe y funciona correctamente
- Verifica hasOS, hasPeripheralType seg√∫n caseType
- Sin embargo, no se llama consistentemente antes de mostrar pasos en todos los handlers
- Algunos handlers podr√≠an mostrar pasos sin verificar datos m√≠nimos

‚ùå NO CUMPLE:
- Validaci√≥n de faltanDatosMinimos() no es obligatoria antes de mostrar pasos en todos los casos

H) Entradas manuales vs botones
‚úÖ CUMPLE:
- Backend mapea texto libre a opciones cuando es posible
- Regex para detectar variantes (ej: /b√°sico|basic/i)
- Respuestas aclaratorias cuando no se entiende
- Soporte para may√∫sculas/min√∫sculas, typos leves

‚ö†Ô∏è PARCIAL:
- Mapeo de texto libre podr√≠a ser m√°s robusto para variantes
- Algunos tokens escritos manualmente podr√≠an no mapearse

I) Mandamientos / reglas de flujo
‚úÖ CUMPLE:
- Estados definidos en STATES
- Transiciones v√°lidas en VALID_TRANSITIONS
- Routing respeta transiciones
- Handlers verifican transiciones antes de cambiar stage

‚ö†Ô∏è PARCIAL:
- Algunas transiciones podr√≠an ser m√°s estrictas
- Validaci√≥n de transiciones podr√≠a ser m√°s expl√≠cita en algunos handlers

HALLAZGOS CON SEVERIDAD
================================================================================

CR√çTICO
-------------------------------------------------------------------------------
(Ninguno detectado en modo solo lectura)

ALTO
-------------------------------------------------------------------------------
HALLAZGO #1: faltanDatosMinimos() no se aplica consistentemente
Archivo: server.js
Ubicaci√≥n: L√≠neas ~4950-5055 (funci√≥n), ~6110+ (uso)
Severidad: ALTO
Impacto: Usuario podr√≠a recibir pasos sin tener datos m√≠nimos necesarios (OS, tipo de perif√©rico)
Riesgo: Pasos inaplicables o confusos para el usuario
Evidencia:
- Funci√≥n faltanDatosMinimos() existe y funciona correctamente
- Se usa en algunos handlers (ej: l√≠nea ~6110 en BASIC_TESTS)
- No se verifica en todos los lugares donde se muestran pasos
- Algunos handlers podr√≠an mostrar pasos sin verificar contextMinima
C√≥mo detectarlo:
- Buscar todos los lugares donde se muestran pasos (buildUiButtonsFromTokens, mostrar pasos)
- Verificar que todos llamen a faltanDatosMinimos() antes
- Revisar logs de conversaciones donde se muestran pasos sin datos m√≠nimos
C√≥mo reproducirlo:
1. Iniciar conversaci√≥n
2. Llegar a BASIC_TESTS sin haber especificado OS
3. Verificar si se muestran pasos espec√≠ficos de OS sin haber preguntado
Recomendaci√≥n m√≠nima:
- Agregar verificaci√≥n obligatoria de faltanDatosMinimos() antes de mostrar >2 pasos
- Documentar en cada handler que muestra pasos la necesidad de verificar datos m√≠nimos

HALLAZGO #2: Posible exposici√≥n de tokens si usuario escribe manualmente
Archivo: index.php, server.js
Ubicaci√≥n: index.php l√≠nea ~1707+ (normalizeButtons), server.js l√≠nea ~10788+ (mapeo)
Severidad: ALTO
Impacto: Si usuario escribe "BTN_SOLVED" manualmente, podr√≠a aparecer en transcript o no mapearse correctamente
Riesgo: Confusi√≥n del usuario, posible bypass de validaciones
Evidencia:
- normalizeButtons() mapea tokens a labels cuando vienen del backend
- Si usuario escribe token manualmente, backend lo procesa pero frontend podr√≠a mostrarlo crudo
- Transcript podr√≠a mostrar value en lugar de label
C√≥mo detectarlo:
- Probar escribiendo tokens manualmente (ej: "BTN_SOLVED", "BTN_USER_LEVEL_BASIC")
- Verificar transcript en admin.php
- Verificar que frontend siempre muestre label, nunca value
C√≥mo reproducirlo:
1. Escribir "BTN_SOLVED" en lugar de presionar bot√≥n
2. Verificar transcript
3. Verificar que se muestre label, no token
Recomendaci√≥n m√≠nima:
- Normalizar texto del usuario antes de agregar a transcript
- Asegurar que frontend siempre muestre label, nunca value crudo
- Agregar mapeo inverso (token ‚Üí label) para texto libre del usuario

MEDIO
-------------------------------------------------------------------------------
HALLAZGO #3: Repetici√≥n de frases puede causar fatiga UX
Archivo: server.js
Ubicaci√≥n: M√∫ltiples handlers (ASK_NEED, BASIC_TESTS, feedback, etc.)
Severidad: MEDIO
Impacto: Usuario puede ver las mismas frases m√∫ltiples veces en una conversaci√≥n
Riesgo: Fatiga del usuario, percepci√≥n de sistema "rob√≥tico"
Evidencia:
- Frases de cierre similares en m√∫ltiples lugares
- Mensajes de celebraci√≥n pueden repetirse
- No hay tracking de frases ya mostradas al usuario
- registerFlowShown() previene repetir bloques, pero no frases individuales
C√≥mo detectarlo:
- Revisar logs de conversaciones completas
- Buscar frases repetidas en transcript
- Contar ocurrencias de frases clave (ej: "Gracias por usar Tecnos")
C√≥mo reproducirlo:
1. Completar conversaci√≥n hasta BTN_SOLVED
2. Volver a interactuar despu√©s de cerrar
3. Verificar si aparecen las mismas frases
Recomendaci√≥n m√≠nima:
- Definir umbrales de repetici√≥n (ej: no repetir misma frase en <5 turnos)
- Agregar tracking de frases mostradas en session.progress
- Variar mensajes cuando sea posible (templates con variantes)

HALLAZGO #4: LABEL_MAP podr√≠a estar incompleto
Archivo: index.php
Ubicaci√≥n: L√≠nea ~1722+ (LABEL_MAP)
Severidad: MEDIO
Impacto: Si backend env√≠a token nuevo no mapeado, frontend mostrar√≠a token crudo
Riesgo: Usuario ve c√≥digo t√©cnico en lugar de texto descriptivo
Evidencia:
- LABEL_MAP incluye tokens principales pero podr√≠a no cubrir todos
- Tokens nuevos como BTN_USER_LEVEL_* podr√≠an no estar mapeados
- Si token no est√° en LABEL_MAP, normalizeButtons() usa el token como label
C√≥mo detectarlo:
- Comparar tokens usados en backend (server.js l√≠nea ~2956+) con LABEL_MAP en frontend
- Probar con tokens nuevos
- Verificar que todos los tokens tengan label descriptivo
C√≥mo reproducirlo:
1. Backend env√≠a bot√≥n con token nuevo no mapeado
2. Frontend renderiza bot√≥n
3. Verificar que se muestre label, no token
Recomendaci√≥n m√≠nima:
- Sincronizar LABEL_MAP con tokens del backend
- Agregar fallback m√°s robusto (ej: generar label desde token)
- Documentar proceso para agregar nuevos tokens

HALLAZGO #5: Timeout de OpenAI tiene fallback gen√©rico
Archivo: server.js
Ubicaci√≥n: L√≠nea ~268+ (config), ~6980+ (manejo de error)
Severidad: MEDIO
Impacto: Si OpenAI timeout, usuario recibe mensaje gen√©rico en lugar de respuesta contextual
Riesgo: P√©rdida de contexto, usuario podr√≠a pensar que el sistema fall√≥
Evidencia:
- Timeout configurado a 30s (correcto)
- Manejo de error existe pero fallback es gen√©rico
- No hay respuesta contextual basada en el stage actual
C√≥mo detectarlo:
- Simular timeout de OpenAI (mock o desconectar)
- Verificar respuesta al usuario
- Verificar que respuesta sea contextual al stage
C√≥mo reproducirlo:
1. Forzar timeout de OpenAI (mock o delay artificial)
2. Verificar respuesta al usuario
3. Verificar que sea contextual, no gen√©rico
Recomendaci√≥n m√≠nima:
- Agregar fallbacks contextuales por stage
- Mantener contexto de la conversaci√≥n en fallback
- Loggear timeout para an√°lisis posterior

BAJO
-------------------------------------------------------------------------------
HALLAZGO #6: Algunos mensajes de error podr√≠an ser m√°s espec√≠ficos
Archivo: server.js
Ubicaci√≥n: M√∫ltiples catch blocks
Severidad: BAJO
Impacto: Usuario recibe mensaje gen√©rico cuando podr√≠a ser m√°s espec√≠fico
Riesgo: Menor, pero afecta UX
Evidencia:
- Algunos catch blocks tienen mensajes gen√©ricos
- F3-T02 mejor√≥ muchos mensajes, pero algunos podr√≠an ser m√°s espec√≠ficos
C√≥mo detectarlo:
- Revisar todos los catch blocks
- Verificar que mensajes sean espec√≠ficos y accionables
C√≥mo reproducirlo:
- Forzar errores en diferentes stages
- Verificar mensajes al usuario
Recomendaci√≥n m√≠nima:
- Revisar mensajes de error restantes
- Agregar contexto espec√≠fico cuando sea posible

HALLAZGO #7: Logs de simulaciones podr√≠an incluir m√°s contexto
Archivo: simulation-engine.js
Ubicaci√≥n: L√≠nea ~699+ (result), ~763+ (saveLog)
Severidad: BAJO
Impacto: An√°lisis de errores en simulaciones podr√≠a ser m√°s dif√≠cil
Riesgo: Menor, pero afecta debugging
Evidencia:
- Summary legible existe (F3-T06)
- Pero algunos errores podr√≠an tener m√°s contexto
- Top3Errores es √∫til pero podr√≠a incluir m√°s detalles
C√≥mo detectarlo:
- Ejecutar simulaciones con errores
- Revisar logs generados
- Verificar que contexto sea suficiente para debugging
Recomendaci√≥n m√≠nima:
- Agregar m√°s contexto a errores cr√≠ticos
- Incluir stack trace cuando sea relevante
- Agregar contexto de sesi√≥n en errores

NICE TO HAVE
-------------------------------------------------------------------------------
HALLAZGO #8: Documentaci√≥n JSDoc faltante en algunas funciones
Archivo: server.js
Ubicaci√≥n: M√∫ltiples funciones helper
Severidad: NICE TO HAVE
Impacto: Desarrollo futuro podr√≠a ser m√°s lento
Riesgo: Muy bajo
Evidencia:
- Muchas funciones tienen JSDoc completo
- Algunas funciones helper podr√≠an tener m√°s documentaci√≥n
- F3-T03 identific√≥ esto pero requiere auditor√≠a manual
Recomendaci√≥n m√≠nima:
- Auditor√≠a manual de funciones p√∫blicas
- Agregar JSDoc donde falte

HALLAZGO #9: Validaci√≥n de tama√±o podr√≠a ser m√°s granular
Archivo: server.js
Ubicaci√≥n: L√≠nea ~10664+ (validateUserText)
Severidad: NICE TO HAVE
Impacto: Usuario podr√≠a enviar texto muy largo en algunos contextos
Riesgo: Muy bajo (5000 caracteres es razonable)
Evidencia:
- Validaci√≥n centralizada existe (validateUserText)
- L√≠mite de 5000 caracteres es uniforme
- Podr√≠a ser m√°s granular seg√∫n contexto (ej: nombre vs problema)
Recomendaci√≥n m√≠nima:
- Considerar l√≠mites diferentes por tipo de input
- Documentar l√≠mites en mensajes de error

HALLAZGO #10: M√©tricas de telemetr√≠a podr√≠an incluir m√°s detalles
Archivo: server.js
Ubicaci√≥n: pushBasicTestTelemetry, PROBLEM_METRICS
Severidad: NICE TO HAVE
Impacto: An√°lisis de uso podr√≠a ser m√°s rico
Riesgo: Muy bajo
Evidencia:
- Telemetr√≠a b√°sica existe
- PROBLEM_METRICS y STEP_INEFFECTIVE trackean algunos datos
- Podr√≠a incluir m√°s contexto (device, userLevel, etc.)
Recomendaci√≥n m√≠nima:
- Enriquecer m√©tricas con m√°s contexto
- Agregar an√°lisis de patrones de uso

RIESGOS RESIDUALES
================================================================================

1. [ALTO] Usuario podr√≠a recibir pasos inaplicables si faltanDatosMinimos() no se verifica
   - Mitigaci√≥n: Implementar verificaci√≥n obligatoria antes de mostrar pasos
   - Probabilidad: Media
   - Impacto: Alto

2. [MEDIO] Tokens internos podr√≠an aparecer si usuario escribe manualmente
   - Mitigaci√≥n: Normalizar texto del usuario, mapear tokens a labels
   - Probabilidad: Baja
   - Impacto: Medio

3. [MEDIO] Repetici√≥n de frases puede causar fatiga UX
   - Mitigaci√≥n: Tracking de frases mostradas, variar mensajes
   - Probabilidad: Media
   - Impacto: Medio

4. [BAJO] Timeout de OpenAI con fallback gen√©rico
   - Mitigaci√≥n: Fallbacks contextuales por stage
   - Probabilidad: Baja
   - Impacto: Bajo

RECOMENDACIONES M√çNIMAS (SIN IMPLEMENTAR)
================================================================================

PRIORIDAD ALTA:
1. Agregar verificaci√≥n obligatoria de faltanDatosMinimos() antes de mostrar >2 pasos
2. Normalizar texto del usuario para mapear tokens escritos manualmente a labels
3. Sincronizar LABEL_MAP con todos los tokens del backend

PRIORIDAD MEDIA:
4. Implementar tracking de frases mostradas para evitar repetici√≥n excesiva
5. Agregar fallbacks contextuales para timeout de OpenAI
6. Revisar y completar LABEL_MAP con todos los tokens posibles

PRIORIDAD BAJA:
7. Revisar mensajes de error restantes para mayor especificidad
8. Enriquecer logs de simulaciones con m√°s contexto
9. Agregar JSDoc faltante en funciones helper
10. Considerar l√≠mites m√°s granulares para validaci√≥n de tama√±o

COSAS QUE FALTAN AUDITAR (IDEAS EXTRA)
================================================================================

1. Performance: Tiempo de respuesta de endpoints, uso de memoria
2. Escalabilidad: Comportamiento con m√∫ltiples sesiones simult√°neas
3. Resiliencia: Comportamiento ante fallos de Redis, OpenAI, disco
4. Seguridad: Validaci√≥n de CSRF, sanitizaci√≥n de inputs, protecci√≥n XSS
5. Accesibilidad: Compatibilidad con lectores de pantalla, navegaci√≥n por teclado
6. Internacionalizaci√≥n: Cobertura completa de traducciones ES/EN
7. Testing: Cobertura de tests automatizados, casos edge
8. Monitoreo: Alertas, dashboards, m√©tricas en tiempo real
9. Documentaci√≥n: Gu√≠as de usuario, documentaci√≥n t√©cnica completa
10. Backup y recuperaci√≥n: Estrategia de backup de sesiones, transcripts, tickets

================================================================================
FIN DEL REPORTE
================================================================================

