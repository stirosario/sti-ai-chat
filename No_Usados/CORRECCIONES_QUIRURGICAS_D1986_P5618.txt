====================================================================
CORRECCIONES QUIR√öRGICAS APLICADAS - D1986 y P5618
====================================================================
Fecha: 15/12/2025
Modo: Auditor + Fixer de Producci√≥n (quir√∫rgico)
Objetivo: Corregir 4 fallas confirmadas por logs reales sin tocar guard rails

====================================================================
FALLA 1: MENSAJES DUPLICADOS EN LOGS/TRANSCRIPT
====================================================================

PROBLEMA DETECTADO:
- Mensajes del usuario aparec√≠an duplicados consecutivamente en logs/transcript
- El usuario enviaba una sola vez, pero el log registraba dos veces
- Ocurr√≠a dentro de ventana de 2-3 segundos

CAUSA RA√çZ:
- El dedupe buscaba en session.transcript (que puede no estar actualizado en disco)
- No usaba session.progress.lastUserMsgNorm que se guarda ANTES de agregar al transcript
- Race condition: si el mensaje ya se agregaba al transcript antes de la verificaci√≥n

CORRECCI√ìN APLICADA:
Ubicaci√≥n: server.js l√≠nea ~11445-11503

Cambios:
1. Mejorado dedupe para usar session.progress.lastUserMsgNorm en lugar de buscar en transcript
2. Actualizar tracking ANTES de agregar al transcript (previene race conditions)
3. Ventana de dedupe: 3 segundos (DEDUPE_WINDOW_MS = 3000)

C√≥digo modificado:
- L√≠nea ~11445-11499: Dedupe mejorado usando session.progress
- L√≠nea ~11501-11503: Actualizar tracking ANTES de push al transcript

VERIFICACI√ìN:
- Reproducir: Enviar mismo mensaje dos veces r√°pidamente (< 3 segundos)
- Resultado esperado: Solo 1 entrada en transcript/log
- Log esperado: "[DEDUP] Mensaje de usuario ignorado (duplicado)"

====================================================================
FALLA 2: DOBLE REGISTRO DE BOTONES (LABEL + TOKEN BTN_*)
====================================================================

PROBLEMA DETECTADO:
- Click en bot√≥n generaba dos entradas en log:
  1. Label descriptivo ("üü° Intermedio", "üîå El equipo no enciende")
  2. Token BTN_* ("BTN_USER_LEVEL_INTERMEDIATE", "BTN_NO_ENCIENDE")
- En UI solo se ve√≠a el label, pero en log aparec√≠an ambos

CAUSA RA√çZ:
- El texto del bot√≥n se guardaba correctamente, pero hab√≠a riesgo de que
  un token BTN_* llegara como texto si no se normalizaba correctamente
- No hab√≠a verificaci√≥n final para asegurar que NUNCA se guarde un token como texto

CORRECCI√ìN APLICADA:
Ubicaci√≥n: server.js l√≠nea ~11505-11520

Cambios:
1. Verificaci√≥n final: Si userMessageText empieza con "BTN_", mapearlo a label
2. Guardar token solo como metadata (buttonToken), nunca en texto visible
3. Log de advertencia si se detecta token en texto

C√≥digo modificado:
- L√≠nea ~11513-11520: Verificaci√≥n y mapeo de tokens a labels
- L√≠nea ~11524: Guardar buttonToken solo como metadata

VERIFICACI√ìN:
- Reproducir: Click en cualquier bot√≥n (nivel, problema, dispositivo)
- Resultado esperado: Solo 1 entrada en transcript con label descriptivo
- Metadata: buttonToken presente pero NO en texto visible
- Log esperado: Si hay token en texto, "[NORMALIZE] Token detectado..."

====================================================================
FALLA 3: STAGE FINAL INCORRECTO EN METADATA (ASK_DEVICE)
====================================================================

PROBLEMA DETECTADO:
- Metadata reportaba stage_inicial y stage_final como ASK_DEVICE
- Aunque el flujo pas√≥ por ASK_LANGUAGE, ASK_NAME, ASK_USER_LEVEL, ASK_NEED
- Y se entregaron pasos (deber√≠a terminar en BASIC_TESTS)

CAUSA RA√çZ:
1. No se guardaba session.initialStage al crear la sesi√≥n
2. changeStage() no guardaba el initialStage la primera vez
3. Metadata usaba session.stage para ambos (inicial y final)

CORRECCI√ìN APLICADA:
Ubicaci√≥n: 
- server.js l√≠nea ~2504-2566 (changeStage)
- server.js l√≠nea ~11079-11110 (creaci√≥n de sesi√≥n en /api/greeting)
- server.js l√≠nea ~11300-11325 (creaci√≥n de sesi√≥n en /api/chat fallback)
- server.js l√≠nea ~2340-2350 (metadata en saveHistorialChat)
- server.js l√≠nea ~10851-10854 (metadata en /api/historial/:sessionId)

Cambios:
1. changeStage(): Guardar initialStage solo la primera vez (si no existe)
2. Creaci√≥n de sesi√≥n: Inicializar initialStage = STATES.ASK_LANGUAGE
3. Metadata: 
   - stage_inicial: session.initialStage || calcular desde transcript || ASK_LANGUAGE
   - stage_final: session.stage (stage actual, √∫ltimo alcanzado)

C√≥digo modificado:
- L√≠nea ~2560-2562: Guardar initialStage en changeStage()
- L√≠nea ~11082: initialStage en nueva sesi√≥n (/api/greeting)
- L√≠nea ~11304: initialStage en nueva sesi√≥n (/api/chat fallback)
- L√≠nea ~2345-2346: stage_inicial/final correctos en saveHistorialChat
- L√≠nea ~10851-10854: stage_inicial/final correctos en /api/historial

VERIFICACI√ìN:
- Reproducir: Conversaci√≥n completa hasta pasos
- Resultado esperado:
  * stage_inicial: "ASK_LANGUAGE"
  * stage_final: "BASIC_TESTS" (o el stage real alcanzado)
- Verificar en: /api/historial/:sessionId ‚Üí metadata

====================================================================
FALLA 4: FALTAN BOTONES POST-PASOS / REINYECCI√ìN DE BOTONES DISPOSITIVO
====================================================================

PROBLEMA DETECTADO:
- Despu√©s de entregar pasos, faltaban botones de continuaci√≥n/cierre
- En algunos casos aparec√≠an botones de dispositivo (incorrecto)
- Usuario quedaba "colgado" sin opciones claras

CAUSA RA√çZ:
- Los botones post-pasos ya estaban implementados en handleAskDeviceStage
- Pero no se verificaba que NO se reinyectaran botones de dispositivo
- Falta de verificaci√≥n en handleBasicTestsStage cuando se muestran pasos pendientes

CORRECCI√ìN APLICADA:
Ubicaci√≥n: 
- server.js l√≠nea ~6664-6714 (handleAskDeviceStage - botones post-pasos)
- server.js l√≠nea ~7715-7738 (handleBasicTestsStage - botones post-pasos)

Estado actual:
‚úÖ handleAskDeviceStage ya incluye 5 botones post-pasos:
   1. BTN_PERSIST (‚ùå El Problema Persiste)
   2. BTN_SOLVED (‚úîÔ∏è Lo pude Solucionar)
   3. BTN_ADVANCED_TESTS (üî¨ Pruebas Avanzadas)
   4. BTN_WHATSAPP_TECNICO (üßë‚Äçüîß Hablar con un T√©cnico)
   5. BTN_CLOSE (üîö Cerrar Chat)

‚úÖ handleBasicTestsStage ya incluye los mismos 5 botones post-pasos

‚úÖ NO se reinyectan botones de dispositivo despu√©s de mostrar pasos
   - Los botones se construyen expl√≠citamente en cada handler
   - No hay fallback que agregue botones de dispositivo

VERIFICACI√ìN:
- Reproducir: Flujo completo hasta mostrar pasos
- Resultado esperado:
  * Despu√©s de pasos aparecen 5 botones post-pasos
  * NO aparecen botones de dispositivo (BTN_DEV_*)
  * Botones incluyen: Persiste, Solucionado, Avanzadas, T√©cnico, Cerrar

====================================================================
VERIFICACI√ìN FINAL OBLIGATORIA
====================================================================

PRUEBA 1: Duplicados de mensajes
- Enviar mismo mensaje 2 veces en < 3 segundos
- Verificar: Solo 1 entrada en transcript
- Log: "[DEDUP] Mensaje de usuario ignorado (duplicado)"

PRUEBA 2: Click en bot√≥n
- Click en cualquier bot√≥n (nivel, problema, dispositivo)
- Verificar: Solo 1 entrada en transcript con label descriptivo
- Verificar: buttonToken presente como metadata, NO en texto

PRUEBA 3: Stage final correcto
- Conversaci√≥n completa hasta pasos
- Verificar metadata:
  * stage_inicial: "ASK_LANGUAGE"
  * stage_final: "BASIC_TESTS" (o stage real alcanzado)

PRUEBA 4: Botones post-pasos
- Despu√©s de mostrar pasos
- Verificar: 5 botones post-pasos presentes
- Verificar: NO hay botones de dispositivo

====================================================================
CAMBIOS APLICADOS (RESUMEN)
====================================================================

1. Dedupe mejorado (l√≠nea ~11445-11503)
   - Usa session.progress.lastUserMsgNorm
   - Actualiza tracking ANTES de agregar al transcript

2. Verificaci√≥n de tokens BTN_* (l√≠nea ~11513-11520)
   - Mapea tokens a labels si llegan como texto
   - Guarda token solo como metadata

3. Stage inicial/final (m√∫ltiples ubicaciones)
   - changeStage() guarda initialStage
   - Sesiones nuevas inicializan initialStage
   - Metadata calcula stage_inicial correctamente

4. Botones post-pasos (ya implementados)
   - handleAskDeviceStage: 5 botones post-pasos ‚úÖ
   - handleBasicTestsStage: 5 botones post-pasos ‚úÖ
   - NO se reinyectan botones de dispositivo ‚úÖ

====================================================================
GUARD RAILS VERIFICADOS (NO MODIFICADOS)
====================================================================

‚úÖ Guard rails de simulaci√≥n: Intactos
‚úÖ Rate limits: Intactos
‚úÖ TTL de sesiones: Intactos
‚úÖ ADMIN_TOKEN/LOG_TOKEN: Intactos
‚úÖ L√≥gica de tickets y WhatsApp: Intacta
‚úÖ VALID_TRANSITIONS: Intactas

====================================================================
FIN DEL REPORTE
====================================================================

