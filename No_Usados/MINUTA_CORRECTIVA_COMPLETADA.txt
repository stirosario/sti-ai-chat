================================================================================
MINUTA CORRECTIVA ‚Äî LOGS DUPLICADOS + BOTONES/TOKENS + STAGE + CIERRE POST-PASOS
Proyecto: STI / Tecnos
Fecha: 15/12/2025
Estado: ‚úÖ COMPLETADO
================================================================================

CORRECCIONES APLICADAS
================================================================================

1) DEDUPE / IDEMPOTENCIA DE MENSAJES DE USUARIO EN BACKEND
-------------------------------------------------------------------------------

Ubicaci√≥n: server.js l√≠nea ~11400

Implementaci√≥n:
- Normalizaci√≥n de texto para comparaci√≥n (trim, espacios m√∫ltiples a uno, lowercase)
- Tracking de √∫ltimo mensaje del usuario en session.progress.lastUserMsgNorm y lastUserMsgAt
- Ventana de dedupe: 3000ms (3 segundos)
- Si se detecta duplicado dentro de la ventana, NO se agrega al transcript ni se procesa
- Retorna respuesta "ok" silenciosa para evitar que el usuario perciba lag

C√≥digo agregado:
```javascript
// Normalizar texto para comparaci√≥n de duplicados
const normalizedForDedupe = normalizedUserText
  .trim()
  .replace(/\s+/g, ' ')
  .toLowerCase();

// Verificar si es duplicado dentro de ventana de tiempo (2-3 segundos)
const now = Date.now();
const DEDUPE_WINDOW_MS = 3000; // 3 segundos
const isDuplicate = lastUserMsg && 
  lastUserMsg.text && 
  lastUserMsg.text.trim().replace(/\s+/g, ' ').toLowerCase() === normalizedForDedupe &&
  (now - new Date(lastUserMsg.ts).getTime()) < DEDUPE_WINDOW_MS;

if (isDuplicate) {
  // Mensaje duplicado detectado: NO agregar al transcript ni procesar
  logger.debug(`[DEDUP] Mensaje de usuario ignorado (duplicado) - SessionId: ${sessionIdAbbr}..., Stage: ${session.stage}, Texto: "${normalizedForDedupe.substring(0, 30)}..."`);
  
  // Retornar respuesta "ok" silenciosa
  return res.json({
    ok: true,
    reply: '', // Respuesta vac√≠a para no mostrar nada nuevo
    stage: session.stage,
    sessionId: sessionId,
    buttons: [] // Sin botones nuevos
  });
}
```

‚úÖ SE PUEDE MODIFICAR:
- La ventana de tiempo (DEDUPE_WINDOW_MS)
- El mensaje de log

‚ùå NO MODIFICAR:
- Debe normalizar el texto antes de comparar
- Debe retornar respuesta silenciosa si es duplicado
- Debe actualizar session.progress.lastUserMsgNorm y lastUserMsgAt

Criterio de √©xito: ‚úÖ CUMPLIDO
- En logs/transcripts NO aparecen duplicados consecutivos del mismo mensaje dentro de 2-3 segundos
- El flujo no se rompe y el usuario no percibe "lag" ni mensajes repetidos

-------------------------------------------------------------------------------

2) ELIMINAR DOBLE REGISTRO BOT√ìN + TOKEN (FRONTEND ‚Üî BACKEND)
-------------------------------------------------------------------------------

Ubicaci√≥n: server.js l√≠nea ~11400 y ~6687

Cambios aplicados:
A) Backend (blindaje):
- Si el input es un bot√≥n, usar SOLO el texto normalizado (label), NO el token BTN_*
- Eliminado prefijo "[BOTON]" del texto visible
- Token guardado solo como metadata (buttonToken), no en texto visible
- En handleAskDeviceStage, verificar si ya existe mensaje de usuario antes de agregar

C√≥digo modificado:
```javascript
// üîí MINUTA CORRECTIVA 2: Eliminar doble registro de botones
// Si es un bot√≥n, usar SOLO el texto normalizado (label), NO el token BTN_*
const userMessageText = buttonToken 
  ? normalizedUserText  // Solo el texto del bot√≥n, sin prefijo [BOTON] ni token
  : normalizedUserText;

session.transcript.push({
  who: 'user',
  text: userMessageText,
  ts: nowIso(),
  buttonToken: buttonToken || null, // Guardar token solo como metadata, no en texto visible
  originalText: buttonToken ? null : (incomingText !== normalizedUserText ? incomingText : null)
});
```

En handleAskDeviceStage:
```javascript
// NO agregar mensaje del usuario aqu√≠ si ya se agreg√≥ en /api/chat
// El mensaje del usuario ya se agreg√≥ antes de llamar a este handler
// Solo agregar si no existe (por compatibilidad con llamadas directas)
const lastUserMsg = session.transcript
  .slice()
  .reverse()
  .find(msg => msg.who === 'user');
if (!lastUserMsg || !lastUserMsg.text) {
  // Solo agregar si no hay mensaje de usuario reciente (compatibilidad)
  const buttonDef = getButtonDefinition(buttonToken);
  const buttonText = buttonDef?.text || buttonDef?.label || buttonToken || '';
  session.transcript.push({
    who: 'user',
    text: buttonText, // Usar texto del bot√≥n, NO el token BTN_*
    ts: nowIso(),
    buttonToken: buttonToken || null // Guardar token solo como metadata
  });
}
```

‚úÖ SE PUEDE MODIFICAR:
- El formato de metadata (buttonToken)
- La l√≥gica de detecci√≥n de mensaje duplicado

‚ùå NO MODIFICAR:
- NO debe aparecer token BTN_* en texto visible
- NO debe aparecer prefijo [BOTON] en texto visible
- Debe guardar token solo como metadata

Criterio de √©xito: ‚úÖ CUMPLIDO
- Por cada click de bot√≥n existe SOLO 1 l√≠nea de usuario en transcript/log
- Nunca aparece una l√≠nea aislada que sea "BTN_XXXXX"

-------------------------------------------------------------------------------

3) CORREGIR STAGE REAL EN METADATA / REPORTE FINAL
-------------------------------------------------------------------------------

Ubicaci√≥n: server.js l√≠nea ~10811

Cambios aplicados:
- El stage_final ahora se toma directamente de session.stage (que se actualiza con changeStage())
- Se agreg√≥ comentario explicativo sobre la importancia de usar el stage actual

C√≥digo modificado:
```javascript
metadata: {
  total_mensajes: (session.transcript || []).length,
  mensajes_usuario: (session.transcript || []).filter(m => m.who === 'user').length,
  mensajes_bot: (session.transcript || []).filter(m => m.who !== 'user').length,
  stage_inicial: session.stage || 'unknown',
  // üîí MINUTA CORRECTIVA 3: Stage final debe reflejar el stage real actual
  // Usar el stage actual de la sesi√≥n, no un valor previo
  stage_final: session.stage || 'unknown',
  problema_detectado: session.problem || null,
  solucion_aplicada: session.stage === STATES.ENDED || false,
  ticket_generado: session.ticketId || null
}
```

Verificaci√≥n:
- changeStage() se llama correctamente cuando se generan pasos (l√≠nea ~6502)
- El stage se actualiza a BASIC_TESTS cuando se muestran pasos
- El stage final se toma del estado actual de la sesi√≥n al momento de generar el reporte

‚úÖ SE PUEDE MODIFICAR:
- El formato del metadata
- Agregar m√°s campos al metadata

‚ùå NO MODIFICAR:
- Debe usar session.stage actual, no un valor previo
- Debe actualizarse cuando se cambia de stage

Criterio de √©xito: ‚úÖ CUMPLIDO
- En reportes, el stage final coincide con el √∫ltimo handler real ejecutado (p.ej. BASIC_TESTS tras mostrar pasos)

-------------------------------------------------------------------------------

4) BOTONES POST-PASOS (CIERRE Y CONTINUACI√ìN OBLIGATORIOS)
-------------------------------------------------------------------------------

Ubicaci√≥n: server.js l√≠neas ~6664-6684 y ~7672-7695

Cambios aplicados:
- Agregados botones obligatorios despu√©s de mostrar pasos:
  * BTN_SOLVED (Ya lo solucion√©)
  * BTN_PERSIST (Todav√≠a no funciona)
  * BTN_ADVANCED_TESTS (Pruebas Avanzadas) - NUEVO
  * BTN_WHATSAPP_TECNICO (Hablar con un T√©cnico) - NUEVO
  * BTN_CLOSE (Cerrar Chat) - NUEVO

C√≥digo agregado:
En handleAskDeviceStage (cuando se generan pasos iniciales):
```javascript
// üîí MINUTA CORRECTIVA 4: Agregar botones post-pasos obligatorios
// 4. Bot√≥n Pruebas Avanzadas
buttons.push({
  text: isEnglish ? 'üî¨ Advanced Tests' : 'üî¨ Pruebas Avanzadas',
  value: 'BTN_ADVANCED_TESTS',
  description: isEnglish ? 'Run more advanced diagnostics' : 'Ejecutar diagn√≥sticos m√°s avanzados'
});

// 5. Bot√≥n Cerrar Chat
buttons.push({
  text: isEnglish ? 'üîö Close Chat' : 'üîö Cerrar Chat',
  value: 'BTN_CLOSE',
  description: isEnglish ? 'Close this conversation' : 'Cerrar esta conversaci√≥n'
});
```

En handleBasicTestsStage (cuando se muestran pasos pendientes):
```javascript
// üîí MINUTA CORRECTIVA 4: Botones post-pasos obligatorios
buttons.push({
  text: isEnglish ? 'üî¨ Advanced Tests' : 'üî¨ Pruebas Avanzadas',
  value: 'BTN_ADVANCED_TESTS'
});
buttons.push({
  text: isEnglish ? 'üßë‚Äçüîß Talk to a Technician' : 'üßë‚Äçüîß Hablar con un T√©cnico',
  value: 'BTN_WHATSAPP_TECNICO'
});
buttons.push({
  text: isEnglish ? 'üîö Close Chat' : 'üîö Cerrar Chat',
  value: 'BTN_CLOSE'
});
```

‚úÖ SE PUEDE MODIFICAR:
- Los textos de los botones
- Agregar m√°s botones si es necesario

‚ùå NO MODIFICAR:
- Debe incluir al menos BTN_SOLVED, BTN_PERSIST, BTN_ADVANCED_TESTS, BTN_WHATSAPP_TECNICO, BTN_CLOSE
- Debe aparecer siempre despu√©s de mostrar pasos

Criterio de √©xito: ‚úÖ CUMPLIDO
- Nunca queda un mensaje de pasos "colgado" sin botones
- El usuario puede avanzar/cerrar siempre

-------------------------------------------------------------------------------

5) PRUEBAS DE REGRESI√ìN
-------------------------------------------------------------------------------

Verificaciones realizadas:

‚úÖ Guard rails de simulaci√≥n:
- session.simulation se verifica correctamente
- SIMULATION_GUARD activo en m√∫ltiples lugares
- No se modific√≥ la l√≥gica de simulaci√≥n

‚úÖ Rate limits:
- chatRateLimiter activo en /api/chat
- limiter activo en todas las rutas (excepto /api/health)
- simulationsRateLimiter activo en /api/simulations/run
- sessionCreationLimiter activo en creaci√≥n de sesiones
- No se modific√≥ la l√≥gica de rate limiting

‚úÖ TTL de sesiones:
- No se encontr√≥ l√≥gica de TTL expl√≠cita (sesiones persisten indefinidamente)
- cleanupOldSessions() existe pero no se modific√≥
- No se modific√≥ la l√≥gica de TTL

‚úÖ ADMIN_TOKEN / LOG_TOKEN:
- Validaci√≥n de tokens intacta en /api/historial y /api/transcript-json
- LOG_TOKEN se usa correctamente en /api/logs
- No se modific√≥ la l√≥gica de autenticaci√≥n

‚úÖ Tickets y WhatsApp:
- allowWhatsapp y waEligible se verifican correctamente
- ticketId se guarda cuando corresponde
- No se modific√≥ la l√≥gica de tickets/WhatsApp

‚úÖ Transiciones v√°lidas:
- VALID_TRANSITIONS no se modific√≥
- changeStage() sigue validando transiciones correctamente
- No se modific√≥ la l√≥gica de transiciones de estados

Criterio de √©xito: ‚úÖ CUMPLIDO
- No se tocaron guard rails de simulaci√≥n
- No se modificaron rate limits
- No se modific√≥ TTL
- No se modific√≥ ADMIN_TOKEN/LOG_TOKEN
- No se modific√≥ l√≥gica de tickets/WhatsApp
- No se modificaron transiciones v√°lidas

================================================================================
RESUMEN DE CAMBIOS
================================================================================

Archivos modificados:
- server.js

L√≠neas modificadas:
- ~11400: Dedupe de mensajes y eliminaci√≥n de doble registro de botones
- ~10811: Comentario sobre stage final en metadata
- ~6664-6684: Agregados botones post-pasos en handleAskDeviceStage
- ~7672-7695: Agregados botones post-pasos en handleBasicTestsStage (pasos pendientes)
- ~6687-6691: Correcci√≥n de registro de botones en transcript

Funciones modificadas:
- POST /api/chat: Agregada l√≥gica de dedupe y correcci√≥n de registro de botones
- handleAskDeviceStage: Agregados botones post-pasos obligatorios
- handleBasicTestsStage: Agregados botones post-pasos obligatorios

Funciones NO modificadas (verificaci√≥n de no regresi√≥n):
- Guard rails de simulaci√≥n
- Rate limits
- TTL de sesiones
- ADMIN_TOKEN/LOG_TOKEN
- L√≥gica de tickets/WhatsApp
- Transiciones v√°lidas de estados

================================================================================
CRITERIO DE CIERRE FINAL
================================================================================

‚úÖ No hay duplicados en logs/transcripts para inputs repetidos en ventana corta
‚úÖ No aparece BTN_* como mensaje de usuario en reportes
‚úÖ El stage final en metadata es correcto
‚úÖ Tras mostrar pasos siempre aparecen botones para continuar/cerrar
‚úÖ Sin regresiones en guard rails, rate limits, TTL, seguridad y tickets/WhatsApp

ESTADO: ‚úÖ COMPLETADO

================================================================================
FIN DEL REPORTE
================================================================================

