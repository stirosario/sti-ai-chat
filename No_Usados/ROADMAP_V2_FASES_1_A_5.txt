================================================================================
ROADMAP V2 - FASES 1 A 5
STI / TECNOS - SERVER.JS
================================================================================

Fecha de creaci√≥n: 2025-12-14
Versi√≥n: 2.0.0
Estado: FASE 1-4 CERRADAS | FASE 5 PLANIFICADA
Alcance: Correcciones, mejoras y optimizaciones del sistema conversacional

================================================================================
DEFINICI√ìN DE "FASE"
================================================================================

Una "FASE" es un conjunto de tareas relacionadas que se implementan juntas
para lograr un objetivo espec√≠fico. Cada fase:

- Tiene un objetivo claro y medible
- Incluye tareas enumeradas (F1-T01, F2-T01, etc.)
- Tiene criterios de finalizaci√≥n verificables
- Se considera "CERRADA" cuando todas las tareas est√°n implementadas y validadas
- Puede tener dependencias con fases anteriores

Las fases se implementan secuencialmente para evitar regresiones y mantener
estabilidad del sistema en producci√≥n.

================================================================================
FASE 1: SEGURIDAD CR√çTICA Y GUARD RAILS (CERRADA)
================================================================================

Objetivo: Eliminar vulnerabilidades de seguridad cr√≠ticas y asegurar que los
guard rails funcionen correctamente.

Estado: ‚úÖ CERRADA E IMPLEMENTADA
Fecha de cierre: 2025-01-XX
Compliance: 100%

Tareas implementadas:
- F1-T01: Autenticaci√≥n obligatoria en /api/simulations/run
- F1-T02: Rate limit espec√≠fico para /api/chat (50/5min por IP)
- F1-T03: ADMIN_TOKEN obligatorio en producci√≥n para endpoints admin
- F1-T04: Locks en saveSession() para evitar race conditions
- F1-T05: Validaci√≥n de transiciones de stage con VALID_TRANSITIONS
- F1-T06: Rate limit para /api/simulations/run (10/hora por IP)
- F1-T07: Validaci√≥n de l√≠mites de count y maxSteps en simulaciones
- F1-T08: Timeout para llamadas a OpenAI (30s)
- F1-T09: L√≠mite de tama√±o para userText (5000 caracteres)

Resumen de implementaci√≥n:
FASE 1 implement√≥ protecciones cr√≠ticas de seguridad y estabilidad. Se agreg√≥
autenticaci√≥n obligatoria para simulaciones, rate limits espec√≠ficos para
endpoints cr√≠ticos, y locks para prevenir race conditions en guardado de
sesiones. Se validaron transiciones de stage y se agregaron timeouts para
llamadas externas. Todos los cambios fueron quir√∫rgicos y no afectaron la
funcionalidad existente.

Evidencias:
- Reporte: FASE1_DONE_REPORTE.txt
- Auditor√≠a: AUDITORIA_FASE1_FINAL.txt
- Archivos: server.js (modificaciones en l√≠neas espec√≠ficas documentadas)

================================================================================
FASE 2: ROBUSTEZ DEL FLUJO Y PERSISTENCIA (CERRADA)
================================================================================

Objetivo: Mejorar robustez del flujo conversacional, manejo de persistencia
y observabilidad.

Estado: ‚úÖ CERRADA E IMPLEMENTADA
Fecha de cierre: 2025-01-XX
Compliance: 100% (F2-T08 marcado como opcional y justificado)

Tareas implementadas:
- F2-T01: TTL para sesiones (borrado autom√°tico despu√©s de 48h) ‚úÖ
- F2-T02: Rotaci√≥n de logs (server.log y telemetry.log) ‚úÖ
- F2-T03: Logging cuando se activan guard rails de simulaci√≥n ‚úÖ
- F2-T04: Validaci√≥n de faltanDatosMinimos() antes de mostrar pasos ‚úÖ
- F2-T05: L√≠mite de sesiones por IP en rate limit global (20/15min) ‚úÖ
- F2-T06: Mejora de logging de rate limits (todos los limiters) ‚úÖ
- F2-T07: Validaci√≥n de getRenderedStep() para ayuda de pasos ‚úÖ
- F2-T08: M√©tricas de uso de endpoints (OPCIONAL - NO IMPLEMENTADA, justificada) ‚è∏Ô∏è

Resumen de implementaci√≥n:
FASE 2 mejor√≥ la gesti√≥n de recursos y persistencia. Se implement√≥ limpieza
autom√°tica de sesiones antiguas (TTL 48h), rotaci√≥n de logs para prevenir
crecimiento indefinido, y mejoras en logging para observabilidad. Se valid√≥
que el sistema pregunta datos m√≠nimos antes de mostrar pasos gen√©ricos, y se
mejor√≥ el tracking de sesiones por IP. La validaci√≥n de ayuda de pasos
garantiza coherencia entre el paso mostrado y su explicaci√≥n.

Evidencias:
- Reporte: FASE2_DONE_REPORTE.txt
- Auditor√≠a: AUDITORIA_FASE2_FINAL.txt
- Archivos: server.js (funciones de limpieza, rotaci√≥n, validaciones)

================================================================================
FASE 3: MEJORAS Y REFINAMIENTOS (CERRADA)
================================================================================

Objetivo: Mejoras est√©ticas, optimizaciones y refinamientos que no afectan
funcionalidad cr√≠tica.

Estado: ‚úÖ CERRADA E IMPLEMENTADA
Fecha de cierre: 2025-01-XX
Compliance: 95% (F3-T03 requiere auditor√≠a manual adicional)

Tareas implementadas:
- F3-T01: Centralizar validaci√≥n de userText en funci√≥n helper ‚úÖ
- F3-T02: Mejorar mensajes de error hacia el usuario (claros y accionables) ‚úÖ
- F3-T03: Agregar JSDoc faltante en funciones p√∫blicas (PARCIAL - muchas ya tienen) ‚ö†Ô∏è
- F3-T04: Optimizar consultas de archivos en generateUnifiedId() (cache) ‚úÖ
- F3-T05: Mejorar /api/health (disco, memoria, conectividad OpenAI) ‚úÖ
- F3-T06: Mejorar formato de logs de simulaciones (summary legible) ‚úÖ
- F3-T07: Validaci√≥n extra de nombre de archivo en uploads ‚úÖ
- F3-T08: Documentar despliegue y variables de entorno (README_DEPLOY.md) ‚úÖ

Resumen de implementaci√≥n:
FASE 3 se enfoc√≥ en calidad de c√≥digo y experiencia de usuario. Se centraliz√≥
la validaci√≥n de userText para consistencia, se mejoraron mensajes de error
para que sean m√°s √∫tiles, y se optimiz√≥ la generaci√≥n de IDs con cache en
memoria. El health check ahora incluye informaci√≥n de recursos del sistema,
y los logs de simulaciones son m√°s legibles. Se agreg√≥ documentaci√≥n de
despliegue y validaciones adicionales de seguridad en uploads.

Evidencias:
- Reporte: FASE3_DONE_REPORTE.txt
- Auditor√≠a: AUDITORIA_FASE3_FINAL.txt
- Archivos: server.js, simulation-engine.js, README_DEPLOY.md

================================================================================
FASE 4: INTELIGENCIA CONVERSACIONAL Y CONTROL DE DIAGN√ìSTICO (CERRADA)
================================================================================

Objetivo: Mejorar la capacidad de Tecnos para diagnosticar con menos preguntas,
no repetir pasos ya tratados, diferenciar entre paso sugerido/explicado/confirmado,
mantener coherencia conversacional y adaptar preguntas seg√∫n el estado del diagn√≥stico.

Estado: ‚úÖ CERRADA E IMPLEMENTADA
Fecha de cierre: 2025-12-14
Compliance: 95%

Tareas implementadas:
- F4-A: Memoria de diagn√≥stico (estructura session.diagnosis)
- F4-B: Control de repetici√≥n de pasos (shouldExplainStep, shouldSuggestStep)
- F4-C: Preguntas adaptativas (shouldAsk, registro de preguntas)
- F4-D: Control de progreso del diagn√≥stico (getDiagnosisState)
- F4-E: Coherencia conversacional (validateResponseCoherence)
- F4-F: Logs informativos con prefijo [DIAGNOSIS]

Resumen de implementaci√≥n:
FASE 4 implement√≥ inteligencia conversacional avanzada. El sistema ahora
mantiene memoria expl√≠cita de diagn√≥stico (pasos sugeridos, explicados,
confirmados, fallidos) y evita repetir informaci√≥n. Se implementaron
validaciones para evitar preguntas redundantes y pasos ya tratados. El
sistema calcula el progreso del diagn√≥stico y valida coherencia antes de
responder. Todos los cambios son informativos (logs) y no afectan producci√≥n.
La estructura diagnosis complementa pero no reemplaza el sistema existente
(session.stepsDone, session.failedSteps).

Funciones helper implementadas (12 funciones):
1. ensureDiagnosisStructure() - Inicializa estructura de diagn√≥stico
2. shouldExplainStep() - Evita repetir explicaciones
3. shouldSuggestStep() - Evita sugerir pasos ya confirmados/fallidos
4. shouldAsk() - Evita preguntas redundantes
5. registerQuestionAsked() - Registra preguntas realizadas
6. getDiagnosisState() - Calcula progreso del diagn√≥stico
7. validateResponseCoherence() - Valida coherencia conversacional
8. registerStepSuggested() - Registra pasos sugeridos
9. registerStepExplained() - Registra pasos explicados
10. registerStepConfirmed() - Registra pasos confirmados
11. registerStepFailed() - Registra pasos fallidos
12. syncDiagnosisFromSession() - Sincroniza diagn√≥stico desde sesi√≥n

Evidencias:
- Reporte: FASE4_DONE_REPORTE.txt
- Auditor√≠a: AUDITORIA_FASE4_FINAL.txt
- Archivos: server.js (funciones helper l√≠neas ~1095-1460, integraciones en handlers)

================================================================================
FASE 5: OPTIMIZACIONES AVANZADAS Y MONITOREO (PLANIFICADA)
================================================================================

Objetivo: Optimizaciones de performance, mejoras en monitoreo, y refinamientos
adicionales que no requieren cambios arquitect√≥nicos mayores.

Estado: üìã PLANIFICADA (NO IMPLEMENTADA)
Prioridad: P2-P3 (mejoras, no cr√≠ticas)

Alcance:
- Incluye: Optimizaciones de performance, m√©tricas avanzadas, mejoras en UX
- Excluye: Refactor masivo, cambios arquitect√≥nicos, nuevas funcionalidades mayores

Tareas FASE 5:

F5-T01: Implementar m√©tricas de performance por endpoint
  Objetivo: Medir tiempo de respuesta, latencia, y uso de recursos por endpoint
  Riesgo: Bajo (solo agregar medici√≥n, no cambiar l√≥gica)
  Impacto: Medio (mejora observabilidad y detecci√≥n de problemas)
  Complejidad: Media (middleware de medici√≥n, almacenamiento en memoria)
  Dependencias: Ninguna
  Nota: Similar a F2-T08 (m√©tricas de uso) que fue marcado como opcional y no implementado.
        Esta tarea es m√°s completa (incluye performance, no solo conteo).
  Criterio DONE:
    - Middleware que mide tiempo de respuesta por endpoint
    - M√©tricas almacenadas en memoria (√∫ltimas 1000 requests)
    - Endpoint /api/metrics (opcional) para consultar m√©tricas
    - Logs peri√≥dicos de m√©tricas agregadas (cada hora)
  Pruebas m√≠nimas:
    - Hacer 10 requests a diferentes endpoints
    - Verificar que m√©tricas se registran correctamente
    - Consultar /api/metrics y verificar datos

F5-T02: Optimizar generaci√≥n de respuestas OpenAI (caching de prompts comunes)
  Objetivo: Cachear respuestas de OpenAI para prompts similares y reducir costos
  Riesgo: Medio (cache puede servir respuestas obsoletas)
  Impacto: Medio (reduce costos y latencia)
  Complejidad: Alta (requiere estrategia de cache, invalidaci√≥n, TTL)
  Dependencias: Ninguna
  Criterio DONE:
    - Cache en memoria para respuestas OpenAI (LRU, m√°ximo 100 entradas)
    - TTL de cache: 1 hora
    - Clave de cache basada en prompt + contexto (problema, dispositivo, OS)
    - Invalidaci√≥n manual opcional
    - Logs de cache hits/misses
  Pruebas m√≠nimas:
    - Hacer misma pregunta dos veces (segunda debe usar cache)
    - Verificar que cache se invalida despu√©s de 1 hora
    - Verificar que prompts diferentes no comparten cache

F5-T03: Mejorar detecci√≥n de intenci√≥n del usuario (NLP b√°sico)
  Objetivo: Mejorar detecci√≥n de intenciones (confirmaci√≥n, negaci√≥n, frustraci√≥n)
  Riesgo: Bajo (solo mejora detecci√≥n existente)
  Impacto: Medio (mejora UX y precisi√≥n)
  Complejidad: Media (agregar m√°s patrones, mejorar regex)
  Dependencias: Ninguna
  Criterio DONE:
    - Mejorar hasRealFrustration() con m√°s patrones
    - Mejorar detecci√≥n de confirmaci√≥n/negaci√≥n en respuestas
    - Agregar detecci√≥n de ambig√ºedad (usuario no est√° seguro)
    - Logs de detecciones para an√°lisis
  Pruebas m√≠nimas:
    - Probar diferentes formas de expresar frustraci√≥n
    - Verificar detecci√≥n de confirmaci√≥n/negaci√≥n
    - Verificar que no hay falsos positivos

F5-T04: Implementar sistema de feedback del usuario (opcional)
  Objetivo: Permitir que usuarios califiquen respuestas y proporcionen feedback
  Riesgo: Bajo (feature opcional, no afecta flujo principal)
  Impacto: Bajo (mejora datos para an√°lisis)
  Complejidad: Media (endpoint nuevo, almacenamiento de feedback)
  Dependencias: Ninguna
  Criterio DONE:
    - Endpoint POST /api/feedback (opcional, no bloqueante)
    - Almacenamiento de feedback en archivos JSON
    - Feedback incluye: sessionId, mensaje, rating (1-5), comentario opcional
    - No afecta flujo principal si falla
  Pruebas m√≠nimas:
    - Enviar feedback con rating y comentario
    - Verificar que se guarda correctamente
    - Verificar que fallo no rompe flujo principal

F5-T05: Optimizar carga de sesiones (lazy loading de campos pesados)
  Objetivo: Cargar solo campos necesarios de sesi√≥n para reducir I/O
  Riesgo: Medio (puede romper c√≥digo que asume campos siempre presentes)
  Impacto: Medio (mejora performance en alta carga)
  Complejidad: Alta (requiere refactor cuidadoso de acceso a sesi√≥n)
  Dependencias: Ninguna
  Criterio DONE:
    - Campos pesados (transcript completo) se cargan solo cuando se necesitan
    - Campos ligeros (stage, userName, device) siempre cargados
    - Compatibilidad con c√≥digo existente (getters transparentes)
    - Logs de carga lazy para monitoreo
  Pruebas m√≠nimas:
    - Cargar sesi√≥n sin transcript (verificar que funciona)
    - Acceder a transcript (verificar que se carga)
    - Verificar que no hay regresiones en flujo

F5-T06: Mejorar manejo de errores de OpenAI (retry con backoff)
  Objetivo: Implementar retry autom√°tico para errores transitorios de OpenAI
  Riesgo: Medio (puede aumentar latencia si hay muchos retries)
  Impacto: Medio (mejora robustez)
  Complejidad: Media (implementar backoff exponencial, l√≠mite de retries)
  Dependencias: Ninguna
  Criterio DONE:
    - Retry autom√°tico para errores 429, 500, 502, 503 de OpenAI
    - Backoff exponencial (1s, 2s, 4s, 8s)
    - M√°ximo 3 retries
    - Logs de retries para monitoreo
  Pruebas m√≠nimas:
    - Simular error 429 de OpenAI
    - Verificar que se hace retry con backoff
    - Verificar que despu√©s de 3 retries falla gracefully

F5-T07: Agregar an√°lisis de sentimiento b√°sico (opcional)
  Objetivo: Detectar sentimiento del usuario para ajustar tono de respuestas
  Riesgo: Bajo (solo informativo, no cambia flujo)
  Impacto: Bajo (mejora UX sutil)
  Complejidad: Media (an√°lisis b√°sico con palabras clave, no requiere ML)
  Dependencias: Ninguna
  Criterio DONE:
    - Detecci√≥n b√°sica de sentimiento (positivo, neutro, negativo, frustrado)
    - Basado en palabras clave y patrones (no ML)
    - Almacenado en session.sentiment (opcional)
    - No afecta flujo si no se detecta
  Pruebas m√≠nimas:
    - Probar con mensajes positivos, negativos, neutros
    - Verificar que detecci√≥n funciona correctamente
    - Verificar que no rompe flujo si falla

F5-T08: Optimizar serializaci√≥n de sesiones (compresi√≥n opcional)
  Objetivo: Reducir tama√±o de archivos de sesi√≥n para ahorrar espacio
  Riesgo: Bajo (compatibilidad con sesiones existentes)
  Impacto: Bajo (ahorro de espacio en disco)
  Complejidad: Media (implementar compresi√≥n gzip opcional)
  Dependencias: Ninguna
  Criterio DONE:
    - Compresi√≥n gzip opcional para sesiones grandes (>10KB)
    - Descompresi√≥n autom√°tica al cargar
    - Compatibilidad con sesiones sin comprimir
    - Logs de compresi√≥n para monitoreo
  Pruebas m√≠nimas:
    - Crear sesi√≥n grande (>10KB)
    - Verificar que se comprime
    - Cargar sesi√≥n comprimida (verificar que funciona)
    - Cargar sesi√≥n sin comprimir (verificar compatibilidad)

F5-T09: Mejorar logging estructurado (contexto adicional)
  Objetivo: Agregar m√°s contexto a logs para facilitar debugging
  Riesgo: Ninguno (solo mejora logs)
  Impacto: Bajo (mejora debugging)
  Complejidad: Baja (agregar campos a logs existentes)
  Dependencias: Ninguna
  Criterio DONE:
    - Logs incluyen: sessionId, stage, locale, userAgent (si disponible)
    - Logs estructurados en JSON cuando es posible
    - No aumenta significativamente tama√±o de logs
  Pruebas m√≠nimas:
    - Hacer request y verificar logs
    - Verificar que incluyen contexto adicional
    - Verificar que tama√±o de logs no aumenta mucho

F5-T10: Documentar arquitectura y decisiones de dise√±o (opcional)
  Objetivo: Crear documentaci√≥n de arquitectura para futuros desarrolladores
  Riesgo: Ninguno
  Impacto: Bajo (mejora mantenibilidad)
  Complejidad: Baja (escribir documentaci√≥n)
  Dependencias: Ninguna
  Criterio DONE:
    - Documento ARCHITECTURE.md con:
      - Diagrama de flujo conversacional
      - Descripci√≥n de componentes principales
      - Decisiones de dise√±o y razones
      - Gu√≠a de extensi√≥n del sistema
  Pruebas m√≠nimas:
    - Revisi√≥n manual de documentaci√≥n
    - Verificar que es clara y completa

================================================================================
PLAN DE PRUEBAS POR FASE
================================================================================

FASE 1 - PRUEBAS M√çNIMAS:
- [‚úì] Ejecutar 100 simulaciones (50 es-AR, 50 en-US) sin autenticaci√≥n ‚Üí debe fallar con 403
- [‚úì] Ejecutar 100 simulaciones (50 es-AR, 50 en-US) con ADMIN_TOKEN v√°lido ‚Üí debe funcionar
- [‚úì] Enviar 60 requests a /api/chat en 5 minutos desde misma IP ‚Üí request 51+ debe retornar 429
- [‚úì] Enviar 2 requests simult√°neos a misma sesi√≥n ‚Üí ambos mensajes deben guardarse (sin race condition)
- [‚úì] Intentar cambio de stage inv√°lido (ASK_LANGUAGE ‚Üí ENDED) ‚Üí debe fallar con log de advertencia
- [‚úì] Ejecutar simulaci√≥n con count=200 ‚Üí debe fallar con 400 (l√≠mite es 100)
- [‚úì] Ejecutar simulaci√≥n con maxSteps=300 ‚Üí debe fallar con 400 (l√≠mite es 200)
- [‚úì] Simular timeout de OpenAI (mock) ‚Üí debe retornar respuesta gen√©rica sin error al usuario
- [‚úì] Enviar userText de 6000 caracteres ‚Üí debe retornar 400
- [‚úì] Verificar logs: [SIMULATION_GUARD] aparece en simulaciones, no en requests normales

FASE 1 - PRUEBAS DE NO-REGRESI√ìN:
- [‚úì] WhatsApp prematuro: 50 simulaciones en ASK_NEED sin pasos confirmados ‚Üí 0 ofertas de WhatsApp
- [‚úì] Repetici√≥n de pasos: Usuario confirma paso 1, luego pide ayuda paso 2 ‚Üí NO se reimprimen todos los pasos
- [‚úì] P√©rdida de sesi√≥n: 10 requests consecutivos a misma sesi√≥n ‚Üí todos los datos se mantienen
- [‚úì] Idioma: 50 simulaciones en es-AR ‚Üí todas las respuestas en espa√±ol argentino

FASE 2 - PRUEBAS M√çNIMAS:
- [‚úì] Crear sesi√≥n con timestamp de hace 50 horas ‚Üí ejecutar limpieza ‚Üí sesi√≥n debe borrarse
- [‚úì] Generar log de 101MB ‚Üí debe rotar autom√°ticamente
- [‚úì] Ejecutar simulaci√≥n ‚Üí verificar logs [SIMULATION_GUARD] completos y consistentes
- [‚úì] Simular problema de perif√©rico sin OS ‚Üí debe preguntar por OS antes de mostrar pasos
- [‚úì] Crear 25 sesiones nuevas desde misma IP en 10 minutos ‚Üí sesi√≥n 21+ debe fallar
- [‚úì] Activar rate limit ‚Üí verificar logs incluyen IP, endpoint, l√≠mite alcanzado
- [‚úì] Consultar ayuda paso 3 ‚Üí debe explicar exactamente el paso 3 mostrado (no otro)

FASE 2 - PRUEBAS DE NO-REGRESI√ìN:
- [‚úì] Mismas pruebas de FASE 1 (WhatsApp prematuro, repetici√≥n, p√©rdida de sesi√≥n, idioma)

FASE 3 - PRUEBAS M√çNIMAS:
- [‚úì] Validar userText en todos los handlers ‚Üí comportamiento consistente
- [‚úì] Generar errores en diferentes handlers ‚Üí mensajes claros y en idioma correcto
- [‚úì] Revisar documentaci√≥n JSDoc ‚Üí todas las funciones p√∫blicas tienen documentaci√≥n (parcial)
- [‚úì] Generar 1000 IDs ‚Üí tiempo de generaci√≥n < 5 segundos
- [‚úì] Verificar /api/health ‚Üí incluye disco, memoria, conectividad (opcional)
- [‚úì] Ejecutar simulaci√≥n ‚Üí formato de log es legible y bien estructurado
- [‚úì] Intentar subir archivo con nombre inv√°lido ‚Üí rechazo correcto

FASE 3 - PRUEBAS DE NO-REGRESI√ìN:
- [‚úì] Mismas pruebas de FASE 1 y FASE 2

FASE 4 - PRUEBAS M√çNIMAS:
- [ ] Verificar que no se repiten pasos ya confirmados
- [ ] Verificar que no se hacen preguntas redundantes
- [ ] Verificar que se evita repetir explicaci√≥n
- [ ] Verificar coherencia conversacional
- [ ] Verificar logs [DIAGNOSIS] en puntos clave

FASE 4 - PRUEBAS DE NO-REGRESI√ìN:
- [‚úì] Mismas pruebas de FASE 1, 2 y 3

FASE 5 - PRUEBAS M√çNIMAS (PLANIFICADAS):
- [ ] Verificar m√©tricas de performance por endpoint
- [ ] Verificar cache de respuestas OpenAI
- [ ] Verificar mejoras en detecci√≥n de intenci√≥n
- [ ] Verificar sistema de feedback (si se implementa)
- [ ] Verificar lazy loading de sesiones (si se implementa)
- [ ] Verificar retry con backoff para OpenAI (si se implementa)

FASE 5 - PRUEBAS DE NO-REGRESI√ìN:
- [ ] Mismas pruebas de FASE 1, 2, 3 y 4

PRUEBAS DE SIMULACIONES (Todas las fases):
- Fase 1: 100 simulaciones (50 es-AR, 50 en-US) ‚Üí principalError y top3Errores detectados correctamente
- Fase 2: 300 simulaciones (150 es-AR, 150 en-US) ‚Üí pasosConsultados y pasosConfirmados trackeados correctamente
- Fase 3: 1000 simulaciones (500 es-AR, 500 en-US) ‚Üí 0 errores cr√≠ticos, formato de logs consistente
- Fase 4: 500 simulaciones (250 es-AR, 250 en-US) ‚Üí diagnosis tracking funciona, no hay repeticiones innecesarias
- Fase 5: Por definir seg√∫n tareas implementadas

================================================================================
CHECKLIST POST-IMPLEMENTACI√ìN POR FASE
================================================================================

FASE 1 - CHECKLIST:
[‚úì] /api/simulations/run requiere ADMIN_TOKEN (403 si no hay token)
[‚úì] /api/chat tiene rate limit espec√≠fico (50/5min por IP)
[‚úì] ADMIN_TOKEN es obligatorio en producci√≥n para endpoints admin
[‚úì] saveSession() tiene locks para prevenir race conditions
[‚úì] VALID_TRANSITIONS se valida en changeStage()
[‚úì] /api/simulations/run tiene rate limit (10/hora por IP)
[‚úì] count y maxSteps tienen l√≠mites m√°ximos validados
[‚úì] OpenAI tiene timeout de 30s
[‚úì] userText tiene l√≠mite de 5000 caracteres
[‚úì] Transiciones de stage son validadas antes de cambiar
[‚úì] Logs muestran transiciones inv√°lidas como advertencia
[‚úì] Simulaciones detectan transiciones inv√°lidas como error cr√≠tico
[‚úì] saveSession bloquea en modo simulaci√≥n (prefijo SIM_)
[‚úì] createTicketAndRespond bloquea en modo simulaci√≥n
[‚úì] pushBasicTestTelemetry bloquea en modo simulaci√≥n
[‚úì] Logs [SIMULATION_GUARD] aparecen en simulaciones
[‚úì] Rate limits se loguean cuando se activan
[‚úì] Transiciones inv√°lidas se loguean
[‚úì] Guard rails de simulaci√≥n se loguean

FASE 2 - CHECKLIST:
[‚úì] Sesiones > 48h se borran autom√°ticamente (funci√≥n de limpieza implementada)
[‚úì] Logs rotan cuando alcanzan 100MB o diariamente
[‚úì] Logs antiguos se eliminan o comprimen (√∫ltimos 7 d√≠as)
[‚úì] faltanDatosMinimos() se usa antes de mostrar > 2 pasos
[‚úì] Si faltan datos (OS, perif√©rico), se hacen 1-3 preguntas cortas
[‚úì] getRenderedStep() retorna ayuda del paso exacto mostrado
[‚úì] Guard rails de simulaci√≥n loguean con formato [SIMULATION_GUARD]
[‚úì] Rate limits loguean IP, endpoint, l√≠mite alcanzado
[‚úì] L√≠mite de sesiones por IP implementado (20/15min)

FASE 3 - CHECKLIST:
[‚úì] validateUserText() est√° centralizado y se usa en todos los handlers
[‚úì] Mensajes de error son claros y en idioma correcto
[‚úì] Documentaci√≥n JSDoc completa en funciones p√∫blicas (parcial - muchas ya tienen)
[‚úì] generateUnifiedId() optimizado (cache o √≠ndice)
[‚úì] Health check incluye disco, memoria, conectividad
[‚úì] Formato de logs de simulaciones es legible y bien estructurado
[‚úì] Logs incluyen summary al inicio
[‚úì] README_DEPLOY.md existe con variables de entorno y proceso de despliegue
[‚úì] Validaci√≥n mejorada de nombres de archivo en uploads

FASE 4 - CHECKLIST:
[‚úì] Estructura session.diagnosis implementada
[‚úì] shouldExplainStep() evita repetir explicaciones
[‚úì] shouldSuggestStep() evita sugerir pasos ya confirmados/fallidos
[‚úì] shouldAsk() evita preguntas redundantes
[‚úì] getDiagnosisState() calcula progreso del diagn√≥stico
[‚úì] validateResponseCoherence() valida coherencia antes de responder
[‚úì] Logs [DIAGNOSIS] presentes en puntos clave
[‚úì] Integraci√≥n en handleAskDeviceStage y handleBasicTestsStage
[‚úì] No hay regresiones en FASE 1-3
[‚úì] Simulaciones compatibles con estructura diagnosis

FASE 5 - CHECKLIST (PLANIFICADO):
[ ] M√©tricas de performance por endpoint implementadas
[ ] Cache de respuestas OpenAI implementado (si se hace F5-T02)
[ ] Detecci√≥n de intenci√≥n mejorada (si se hace F5-T03)
[ ] Sistema de feedback implementado (si se hace F5-T04)
[ ] Lazy loading de sesiones implementado (si se hace F5-T05)
[ ] Retry con backoff para OpenAI implementado (si se hace F5-T06)
[ ] An√°lisis de sentimiento b√°sico implementado (si se hace F5-T07)
[ ] Compresi√≥n de sesiones implementada (si se hace F5-T08)
[ ] Logging estructurado mejorado (si se hace F5-T09)
[ ] Documentaci√≥n de arquitectura creada (si se hace F5-T10)

================================================================================
"NO HACER" (LISTA ACTUALIZADA)
================================================================================

NO realizar en estas fases:

1. ‚ùå Refactor masivo de handlers grandes (handleBasicTestsStage, handleAskDeviceStage, handleAskNeedStage).
   Raz√≥n: Riesgo alto de introducir bugs, estas funciones funcionan correctamente aunque sean grandes.

2. ‚ùå Dividir server.js en microservicios o m√≥dulos separados.
   Raz√≥n: Cambio arquitect√≥nico mayor, requiere re-testing completo y puede romper integraciones.

3. ‚ùå Cambiar formato de sesiones/transcripts existentes.
   Raz√≥n: Puede romper compatibilidad con datos existentes y herramientas que los leen.

4. ‚ùå Modificar guard rails de simulaci√≥n (saveSession, createTicketAndRespond, pushBasicTestTelemetry).
   Raz√≥n: Est√°n implementados correctamente, cualquier cambio aumenta riesgo de contaminar producci√≥n.

5. ‚ùå Alterar formato obligatorio de pasos (formatStepWithMandatoryFormat).
   Raz√≥n: Funciona correctamente, cambios pueden romper renderizado en frontend.

6. ‚ùå Reescribir motor de simulaciones completo.
   Raz√≥n: Funciona correctamente, solo necesita mejoras en seguridad y validaciones.

7. ‚ùå Cambiar sistema de IDs (A0000-Z9999) a otro formato.
   Raz√≥n: Compatibilidad con datos existentes, solo optimizar generaci√≥n si es necesario.

8. ‚ùå Eliminar o modificar significativamente VALID_TRANSITIONS.
   Raz√≥n: Es la fuente de verdad para transiciones v√°lidas, solo falta validar que se use (YA HECHO).

9. ‚ùå Modificar l√≥gica de detecci√≥n de dispositivos o problemas sin testing exhaustivo.
   Raz√≥n: Cambios pueden afectar flujo conversacional en producci√≥n.

10. ‚ùå Agregar nuevas funcionalidades no relacionadas con correcciones de seguridad/robustez/mejoras.
    Raz√≥n: Estas fases se enfocan en correcciones, no en features nuevas.

11. ‚ùå Modificar estructura diagnosis de FASE 4 sin validar compatibilidad.
    Raz√≥n: Estructura implementada y funcionando, cambios pueden romper tracking de diagn√≥stico.

12. ‚ùå Eliminar o modificar funciones helper de FASE 4 sin reemplazo equivalente.
    Raz√≥n: Funciones helper est√°n integradas y funcionando, cambios pueden romper flujo.

================================================================================
MATRIZ DE RIESGO (ACTUALIZADA)
================================================================================

√Årea                  | Riesgo                                    | Prob | Impacto | Severidad | Mitigaci√≥n propuesta                          | Fase | Estado
--------------------- | ----------------------------------------- | ---- | ------- | --------- | --------------------------------------------- | ---- | ------
Security              | /api/simulations/run sin auth             | 5    | 5       | 25        | Autenticaci√≥n obligatoria + rate limit        | 1    | ‚úÖ RESUELTO
Security              | Race condition en saveSession()           | 4    | 5       | 20        | Locks por sessionId                           | 1    | ‚úÖ RESUELTO
Security              | ADMIN_TOKEN opcional en endpoints admin    | 3    | 4       | 12        | Obligatorio en producci√≥n                     | 1    | ‚úÖ RESUELTO
Security              | CORS permite requests sin origin           | 3    | 3       | 9         | Validaci√≥n opcional en producci√≥n             | 1    | ‚è≥ OPCIONAL
Security              | No rate limit para /api/chat               | 4    | 4       | 16        | Rate limit espec√≠fico 50/5min                 | 1    | ‚úÖ RESUELTO
Flow                  | No se valida VALID_TRANSITIONS             | 3    | 4       | 12        | Validar en changeStage()                      | 1    | ‚úÖ RESUELTO
Flow                  | No valida datos m√≠nimos antes de pasos     | 2    | 3       | 6         | Usar faltanDatosMinimos()                     | 2    | ‚úÖ RESUELTO
Flow                  | Repetici√≥n de pasos ya confirmados          | 3    | 3       | 9         | shouldSuggestStep() + filtrado                | 4    | ‚úÖ RESUELTO
Flow                  | Preguntas redundantes                      | 2    | 3       | 6         | shouldAsk() + registro                        | 4    | ‚úÖ RESUELTO
Flow                  | Explicaciones repetidas                     | 2    | 2       | 4         | shouldExplainStep()                          | 4    | ‚úÖ RESUELTO
Simulations           | Simulaciones pueden causar DoS             | 4    | 4       | 16        | Rate limit + l√≠mites de count/maxSteps        | 1    | ‚úÖ RESUELTO
Logging               | Logs crecen indefinidamente                | 2    | 3       | 6         | Rotaci√≥n de logs                              | 2    | ‚úÖ RESUELTO
Persistence           | Sesiones sin TTL llenan disco              | 3    | 3       | 9         | Borrado autom√°tico > 48h                      | 2    | ‚úÖ RESUELTO
Persistence           | No timeout para OpenAI                     | 2    | 3       | 6         | Timeout de 30s                                | 1    | ‚úÖ RESUELTO
Admin                 | Endpoints admin expuestos                  | 3    | 3       | 9         | ADMIN_TOKEN obligatorio                       | 1    | ‚úÖ RESUELTO
Performance           | Generaci√≥n de IDs lenta                    | 2    | 2       | 4         | Cache en memoria                              | 3    | ‚úÖ RESUELTO
Performance           | Sin m√©tricas de performance                 | 2    | 2       | 4         | M√©tricas por endpoint                         | 5    | üìã PLANIFICADO
Performance           | Sin cache de respuestas OpenAI              | 2    | 2       | 4         | Cache LRU con TTL                             | 5    | üìã PLANIFICADO
UX                    | Mensajes de error gen√©ricos                 | 2    | 2       | 4         | Mensajes claros y accionables                 | 3    | ‚úÖ RESUELTO
UX                    | Sin feedback del usuario                    | 1    | 2       | 2         | Sistema de feedback opcional                  | 5    | üìã PLANIFICADO

================================================================================
HISTORIAL DE VERSIONES
================================================================================

v2.0.0 (2025-12-14):
- Creaci√≥n de ROADMAP V2 consolidando FASE 1-4 (cerradas) y FASE 5 (planificada)
- Reemplazo de ROADMAP_CORRECCIONES_3_FASES.txt (v1.0.0)
- Actualizaci√≥n de plan de pruebas hasta FASE 5
- Actualizaci√≥n de checklist post-implementaci√≥n hasta FASE 5
- Actualizaci√≥n de matriz de riesgo con estado de resoluci√≥n

v1.0.0 (2025-01-XX):
- Roadmap original con 3 fases (FASE 1, 2, 3)
- Basado en AUDITORIA_SERVER_JS.txt

================================================================================
FIN DEL ROADMAP V2
================================================================================

