================================================================================
INVENTARIO DE ARCHIVOS Y FUNCIONES - ECOSISTEMA CHAT TECNOS
Fecha: 2025-01-XX
================================================================================

ARCHIVOS RELEVANTES
================================================================================

BACKEND
-------------------------------------------------------------------------------
server.js (11424 l√≠neas)
- Archivo principal del servidor
- Contiene: endpoints, handlers de stages, l√≥gica de flujo, guard rails, rate limits
- Ubicaci√≥n: C:\sti-ai-chat\server.js
- Dependencias: express, openai, pino, rate-limit, helmet, cors, multer, sharp

simulation-engine.js (845 l√≠neas)
- Motor de simulaciones
- Contiene: generaci√≥n de datos, ejecuci√≥n de simulaciones, detecci√≥n de errores
- Ubicaci√≥n: C:\sti-ai-chat\simulation-engine.js
- Dependencias: crypto, path, fs/promises

FRONTEND
-------------------------------------------------------------------------------
index.php (2875 l√≠neas)
- Frontend principal del chat
- Contiene: UI, normalizaci√≥n de botones, env√≠o de mensajes, renderizado
- Ubicaci√≥n: C:\STI\public_html\index.php
- Dependencias: JavaScript vanilla, fetch API

admin.php (5495 l√≠neas)
- Panel de administraci√≥n
- Contiene: vista de simulaciones, logs, tickets, m√©tricas
- Ubicaci√≥n: C:\STI\public_html\admin.php
- Dependencias: PHP, JavaScript, fetch API

ENDPOINTS Y HANDLERS PRINCIPALES
================================================================================

ENDPOINTS HTTP (server.js)
-------------------------------------------------------------------------------

GET /api/health
- L√≠nea: ~619+
- Funci√≥n: Health check del servidor
- Par√°metros: Ninguno
- Respuesta: { status: 'healthy'|'degraded', disk, memory, openai }
- Rate limit: Ninguno (p√∫blico)
- Autenticaci√≥n: No requerida

GET /api/greeting
- L√≠nea: ~10500+
- Funci√≥n: Iniciar nueva sesi√≥n
- Par√°metros: Ninguno (opcional: locale)
- Respuesta: { ok, greeting, reply, stage, sessionId, csrfToken, buttons }
- Rate limit: sessionCreationLimiter (20/15min por IP)
- Autenticaci√≥n: No requerida

POST /api/chat
- L√≠nea: ~10650+
- Funci√≥n: Procesar mensajes del chat
- Par√°metros: { userText?, buttonToken?, sessionId, action?, csrfToken }
- Respuesta: { ok, reply, stage, buttons?, sessionId }
- Rate limit: chatRateLimiter (50/5min por IP)
- Autenticaci√≥n: No requerida (pero requiere sessionId v√°lido)
- Handlers llamados seg√∫n stage:
  * ASK_LANGUAGE: handleAskLanguageStage()
  * ASK_NAME: handleAskNameStage()
  * ASK_USER_LEVEL: handleAskUserLevelStage()
  * ASK_NEED: handleAskNeedStage()
  * ASK_DEVICE: handleAskDeviceStage()
  * BASIC_TESTS: handleBasicTestsStage()
  * ADVANCED_TESTS: handleAdvancedTestsStage()
  * ESCALATE: handleEscalateStage()

POST /api/simulations/run
- L√≠nea: ~11279+
- Funci√≥n: Ejecutar simulaciones
- Par√°metros: { locale?, userType?, problem?, device?, os?, count?, maxSteps? }
- Respuesta: { ok, results: [simulation results] }
- Rate limit: simulationsRateLimiter (10/hora por IP)
- Autenticaci√≥n: ADMIN_TOKEN requerido (query string o header)

GET /api/simulations/logs
- L√≠nea: ~11359+
- Funci√≥n: Obtener logs de simulaciones
- Par√°metros: limit? (query string)
- Respuesta: { ok, logs: [simulation logs] }
- Rate limit: Ninguno espec√≠fico
- Autenticaci√≥n: ADMIN_TOKEN requerido

GET /api/simulations/log/:simulationId
- L√≠nea: ~11387+
- Funci√≥n: Obtener log espec√≠fico de simulaci√≥n
- Par√°metros: simulationId (path parameter)
- Respuesta: { ok, log: simulation log }
- Rate limit: Ninguno espec√≠fico
- Autenticaci√≥n: ADMIN_TOKEN requerido

POST /api/upload-image
- L√≠nea: ~9600+
- Funci√≥n: Subir imagen para an√°lisis
- Par√°metros: multipart/form-data (file)
- Respuesta: { ok, imageUrl, analysis? }
- Rate limit: uploadLimiter (3/min por IP+Session)
- Autenticaci√≥n: No requerida (pero requiere sessionId)

GET /api/historial
- L√≠nea: ~10190+
- Funci√≥n: Obtener historial de conversaciones
- Par√°metros: token (query string, ADMIN_TOKEN)
- Respuesta: { ok, historial: [conversations] }
- Rate limit: Ninguno espec√≠fico
- Autenticaci√≥n: ADMIN_TOKEN requerido (obligatorio en producci√≥n)

GET /api/transcript-json/:sessionId
- L√≠nea: ~10326+
- Funci√≥n: Obtener transcript en JSON
- Par√°metros: sessionId (path parameter), token (query string)
- Respuesta: { ok, transcript: [messages] }
- Rate limit: Ninguno espec√≠fico
- Autenticaci√≥n: ADMIN_TOKEN requerido

HANDLERS DE STAGES (server.js)
-------------------------------------------------------------------------------

handleAskLanguageStage()
- L√≠nea: ~2582+
- Stage: ASK_LANGUAGE
- Funci√≥n: Manejar GDPR y selecci√≥n de idioma
- Par√°metros: session, userText, buttonToken, sessionId
- Retorna: { ok, reply, stage, buttons?, handled }
- Transiciones v√°lidas: ASK_LANGUAGE ‚Üí ASK_NAME

handleAskNameStage()
- L√≠nea: ~3200+
- Stage: ASK_NAME
- Funci√≥n: Pedir y validar nombre del usuario
- Par√°metros: session, userText, buttonToken, sessionId
- Retorna: { ok, reply, stage, buttons?, handled }
- Transiciones v√°lidas: ASK_NAME ‚Üí ASK_USER_LEVEL
- L√≠mite de intentos: 3 (nameAttempts)

handleAskUserLevelStage()
- L√≠nea: ~3902+
- Stage: ASK_USER_LEVEL
- Funci√≥n: Preguntar nivel de experiencia del usuario
- Par√°metros: session, userText, buttonToken, sessionId
- Retorna: { ok, reply, stage, buttons?, handled }
- Transiciones v√°lidas: ASK_USER_LEVEL ‚Üí ASK_NEED
- Valores: 'basic', 'intermediate', 'advanced'
- Se salta si: session.userLevel ya existe

handleAskNeedStage()
- L√≠nea: ~4200+
- Stage: ASK_NEED
- Funci√≥n: Preguntar qu√© problema tiene el usuario
- Par√°metros: session, userText, buttonToken, sessionId
- Retorna: { ok, reply, stage, buttons?, handled }
- Transiciones v√°lidas: ASK_NEED ‚Üí ASK_DEVICE, ASK_NEED ‚Üí ASK_NAME (error)

handleAskDeviceStage()
- L√≠nea: ~5000+
- Stage: ASK_DEVICE
- Funci√≥n: Preguntar tipo de dispositivo
- Par√°metros: session, userText, buttonToken, sessionId
- Retorna: { ok, reply, stage, buttons?, handled }
- Transiciones v√°lidas: ASK_DEVICE ‚Üí BASIC_TESTS

handleBasicTestsStage()
- L√≠nea: ~6000+
- Stage: BASIC_TESTS
- Funci√≥n: Mostrar pasos b√°sicos de soluci√≥n
- Par√°metros: session, userText, buttonToken, sessionId
- Retorna: { ok, reply, stage, buttons?, handled }
- Transiciones v√°lidas: BASIC_TESTS ‚Üí ADVANCED_TESTS, BASIC_TESTS ‚Üí ESCALATE, BASIC_TESTS ‚Üí ENDED
- Casos especiales:
  * BTN_SOLVED ‚Üí mostrar feedback
  * BTN_PERSIST ‚Üí escalar a t√©cnico
  * BTN_FEEDBACK_* ‚Üí registrar feedback y cerrar

handleAdvancedTestsStage()
- L√≠nea: ~8500+
- Stage: ADVANCED_TESTS
- Funci√≥n: Mostrar pasos avanzados de soluci√≥n
- Par√°metros: session, userText, buttonToken, sessionId
- Retorna: { ok, reply, stage, buttons?, handled }
- Transiciones v√°lidas: ADVANCED_TESTS ‚Üí ESCALATE, ADVANCED_TESTS ‚Üí ENDED

handleEscalateStage()
- L√≠nea: ~8600+
- Stage: ESCALATE
- Funci√≥n: Conectar con t√©cnico humano
- Par√°metros: session, userText, buttonToken, sessionId
- Retorna: { ok, reply, stage, buttons?, handled }
- Transiciones v√°lidas: ESCALATE ‚Üí ENDED
- Crea ticket si: BTN_CONNECT_TECH o BTN_WHATSAPP_TECNICO

FUNCIONES HELPER PRINCIPALES (server.js)
-------------------------------------------------------------------------------

validateUserText()
- L√≠nea: ~1821+
- Funci√≥n: Validar y normalizar texto del usuario
- Par√°metros: userText, buttonToken?, options?
- Retorna: { ok, reason?, normalizedText }
- Validaciones:
  * null/undefined
  * tipo (debe ser string)
  * trim
  * longitud m√°xima (default: 5000, configurable)
  * buttonToken permite userText vac√≠o

faltanDatosMinimos()
- L√≠nea: ~4950+
- Funci√≥n: Verificar si faltan datos m√≠nimos para mostrar pasos
- Par√°metros: session, caseType?, locale?
- Retorna: { missing: boolean, questions: Array<string>, context: object }
- Verifica seg√∫n caseType:
  * 'system'|'os_dependent': requiere hasOS, osName
  * 'peripheral': requiere hasPeripheralType, peripheralType
  * 'performance'|'gaming': requiere hasOS, hasDeviceType
  * 'generic': requiere alg√∫n contexto m√≠nimo

changeStage()
- L√≠nea: ~2450+
- Funci√≥n: Cambiar stage de sesi√≥n validando transiciones
- Par√°metros: session, newStage
- Retorna: boolean (√©xito)
- Valida: Transici√≥n debe estar en VALID_TRANSITIONS
- Log: Registra cambio de stage

getSession()
- L√≠nea: ~2000+
- Funci√≥n: Obtener sesi√≥n desde almacenamiento
- Par√°metros: sessionId
- Retorna: Promise<session object | null>
- Almacenamiento: Archivos JSON en DATA_BASE/sessions/

saveSessionAndTranscript()
- L√≠nea: ~2040+
- Funci√≥n: Guardar sesi√≥n y transcript
- Par√°metros: sessionId, session
- Retorna: Promise<void>
- Guard rails: Verifica session.simulation (prefijo SIM_)
- Almacenamiento: Archivos JSON

saveFeedback()
- L√≠nea: ~1123+
- Funci√≥n: Guardar feedback del usuario
- Par√°metros: sessionId, session, result ('useful'|'not_useful')
- Retorna: Promise<void>
- Guard rails: Bloquea si session.simulation === true
- Almacenamiento: FEEDBACK_DIR/feedback_{sessionId}_{timestamp}.json

createTicketAndRespond()
- L√≠nea: ~8638+
- Funci√≥n: Crear ticket de soporte
- Par√°metros: session, sessionId, locale
- Retorna: Promise<{ ok, reply, buttons? }>
- Guard rails: Bloquea si session.simulation === true
- Almacenamiento: TICKETS_DIR/ticket_{sessionId}_{timestamp}.json

buildUiButtonsFromTokens()
- L√≠nea: ~2900+
- Funci√≥n: Construir botones UI desde tokens
- Par√°metros: tokens (Array<string>), locale?
- Retorna: Array<{ text, value, order? }>
- Mapea tokens a texto seg√∫n locale

normalizeButtons() (index.php)
- L√≠nea: ~1707+
- Funci√≥n: Normalizar botones del backend para frontend
- Par√°metros: payload (Array | Object)
- Retorna: Array<{ label, value, text }>
- Mapea tokens a labels usando LABEL_MAP
- Preserva propiedades especiales (marker, stepIndex, size)

renderButtons() (index.php)
- L√≠nea: ~1837+
- Funci√≥n: Renderizar botones en UI
- Par√°metros: containerRow (DOM element), buttonList (Array)
- Retorna: void
- Crea elementos DOM para botones
- Muestra: btn.label o btn.text, nunca btn.value crudo

sendButton() (index.php)
- L√≠nea: ~1949+
- Funci√≥n: Enviar bot√≥n al backend
- Par√°metros: value (string), label (string)
- Retorna: Promise<void>
- Payload: { action: 'button', value, label, sessionId, csrfToken }
- Endpoint: POST /api/chat

PUNTOS CON SIDE-EFFECTS
================================================================================

OPERACIONES DE ESCRITURA EN DISCO
-------------------------------------------------------------------------------

saveSessionAndTranscript()
- Archivo: server.js l√≠nea ~2040+
- Escribe: DATA_BASE/sessions/{sessionId}.json
- Escribe: TRANSCRIPTS_DIR/transcript_{sessionId}_{timestamp}.json
- Escribe: HISTORIAL_CHAT_DIR/historial_{sessionId}.txt
- Guard rail: Prefijo SIM_ si session.simulation === true
- Lock: Usa locks para prevenir race conditions

saveFeedback()
- Archivo: server.js l√≠nea ~1123+
- Escribe: FEEDBACK_DIR/feedback_{sessionId}_{timestamp}.json
- Guard rail: Bloquea si session.simulation === true
- Log: [FEEDBACK] [SIMULATION_GUARD] bloqueado

createTicketAndRespond()
- Archivo: server.js l√≠nea ~8638+
- Escribe: TICKETS_DIR/ticket_{sessionId}_{timestamp}.json
- Guard rail: Bloquea si session.simulation === true
- Log: [SIMULATION_GUARD] bloqueado: createTicketAndRespond

saveLog() (simulation-engine.js)
- Archivo: simulation-engine.js l√≠nea ~763+
- Escribe: SIMULATIONS_DIR/sim_{simulationId}.json
- Contenido: Resultado completo de simulaci√≥n con summary

OPERACIONES EXTERNAS
-------------------------------------------------------------------------------

Llamadas a OpenAI API
- Archivo: server.js l√≠nea ~6956+
- Funci√≥n: generateSmartResponse()
- Side-effect: Consume cr√©ditos de OpenAI
- Timeout: 30s configurado
- Fallback: Respuesta gen√©rica si timeout o error

Env√≠o de WhatsApp (potencial)
- Archivo: server.js l√≠nea ~8638+
- Funci√≥n: createTicketAndRespond()
- Side-effect: Env√≠a WhatsApp real (si no es simulaci√≥n)
- Guard rail: Bloquea si session.simulation === true

Actualizaci√≥n de m√©tricas
- Archivo: server.js l√≠nea ~1904+
- Funci√≥n: pushBasicTestTelemetry()
- Side-effect: Actualiza PROBLEM_METRICS y STEP_INEFFECTIVE en memoria
- Guard rail: Bloquea si session.simulation === true
- Log: [SIMULATION_GUARD] bloqueado: pushBasicTestTelemetry

ESTADOS Y TRANSICIONES
================================================================================

ESTADOS DEFINIDOS (STATES)
-------------------------------------------------------------------------------
Archivo: server.js l√≠nea ~2341+

ASK_LANGUAGE: 'ASK_LANGUAGE'
- Primera etapa: GDPR y selecci√≥n de idioma
- Transiciones v√°lidas: ‚Üí ASK_NAME

ASK_NAME: 'ASK_NAME'
- Segunda etapa: Pedir nombre del usuario
- Transiciones v√°lidas: ‚Üí ASK_USER_LEVEL

ASK_USER_LEVEL: 'ASK_USER_LEVEL'
- Tercera etapa: Preguntar nivel de experiencia
- Transiciones v√°lidas: ‚Üí ASK_NEED

ASK_NEED: 'ASK_NEED'
- Cuarta etapa: Preguntar qu√© problema tiene
- Transiciones v√°lidas: ‚Üí ASK_DEVICE, ‚Üí ASK_NAME (error)

ASK_PROBLEM: 'ASK_PROBLEM'
- Etapa alternativa: Si no se detect√≥ problema en ASK_NEED
- Transiciones v√°lidas: ‚Üí ASK_DEVICE

ASK_DEVICE: 'ASK_DEVICE'
- Quinta etapa: Preguntar tipo de dispositivo
- Transiciones v√°lidas: ‚Üí BASIC_TESTS

ASK_OS: 'ASK_OS'
- Etapa opcional: Preguntar sistema operativo
- Transiciones v√°lidas: ‚Üí BASIC_TESTS, ‚Üí ADVANCED_TESTS

BASIC_TESTS: 'BASIC_TESTS'
- Sexta etapa: Mostrar pasos b√°sicos de soluci√≥n
- Transiciones v√°lidas: ‚Üí ADVANCED_TESTS, ‚Üí ESCALATE, ‚Üí ENDED

ADVANCED_TESTS: 'ADVANCED_TESTS'
- S√©ptima etapa: Mostrar pasos avanzados
- Transiciones v√°lidas: ‚Üí ESCALATE, ‚Üí ENDED

ESCALATE: 'ESCALATE'
- Octava etapa: Conectar con t√©cnico humano
- Transiciones v√°lidas: ‚Üí ENDED

ENDED: 'ENDED'
- Etapa final: Conversaci√≥n cerrada
- Transiciones v√°lidas: Ninguna (estado terminal)

TOKENS DE BOTONES PRINCIPALES
================================================================================

Archivo: server.js l√≠nea ~2956+ (BUTTON_TOKENS)

Idioma:
- BTN_LANG_ES_AR: 'üá¶üá∑ Espa√±ol (Argentina)'
- BTN_LANG_EN: 'üá¨üáß English'

Problemas:
- BTN_NO_ENCIENDE: 'üîå El equipo no enciende'
- BTN_NO_INTERNET: 'üì° Problemas de conexi√≥n a Internet'
- BTN_LENTITUD: 'üê¢ Lentitud del sistema operativo o del equipo'
- BTN_BLOQUEO: '‚ùÑÔ∏è Bloqueo o cuelgue de programas'
- BTN_PERIFERICOS: 'üñ®Ô∏è Problemas con perif√©ricos externos'
- BTN_VIRUS: 'üõ°Ô∏è Infecciones de malware o virus'

Dispositivos:
- BTN_DEV_PC_DESKTOP: 'PC de escritorio'
- BTN_DEV_PC_ALLINONE: 'PC All in One'
- BTN_DEV_NOTEBOOK: 'Notebook'

Nivel de usuario:
- BTN_USER_LEVEL_BASIC: 'üü¢ B√°sico ‚Äî uso lo esencial, prefiero pasos simples'
- BTN_USER_LEVEL_INTERMEDIATE: 'üü° Intermedio ‚Äî entiendo configuraciones y pruebas comunes'
- BTN_USER_LEVEL_ADVANCED: 'üîµ Avanzado ‚Äî ya hice pruebas t√©cnicas y ajustes'

Sistema operativo:
- BTN_OS_WINDOWS: 'ü™ü Windows'
- BTN_OS_MACOS: 'üçè macOS'
- BTN_OS_LINUX: 'üêß Linux'

Acciones:
- BTN_SOLVED: 'üëç Ya lo solucion√©'
- BTN_PERSIST: '‚ùå Todav√≠a no funciona'
- BTN_ADVANCED_TESTS: 'üî¨ Pruebas Avanzadas'
- BTN_CLOSE: 'üîö Cerrar Chat'
- BTN_WHATSAPP_TECNICO: 'üíö Hablar con un T√©cnico'
- BTN_CONNECT_TECH: 'üë®‚Äçüè≠ Conectar con T√©cnico'

Feedback:
- BTN_FEEDBACK_USEFUL: 'üëç La ayuda de Tecnos me fue √∫til'
- BTN_FEEDBACK_NOT_USEFUL: 'üëé La ayuda de Tecnos no me sirvi√≥'

Ayuda de pasos:
- BTN_HELP_STEP_1, BTN_HELP_STEP_2, ... BTN_HELP_STEP_N

RATE LIMITERS
================================================================================

Archivo: server.js l√≠nea ~508+

limiter (global)
- L√≠mite: 100 requests/15min por IP
- Aplicado a: Todas las rutas excepto /api/health
- Handler: L√≠nea ~508+

chatRateLimiter
- L√≠mite: 50 requests/5min por IP
- Aplicado a: POST /api/chat
- Handler: L√≠nea ~521+
- Log: [RATE_LIMIT] endpoint=/api/chat

simulationsRateLimiter
- L√≠mite: 10 requests/1hora por IP
- Aplicado a: POST /api/simulations/run
- Handler: L√≠nea ~542+
- Log: [RATE_LIMIT] endpoint=/api/simulations/run

sessionCreationLimiter
- L√≠mite: 20 requests/15min por IP
- Aplicado a: GET /api/greeting
- Handler: L√≠nea ~564+
- Log: [RATE_LIMIT] endpoint=/api/greeting

uploadLimiter
- L√≠mite: 3 requests/1min por IP+Session
- Aplicado a: POST /api/upload-image
- Handler: L√≠nea ~9654+
- Log: [RATE_LIMIT] endpoint=/api/upload-image

GUARD RAILS DE SIMULACI√ìN
================================================================================

Verificaciones de session.simulation === true:

1. saveFeedback() - L√≠nea ~1127
   - Bloquea guardado de feedback
   - Log: [FEEDBACK] [SIMULATION_GUARD] bloqueado

2. pushBasicTestTelemetry() - L√≠nea ~1904
   - Bloquea actualizaci√≥n de m√©tricas
   - Log: [SIMULATION_GUARD] bloqueado: pushBasicTestTelemetry

3. saveSessionAndTranscript() - L√≠nea ~2040
   - Usa prefijo SIM_ en sessionId
   - Log: [SIMULATION_GUARD] bloqueado: saveSession

4. createTicketAndRespond() - L√≠nea ~8638
   - Bloquea creaci√≥n de tickets reales
   - Log: [SIMULATION_GUARD] bloqueado: createTicketAndRespond

5. /api/chat - L√≠nea ~10655
   - Detecta modo simulaci√≥n desde request
   - Marca session.simulation = true

CONSTANTES Y CONFIGURACI√ìN
================================================================================

Archivo: server.js l√≠nea ~107+

DATA_BASE: Directorio base de datos
- Default: '/data'
- Variable de entorno: DATA_BASE

TRANSCRIPTS_DIR: Directorio de transcripts
- Default: DATA_BASE + '/transcripts'

TICKETS_DIR: Directorio de tickets
- Default: DATA_BASE + '/tickets'

LOGS_DIR: Directorio de logs
- Default: DATA_BASE + '/logs'

UPLOADS_DIR: Directorio de uploads
- Default: DATA_BASE + '/uploads'

HISTORIAL_CHAT_DIR: Directorio de historial
- Default: DATA_BASE + '/historial_chat'

FEEDBACK_DIR: Directorio de feedback
- Default: DATA_BASE + '/feedback'

TECNOS_DEFAULT_LOCALE: 'es-AR'
- Locale por defecto

USER_SESSION_TIMEOUT_MS: 30 * 60 * 1000 (30 minutos)
- Tiempo de inactividad para considerar sesi√≥n expirada

OPENAI_TIMEOUT: 30000 (30 segundos)
- Timeout para llamadas a OpenAI

LOG_MAX_SIZE: 100 * 1024 * 1024 (100MB)
- Tama√±o m√°ximo de archivo de log antes de rotar

LOG_RETENTION_DAYS: 7
- D√≠as de retenci√≥n de logs rotados

================================================================================
FIN DEL INVENTARIO
================================================================================

