name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: |
        # Si tienes ESLint configurado, descomenta:
        # npm run lint
        # Por ahora, solo verificamos sintaxis
        node --check server.js
        echo "‚úÖ Syntax check passed"

    - name: Run unit tests
      run: |
        # Ejecutar tests si existen
        if [ -f "tests/*.test.js" ] || [ -f "tests/*.spec.js" ]; then
          npm test || echo "‚ö†Ô∏è Tests not configured yet"
        else
          echo "‚ÑπÔ∏è No test files found, skipping"
        fi

    - name: Check for critical issues
      run: |
        echo "üîç Checking for critical issues..."
        # Verificar que logMsg est√° definido
        if grep -q "function logMsg" server.js; then
          echo "‚úÖ logMsg function found"
        else
          echo "‚ùå logMsg function not found"
          exit 1
        fi
        
        # Verificar que deleteSession est√° importado
        if grep -q "deleteSession.*from.*sessionStore" server.js; then
          echo "‚úÖ deleteSession import found"
        else
          echo "‚ùå deleteSession import not found"
          exit 1
        fi
        
        # Verificar que LOG_TOKEN est√° protegido en producci√≥n
        if grep -q "LOG_TOKEN.*REQUIRED IN PRODUCTION" server.js; then
          echo "‚úÖ LOG_TOKEN production check found"
        else
          echo "‚ùå LOG_TOKEN production check not found"
          exit 1
        fi

    - name: Build check
      run: |
        echo "üî® Checking if server starts..."
        # Solo verificar que no hay errores de sintaxis/imports
        node --check server.js && echo "‚úÖ Build check passed"
